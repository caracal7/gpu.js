(()=>{var p=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var Pn=p((Jp,Gn)=>{function Oe(i){let e=new Array(i.length);for(let t=0;t<i.length;t++){let n=i[t];n.toArray?e[t]=n.toArray():e[t]=n}return e}function Ku(){let i=Oe(arguments),e=new Float32Array(this.output.x);for(let t=0;t<this.output.x;t++)this.thread.x=t,this.thread.y=0,this.thread.z=0,e[t]=this._fn.apply(this,i);return e}function Nu(){let i=Oe(arguments),e=new Array(this.output.y);for(let t=0;t<this.output.y;t++){let n=new Float32Array(this.output.x);for(let r=0;r<this.output.x;r++)this.thread.x=r,this.thread.y=t,this.thread.z=0,n[r]=this._fn.apply(this,i);e[t]=n}return e}function Uu(){let i=Oe(arguments);for(let e=0;e<this.output.y;e++)for(let t=0;t<this.output.x;t++)this.thread.x=t,this.thread.y=e,this.thread.z=0,this._fn.apply(this,i)}function Gu(){let i=Oe(arguments),e=new Array(this.output.z);for(let t=0;t<this.output.z;t++){let n=new Array(this.output.y);for(let r=0;r<this.output.y;r++){let s=new Float32Array(this.output.x);for(let a=0;a<this.output.x;a++)this.thread.x=a,this.thread.y=r,this.thread.z=t,s[a]=this._fn.apply(this,i);n[r]=s}e[t]=n}return e}function Pu(i){i.setOutput=n=>{i.output=Un(n),i.graphical&&Nn(i)},i.toJSON=()=>{throw new Error("Not usable with gpuMock")},i.setConstants=n=>(i.constants=n,i),i.setGraphical=n=>(i.graphical=n,i),i.setCanvas=n=>(i.canvas=n,i),i.setContext=n=>(i.context=n,i),i.destroy=()=>{},i.validateSettings=()=>{},i.graphical&&i.output&&Nn(i),i.exec=function(){return new Promise((n,r)=>{try{n(i.apply(i,arguments))}catch(s){r(s)}})},i.getPixels=n=>{let{x:r,y:s}=i.output;return n?Bu(i._imageData.data,r,s):i._imageData.data.slice(0)},i.color=function(n,r,s,a){typeof a=="undefined"&&(a=1),n=Math.floor(n*255),r=Math.floor(r*255),s=Math.floor(s*255),a=Math.floor(a*255);let o=i.output.x,l=i.output.y,u=i.thread.x,h=l-i.thread.y-1,c=u+h*o;i._colorData[c*4+0]=n,i._colorData[c*4+1]=r,i._colorData[c*4+2]=s,i._colorData[c*4+3]=a};let e=()=>i,t=["setWarnVarUsage","setArgumentTypes","setTactic","setOptimizeFloatMemory","setDebug","setLoopMaxIterations","setConstantTypes","setFunctions","setNativeFunctions","setInjectedNative","setPipeline","setPrecision","setOutputToTexture","setImmutable","setStrictIntegers","setDynamicOutput","setHardcodeConstants","setDynamicArguments","setUseLegacyEncoder","setWarnVarUsage","addSubKernel"];for(let n=0;n<t.length;n++)i[t[n]]=e;return i}function Nn(i){let{x:e,y:t}=i.output;if(i.context&&i.context.createImageData){let n=new Uint8ClampedArray(e*t*4);i._imageData=i.context.createImageData(e,t),i._colorData=n}else{let n=new Uint8ClampedArray(e*t*4);i._imageData={data:n},i._colorData=n}}function Un(i){let e=null;if(i.length)if(i.length===3){let[t,n,r]=i;e={x:t,y:n,z:r}}else if(i.length===2){let[t,n]=i;e={x:t,y:n}}else{let[t]=i;e={x:t}}else e=i;return e}function qu(i,e={}){let t=e.output?Un(e.output):null;function n(){return n.output.z?Gu.apply(n,arguments):n.output.y?n.graphical?Uu.apply(n,arguments):Nu.apply(n,arguments):Ku.apply(n,arguments)}return n._fn=i,n.constants=e.constants||null,n.context=e.context||null,n.canvas=e.canvas||null,n.graphical=e.graphical||!1,n._imageData=null,n._colorData=null,n.output=t,n.thread={x:0,y:0,z:0},Pu(n)}function Bu(i,e,t){let n=t/2|0,r=e*4,s=new Uint8ClampedArray(e*4),a=i.slice(0);for(let o=0;o<n;++o){let l=o*r,u=(t-o-1)*r;s.set(a.subarray(l,l+r)),a.copyWithin(l,u,u+r),a.set(s,u)}return a}Gn.exports={gpuMock:qu}});var Tt=p((Qp,ju)=>{ju.exports={}});var xe=p((ef,qn)=>{var bt=class{constructor(e,t){this.value=e,Array.isArray(t)?this.size=t:(this.size=new Int32Array(3),t.z?this.size=new Int32Array([t.x,t.y,t.z]):t.y?this.size=new Int32Array([t.x,t.y]):this.size=new Int32Array([t.x]));let[n,r,s]=this.size;if(s){if(this.value.length!==n*r*s)throw new Error(`Input size ${this.value.length} does not match ${n} * ${r} * ${s} = ${r*n*s}`)}else if(r){if(this.value.length!==n*r)throw new Error(`Input size ${this.value.length} does not match ${n} * ${r} = ${r*n}`)}else if(this.value.length!==n)throw new Error(`Input size ${this.value.length} does not match ${n}`)}toArray(){let{utils:e}=d(),[t,n,r]=this.size;return r?e.erectMemoryOptimized3DFloat(this.value.subarray?this.value:new Float32Array(this.value),t,n,r):n?e.erectMemoryOptimized2DFloat(this.value.subarray?this.value:new Float32Array(this.value),t,n):this.value}};function Wu(i,e){return new bt(i,e)}qn.exports={Input:bt,input:Wu}});var Ve=p((tf,jn)=>{var Bn=class{constructor(e){let{texture:t,size:n,dimensions:r,output:s,context:a,type:o="NumberTexture",kernel:l,internalFormat:u,textureFormat:h}=e;if(!s)throw new Error('settings property "output" required.');if(!a)throw new Error('settings property "context" required.');if(!t)throw new Error('settings property "texture" required.');if(!l)throw new Error('settings property "kernel" required.');this.texture=t,t._refs?t._refs++:t._refs=1,this.size=n,this.dimensions=r,this.output=s,this.context=a,this.kernel=l,this.type=o,this._deleted=!1,this.internalFormat=u,this.textureFormat=h}toArray(){throw new Error(`Not implemented on ${this.constructor.name}`)}clone(){throw new Error(`Not implemented on ${this.constructor.name}`)}delete(){throw new Error(`Not implemented on ${this.constructor.name}`)}clear(){throw new Error(`Not implemented on ${this.constructor.name}`)}};jn.exports={Texture:Bn}});var d=p((nf,Qn)=>{var Wn=Tt(),{Input:Xn}=xe(),{Texture:Hn}=Ve(),Xu=/function ([^(]*)/,Hu=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg,Yu=/([^\s,]+)/g,R={systemEndianness(){return Zu},getSystemEndianness(){let i=new ArrayBuffer(4),e=new Uint32Array(i),t=new Uint8Array(i);if(e[0]=3735928559,t[0]===239)return"LE";if(t[0]===222)return"BE";throw new Error("unknown endianness")},isFunction(i){return typeof i=="function"},isFunctionString(i){return typeof i=="string"?i.slice(0,"function".length).toLowerCase()==="function":!1},getFunctionNameFromString(i){let e=Xu.exec(i);return!e||e.length===0?null:e[1].trim()},getFunctionBodyFromString(i){return i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))},getArgumentNamesFromString(i){let e=i.replace(Hu,""),t=e.slice(e.indexOf("(")+1,e.indexOf(")")).match(Yu);return t===null&&(t=[]),t},clone(i){if(i===null||typeof i!="object"||i.hasOwnProperty("isActiveClone"))return i;let e=i.constructor();for(let t in i)Object.prototype.hasOwnProperty.call(i,t)&&(i.isActiveClone=null,e[t]=R.clone(i[t]),delete i.isActiveClone);return e},isArray(i){return!isNaN(i.length)},getVariableType(i,e){if(R.isArray(i))return i.length>0&&i[0].nodeName==="IMG"?"HTMLImageArray":"Array";switch(i.constructor){case Boolean:return"Boolean";case Number:return e&&Number.isInteger(i)?"Integer":"Float";case Hn:return i.type;case Xn:return"Input"}switch(i.nodeName){case"IMG":return"HTMLImage";case"CANVAS":return"HTMLImage";case"VIDEO":return"HTMLVideo"}return i.hasOwnProperty("type")?i.type:"Unknown"},getKernelTextureSize(i,e){let[t,n,r]=e,s=(t||1)*(n||1)*(r||1);return i.optimizeFloatMemory&&i.precision==="single"&&(t=s=Math.ceil(s/4)),n>1&&t*n===s?new Int32Array([t,n]):R.closestSquareDimensions(s)},closestSquareDimensions(i){let e=Math.sqrt(i),t=Math.ceil(e),n=Math.floor(e);for(;t*n<i;)t--,n=Math.ceil(i/t);return new Int32Array([n,Math.ceil(i/n)])},getMemoryOptimizedFloatTextureSize(i,e){let n=R.roundTo((i[0]||1)*(i[1]||1)*(i[2]||1)*(i[3]||1),4)/e;return R.closestSquareDimensions(n)},getMemoryOptimizedPackedTextureSize(i,e){let[t,n,r]=i,a=R.roundTo((t||1)*(n||1)*(r||1),4)/(4/e);return R.closestSquareDimensions(a)},roundTo(i,e){return Math.floor((i+e-1)/e)*e},getDimensions(i,e){let t;if(R.isArray(i)){let n=[],r=i;for(;R.isArray(r);)n.push(r.length),r=r[0];t=n.reverse()}else if(i instanceof Hn)t=i.output;else if(i instanceof Xn)t=i.size;else throw new Error(`Unknown dimensions of ${i}`);if(e)for(t=Array.from(t);t.length<3;)t.push(1);return new Int32Array(t)},flatten2dArrayTo(i,e){let t=0;for(let n=0;n<i.length;n++)e.set(i[n],t),t+=i[n].length},flatten3dArrayTo(i,e){let t=0;for(let n=0;n<i.length;n++)for(let r=0;r<i[n].length;r++)e.set(i[n][r],t),t+=i[n][r].length},flatten4dArrayTo(i,e){let t=0;for(let n=0;n<i.length;n++)for(let r=0;r<i[n].length;r++)for(let s=0;s<i[n][r].length;s++)e.set(i[n][r][s],t),t+=i[n][r][s].length},flattenTo(i,e){R.isArray(i[0])?R.isArray(i[0][0])?R.isArray(i[0][0][0])?R.flatten4dArrayTo(i,e):R.flatten3dArrayTo(i,e):R.flatten2dArrayTo(i,e):e.set(i)},splitArray(i,e){let t=[];for(let n=0;n<i.length;n+=e)t.push(new i.constructor(i.buffer,n*4+i.byteOffset,e));return t},getAstString(i,e){let t=Array.isArray(i)?i:i.split(/\r?\n/g),n=e.loc.start,r=e.loc.end,s=[];if(n.line===r.line)s.push(t[n.line-1].substring(n.column,r.column));else{s.push(t[n.line-1].slice(n.column));for(let a=n.line;a<r.line;a++)s.push(t[a]);s.push(t[r.line-1].slice(0,r.column))}return s.join(`
`)},allPropertiesOf(i){let e=[];do e.push.apply(e,Object.getOwnPropertyNames(i));while(i=Object.getPrototypeOf(i));return e},linesToString(i){return i.length>0?i.join(`;
`)+`;
`:`
`},warnDeprecated(i,e,t){console.warn(t?`You are using a deprecated ${i} "${e}". It has been replaced with "${t}". Fixing, but please upgrade as it will soon be removed.`:`You are using a deprecated ${i} "${e}". It has been removed. Fixing, but please upgrade as it will soon be removed.`)},flipPixels:(i,e,t)=>{let n=t/2|0,r=e*4,s=new Uint8ClampedArray(e*4),a=i.slice(0);for(let o=0;o<n;++o){let l=o*r,u=(t-o-1)*r;s.set(a.subarray(l,l+r)),a.copyWithin(l,u,u+r),a.set(s,u)}return a},erectPackedFloat:(i,e)=>i.subarray(0,e),erect2DPackedFloat:(i,e,t)=>{let n=new Array(t);for(let r=0;r<t;r++){let s=r*e,a=s+e;n[r]=i.subarray(s,a)}return n},erect3DPackedFloat:(i,e,t,n)=>{let r=new Array(n);for(let s=0;s<n;s++){let a=new Array(t);for(let o=0;o<t;o++){let l=s*t*e+o*e,u=l+e;a[o]=i.subarray(l,u)}r[s]=a}return r},erectMemoryOptimizedFloat:(i,e)=>i.subarray(0,e),erectMemoryOptimized2DFloat:(i,e,t)=>{let n=new Array(t);for(let r=0;r<t;r++){let s=r*e;n[r]=i.subarray(s,s+e)}return n},erectMemoryOptimized3DFloat:(i,e,t,n)=>{let r=new Array(n);for(let s=0;s<n;s++){let a=new Array(t);for(let o=0;o<t;o++){let l=s*t*e+o*e;a[o]=i.subarray(l,l+e)}r[s]=a}return r},erectFloat:(i,e)=>{let t=new Float32Array(e),n=0;for(let r=0;r<e;r++)t[r]=i[n],n+=4;return t},erect2DFloat:(i,e,t)=>{let n=new Array(t),r=0;for(let s=0;s<t;s++){let a=new Float32Array(e);for(let o=0;o<e;o++)a[o]=i[r],r+=4;n[s]=a}return n},erect3DFloat:(i,e,t,n)=>{let r=new Array(n),s=0;for(let a=0;a<n;a++){let o=new Array(t);for(let l=0;l<t;l++){let u=new Float32Array(e);for(let h=0;h<e;h++)u[h]=i[s],s+=4;o[l]=u}r[a]=o}return r},erectArray2:(i,e)=>{let t=new Array(e),n=e*4,r=0;for(let s=0;s<n;s+=4)t[r++]=i.subarray(s,s+2);return t},erect2DArray2:(i,e,t)=>{let n=new Array(t),r=e*4;for(let s=0;s<t;s++){let a=new Array(e),o=s*r,l=0;for(let u=0;u<r;u+=4)a[l++]=i.subarray(u+o,u+o+2);n[s]=a}return n},erect3DArray2:(i,e,t,n)=>{let r=e*4,s=new Array(n);for(let a=0;a<n;a++){let o=new Array(t);for(let l=0;l<t;l++){let u=new Array(e),h=a*r*t+l*r,c=0;for(let m=0;m<r;m+=4)u[c++]=i.subarray(m+h,m+h+2);o[l]=u}s[a]=o}return s},erectArray3:(i,e)=>{let t=new Array(e),n=e*4,r=0;for(let s=0;s<n;s+=4)t[r++]=i.subarray(s,s+3);return t},erect2DArray3:(i,e,t)=>{let n=e*4,r=new Array(t);for(let s=0;s<t;s++){let a=new Array(e),o=s*n,l=0;for(let u=0;u<n;u+=4)a[l++]=i.subarray(u+o,u+o+3);r[s]=a}return r},erect3DArray3:(i,e,t,n)=>{let r=e*4,s=new Array(n);for(let a=0;a<n;a++){let o=new Array(t);for(let l=0;l<t;l++){let u=new Array(e),h=a*r*t+l*r,c=0;for(let m=0;m<r;m+=4)u[c++]=i.subarray(m+h,m+h+3);o[l]=u}s[a]=o}return s},erectArray4:(i,e)=>{let t=new Array(i),n=e*4,r=0;for(let s=0;s<n;s+=4)t[r++]=i.subarray(s,s+4);return t},erect2DArray4:(i,e,t)=>{let n=e*4,r=new Array(t);for(let s=0;s<t;s++){let a=new Array(e),o=s*n,l=0;for(let u=0;u<n;u+=4)a[l++]=i.subarray(u+o,u+o+4);r[s]=a}return r},erect3DArray4:(i,e,t,n)=>{let r=e*4,s=new Array(n);for(let a=0;a<n;a++){let o=new Array(t);for(let l=0;l<t;l++){let u=new Array(e),h=a*r*t+l*r,c=0;for(let m=0;m<r;m+=4)u[c++]=i.subarray(m+h,m+h+4);o[l]=u}s[a]=o}return s},flattenFunctionToString:(i,e)=>{let{findDependency:t,thisLookup:n,doNotDefine:r}=e,s=e.flattened;s||(s=e.flattened={});let a=Wn.parse(i),o=[],l=0;function u(c){if(Array.isArray(c)){let m=[];for(let f=0;f<c.length;f++)m.push(u(c[f]));return m.join("")}switch(c.type){case"Program":return u(c.body)+(c.body[0].type==="VariableDeclaration"?";":"");case"FunctionDeclaration":return`function ${c.id.name}(${c.params.map(u).join(", ")}) ${u(c.body)}`;case"BlockStatement":{let f=[];l+=2;for(let g=0;g<c.body.length;g++){let S=u(c.body[g]);S&&f.push(" ".repeat(l)+S,`;
`)}return l-=2,`{
${f.join("")}}`}case"VariableDeclaration":let m=R.normalizeDeclarations(c).map(u).filter(f=>f!==null);return m.length<1?"":`${c.kind} ${m.join(",")}`;case"VariableDeclarator":return c.init.object&&c.init.object.type==="ThisExpression"?n(c.init.property.name,!0)?`${c.id.name} = ${u(c.init)}`:null:`${c.id.name} = ${u(c.init)}`;case"CallExpression":{if(c.callee.property.name==="subarray")return`${u(c.callee.object)}.${u(c.callee.property)}(${c.arguments.map(f=>u(f)).join(", ")})`;if(c.callee.object.name==="gl"||c.callee.object.name==="context")return`${u(c.callee.object)}.${u(c.callee.property)}(${c.arguments.map(f=>u(f)).join(", ")})`;if(c.callee.object.type==="ThisExpression")return o.push(t("this",c.callee.property.name)),`${c.callee.property.name}(${c.arguments.map(f=>u(f)).join(", ")})`;if(c.callee.object.name){let f=t(c.callee.object.name,c.callee.property.name);return f===null?`${c.callee.object.name}.${c.callee.property.name}(${c.arguments.map(g=>u(g)).join(", ")})`:(o.push(f),`${c.callee.property.name}(${c.arguments.map(g=>u(g)).join(", ")})`)}else{if(c.callee.object.type==="MemberExpression")return`${u(c.callee.object)}.${c.callee.property.name}(${c.arguments.map(f=>u(f)).join(", ")})`;throw new Error("unknown ast.callee")}}case"ReturnStatement":return`return ${u(c.argument)}`;case"BinaryExpression":return`(${u(c.left)}${c.operator}${u(c.right)})`;case"UnaryExpression":return c.prefix?`${c.operator} ${u(c.argument)}`:`${u(c.argument)} ${c.operator}`;case"ExpressionStatement":return`${u(c.expression)}`;case"SequenceExpression":return`(${u(c.expressions)})`;case"ArrowFunctionExpression":return`(${c.params.map(u).join(", ")}) => ${u(c.body)}`;case"Literal":return c.raw;case"Identifier":return c.name;case"MemberExpression":return c.object.type==="ThisExpression"?n(c.property.name):c.computed?`${u(c.object)}[${u(c.property)}]`:u(c.object)+"."+u(c.property);case"ThisExpression":return"this";case"NewExpression":return`new ${u(c.callee)}(${c.arguments.map(f=>u(f)).join(", ")})`;case"ForStatement":return`for (${u(c.init)};${u(c.test)};${u(c.update)}) ${u(c.body)}`;case"AssignmentExpression":return`${u(c.left)}${c.operator}${u(c.right)}`;case"UpdateExpression":return`${u(c.argument)}${c.operator}`;case"IfStatement":return`if (${u(c.test)}) ${u(c.consequent)}`;case"ThrowStatement":return`throw ${u(c.argument)}`;case"ObjectPattern":return c.properties.map(u).join(", ");case"ArrayPattern":return c.elements.map(u).join(", ");case"DebuggerStatement":return"debugger;";case"ConditionalExpression":return`${u(c.test)}?${u(c.consequent)}:${u(c.alternate)}`;case"Property":if(c.kind==="init")return u(c.key)}throw new Error(`unhandled ast.type of ${c.type}`)}let h=u(a);if(o.length>0){let c=[];for(let m=0;m<o.length;m++){let f=o[m];s[f]||(s[f]=!0),f&&c.push(R.flattenFunctionToString(f,e)+`
`)}return c.join("")+h}return h},normalizeDeclarations:i=>{if(i.type!=="VariableDeclaration")throw new Error('Ast is not of type "VariableDeclaration"');let e=[];for(let t=0;t<i.declarations.length;t++){let n=i.declarations[t];if(n.id&&n.id.type==="ObjectPattern"&&n.id.properties){let{properties:r}=n.id;for(let s=0;s<r.length;s++){let a=r[s];if(a.value.type==="ObjectPattern"&&a.value.properties)for(let o=0;o<a.value.properties.length;o++){let l=a.value.properties[o];if(l.type==="Property")e.push({type:"VariableDeclarator",id:{type:"Identifier",name:l.key.name},init:{type:"MemberExpression",object:{type:"MemberExpression",object:n.init,property:{type:"Identifier",name:a.key.name},computed:!1},property:{type:"Identifier",name:l.key.name},computed:!1}});else throw new Error("unexpected state")}else if(a.value.type==="Identifier")e.push({type:"VariableDeclarator",id:{type:"Identifier",name:a.value&&a.value.name?a.value.name:a.key.name},init:{type:"MemberExpression",object:n.init,property:{type:"Identifier",name:a.key.name},computed:!1}});else throw new Error("unexpected state")}}else if(n.id&&n.id.type==="ArrayPattern"&&n.id.elements){let{elements:r}=n.id;for(let s=0;s<r.length;s++){let a=r[s];if(a.type==="Identifier")e.push({type:"VariableDeclarator",id:{type:"Identifier",name:a.name},init:{type:"MemberExpression",object:n.init,property:{type:"Literal",value:s,raw:s.toString(),start:a.start,end:a.end},computed:!0}});else throw new Error("unexpected state")}}else e.push(n)}return e},splitHTMLImageToRGB:(i,e)=>{let t=i.createKernel(function(o){return o[this.thread.y][this.thread.x].r*255},{output:[e.width,e.height],precision:"unsigned",argumentTypes:{a:"HTMLImage"}}),n=i.createKernel(function(o){return o[this.thread.y][this.thread.x].g*255},{output:[e.width,e.height],precision:"unsigned",argumentTypes:{a:"HTMLImage"}}),r=i.createKernel(function(o){return o[this.thread.y][this.thread.x].b*255},{output:[e.width,e.height],precision:"unsigned",argumentTypes:{a:"HTMLImage"}}),s=i.createKernel(function(o){return o[this.thread.y][this.thread.x].a*255},{output:[e.width,e.height],precision:"unsigned",argumentTypes:{a:"HTMLImage"}}),a=[t(e),n(e),r(e),s(e)];return a.rKernel=t,a.gKernel=n,a.bKernel=r,a.aKernel=s,a.gpu=i,a},splitRGBAToCanvases:(i,e,t,n)=>{let r=i.createKernel(function(l){let u=l[this.thread.y][this.thread.x];this.color(u.r/255,0,0,255)},{output:[t,n],graphical:!0,argumentTypes:{v:"Array2D(4)"}});r(e);let s=i.createKernel(function(l){let u=l[this.thread.y][this.thread.x];this.color(0,u.g/255,0,255)},{output:[t,n],graphical:!0,argumentTypes:{v:"Array2D(4)"}});s(e);let a=i.createKernel(function(l){let u=l[this.thread.y][this.thread.x];this.color(0,0,u.b/255,255)},{output:[t,n],graphical:!0,argumentTypes:{v:"Array2D(4)"}});a(e);let o=i.createKernel(function(l){let u=l[this.thread.y][this.thread.x];this.color(255,255,255,u.a/255)},{output:[t,n],graphical:!0,argumentTypes:{v:"Array2D(4)"}});return o(e),[r.canvas,s.canvas,a.canvas,o.canvas]},getMinifySafeName:i=>{try{let e=Wn.parse(`const value = ${i.toString()}`),{init:t}=e.body[0].declarations[0];return t.body.name||t.body.body[0].argument.name}catch(e){throw new Error("Unrecognized function type.  Please use `() => yourFunctionVariableHere` or function() { return yourFunctionVariableHere; }")}},sanitizeName:function(i){return Yn.test(i)&&(i=i.replace(Yn,"S_S")),Zn.test(i)?i=i.replace(Zn,"U_U"):Jn.test(i)&&(i=i.replace(Jn,"u_u")),i}},Yn=/\$/,Zn=/__/,Jn=/_/,Zu=R.getSystemEndianness();Qn.exports={utils:R}});var ye=p((rf,nr)=>{var{utils:O}=d(),{Input:er}=xe(),tr=class{static get isSupported(){throw new Error(`"isSupported" not implemented on ${this.name}`)}static isContextMatch(e){throw new Error(`"isContextMatch" not implemented on ${this.name}`)}static getFeatures(){throw new Error(`"getFeatures" not implemented on ${this.name}`)}static destroyContext(e){throw new Error(`"destroyContext" called on ${this.name}`)}static nativeFunctionArguments(){throw new Error(`"nativeFunctionArguments" called on ${this.name}`)}static nativeFunctionReturnType(){throw new Error(`"nativeFunctionReturnType" called on ${this.name}`)}static combineKernels(){throw new Error(`"combineKernels" called on ${this.name}`)}constructor(e,t){if(typeof e!="object"){if(typeof e!="string")throw new Error("source not a string");if(!O.isFunctionString(e))throw new Error("source not a function string")}this.useLegacyEncoder=!1,this.fallbackRequested=!1,this.onRequestFallback=null,this.argumentNames=typeof e=="string"?O.getArgumentNamesFromString(e):null,this.argumentTypes=null,this.argumentSizes=null,this.argumentBitRatios=null,this.kernelArguments=null,this.kernelConstants=null,this.forceUploadKernelConstants=null,this.source=e,this.output=null,this.debug=!1,this.graphical=!1,this.loopMaxIterations=0,this.constants=null,this.constantTypes=null,this.constantBitRatios=null,this.dynamicArguments=!1,this.dynamicOutput=!1,this.canvas=null,this.context=null,this.checkContext=null,this.gpu=null,this.functions=null,this.nativeFunctions=null,this.injectedNative=null,this.subKernels=null,this.validate=!0,this.immutable=!1,this.pipeline=!1,this.precision=null,this.tactic=null,this.plugins=null,this.returnType=null,this.leadingReturnStatement=null,this.followingReturnStatement=null,this.optimizeFloatMemory=null,this.strictIntegers=!1,this.fixIntegerDivisionAccuracy=null,this.built=!1,this.signature=null}mergeSettings(e){for(let t in e)if(!(!e.hasOwnProperty(t)||!this.hasOwnProperty(t))){switch(t){case"output":if(!Array.isArray(e.output)){this.setOutput(e.output);continue}break;case"functions":this.functions=[];for(let n=0;n<e.functions.length;n++)this.addFunction(e.functions[n]);continue;case"graphical":e[t]&&!e.hasOwnProperty("precision")&&(this.precision="unsigned"),this[t]=e[t];continue;case"nativeFunctions":if(!e.nativeFunctions)continue;this.nativeFunctions=[];for(let n=0;n<e.nativeFunctions.length;n++){let r=e.nativeFunctions[n],{name:s,source:a}=r;this.addNativeFunction(s,a,r)}continue}this[t]=e[t]}this.canvas||(this.canvas=this.initCanvas()),this.context||(this.context=this.initContext()),this.plugins||(this.plugins=this.initPlugins(e))}build(){throw new Error(`"build" not defined on ${this.constructor.name}`)}run(){throw new Error(`"run" not defined on ${this.constructor.name}`)}initCanvas(){throw new Error(`"initCanvas" not defined on ${this.constructor.name}`)}initContext(){throw new Error(`"initContext" not defined on ${this.constructor.name}`)}initPlugins(e){throw new Error(`"initPlugins" not defined on ${this.constructor.name}`)}addFunction(e,t={}){if(e.name&&e.source&&e.argumentTypes&&"returnType"in e)this.functions.push(e);else if("settings"in e&&"source"in e)this.functions.push(this.functionToIGPUFunction(e.source,e.settings));else if(typeof e=="string"||typeof e=="function")this.functions.push(this.functionToIGPUFunction(e,t));else throw new Error("function not properly defined");return this}addNativeFunction(e,t,n={}){let{argumentTypes:r,argumentNames:s}=n.argumentTypes?Ju(n.argumentTypes):this.constructor.nativeFunctionArguments(t)||{};return this.nativeFunctions.push({name:e,source:t,settings:n,argumentTypes:r,argumentNames:s,returnType:n.returnType||this.constructor.nativeFunctionReturnType(t)}),this}setupArguments(e){if(this.kernelArguments=[],this.argumentTypes)for(let t=0;t<this.argumentTypes.length;t++)this.kernelArguments.push({type:this.argumentTypes[t]});else if(!this.argumentTypes){this.argumentTypes=[];for(let t=0;t<e.length;t++){let n=O.getVariableType(e[t],this.strictIntegers),r=n==="Integer"?"Number":n;this.argumentTypes.push(r),this.kernelArguments.push({type:r})}}this.argumentSizes=new Array(e.length),this.argumentBitRatios=new Int32Array(e.length);for(let t=0;t<e.length;t++){let n=e[t];this.argumentSizes[t]=n.constructor===er?n.size:null,this.argumentBitRatios[t]=this.getBitRatio(n)}if(this.argumentNames.length!==e.length)throw new Error("arguments are miss-aligned")}setupConstants(){this.kernelConstants=[];let e=this.constantTypes===null;if(e&&(this.constantTypes={}),this.constantBitRatios={},this.constants)for(let t in this.constants){if(e){let n=O.getVariableType(this.constants[t],this.strictIntegers);this.constantTypes[t]=n,this.kernelConstants.push({name:t,type:n})}else this.kernelConstants.push({name:t,type:this.constantTypes[t]});this.constantBitRatios[t]=this.getBitRatio(this.constants[t])}}setOptimizeFloatMemory(e){return this.optimizeFloatMemory=e,this}toKernelOutput(e){return e.hasOwnProperty("x")?e.hasOwnProperty("y")?e.hasOwnProperty("z")?[e.x,e.y,e.z]:[e.x,e.y]:[e.x]:e}setOutput(e){return this.output=this.toKernelOutput(e),this}setDebug(e){return this.debug=e,this}setGraphical(e){return this.graphical=e,this.precision="unsigned",this}setLoopMaxIterations(e){return this.loopMaxIterations=e,this}setConstants(e){return this.constants=e,this}setConstantTypes(e){return this.constantTypes=e,this}setFunctions(e){for(let t=0;t<e.length;t++)this.addFunction(e[t]);return this}setNativeFunctions(e){for(let t=0;t<e.length;t++){let n=e[t],{name:r,source:s}=n;this.addNativeFunction(r,s,n)}return this}setInjectedNative(e){return this.injectedNative=e,this}setPipeline(e){return this.pipeline=e,this}setPrecision(e){return this.precision=e,this}setDimensions(e){return O.warnDeprecated("method","setDimensions","setOutput"),this.output=e,this}setOutputToTexture(e){return O.warnDeprecated("method","setOutputToTexture","setPipeline"),this.pipeline=e,this}setImmutable(e){return this.immutable=e,this}setCanvas(e){return this.canvas=e,this}setStrictIntegers(e){return this.strictIntegers=e,this}setDynamicOutput(e){return this.dynamicOutput=e,this}setHardcodeConstants(e){return O.warnDeprecated("method","setHardcodeConstants"),this.setDynamicOutput(e),this.setDynamicArguments(e),this}setDynamicArguments(e){return this.dynamicArguments=e,this}setUseLegacyEncoder(e){return this.useLegacyEncoder=e,this}setWarnVarUsage(e){return O.warnDeprecated("method","setWarnVarUsage"),this}getCanvas(){return O.warnDeprecated("method","getCanvas"),this.canvas}getWebGl(){return O.warnDeprecated("method","getWebGl"),this.context}setContext(e){return this.context=e,this}setArgumentTypes(e){if(Array.isArray(e))this.argumentTypes=e;else{this.argumentTypes=[];for(let t in e){if(!e.hasOwnProperty(t))continue;let n=this.argumentNames.indexOf(t);if(n===-1)throw new Error(`unable to find argument ${t}`);this.argumentTypes[n]=e[t]}}return this}setTactic(e){return this.tactic=e,this}requestFallback(e){if(!this.onRequestFallback)throw new Error(`"onRequestFallback" not defined on ${this.constructor.name}`);return this.fallbackRequested=!0,this.onRequestFallback(e)}validateSettings(){throw new Error(`"validateSettings" not defined on ${this.constructor.name}`)}addSubKernel(e){if(this.subKernels===null&&(this.subKernels=[]),!e.source)throw new Error('subKernel missing "source" property');if(!e.property&&isNaN(e.property))throw new Error('subKernel missing "property" property');if(!e.name)throw new Error('subKernel missing "name" property');return this.subKernels.push(e),this}destroy(e){throw new Error(`"destroy" called on ${this.constructor.name}`)}getBitRatio(e){if(this.precision==="single")return 4;if(Array.isArray(e[0]))return this.getBitRatio(e[0]);if(e.constructor===er)return this.getBitRatio(e.value);switch(e.constructor){case Uint8ClampedArray:case Uint8Array:case Int8Array:return 1;case Uint16Array:case Int16Array:return 2;case Float32Array:case Int32Array:default:return 4}}getPixels(e){throw new Error(`"getPixels" called on ${this.constructor.name}`)}checkOutput(){if(!this.output||!O.isArray(this.output))throw new Error("kernel.output not an array");if(this.output.length<1)throw new Error("kernel.output is empty, needs at least 1 value");for(let e=0;e<this.output.length;e++)if(isNaN(this.output[e])||this.output[e]<1)throw new Error(`${this.constructor.name}.output[${e}] incorrectly defined as \`${this.output[e]}\`, needs to be numeric, and greater than 0`)}prependString(e){throw new Error(`"prependString" called on ${this.constructor.name}`)}hasPrependString(e){throw new Error(`"hasPrependString" called on ${this.constructor.name}`)}toJSON(){return{settings:{output:this.output,pipeline:this.pipeline,argumentNames:this.argumentNames,argumentsTypes:this.argumentTypes,constants:this.constants,pluginNames:this.plugins?this.plugins.map(e=>e.name):null,returnType:this.returnType}}}buildSignature(e){let t=this.constructor;this.signature=t.getSignature(this,t.getArgumentTypes(this,e))}static getArgumentTypes(e,t){let n=new Array(t.length);for(let r=0;r<t.length;r++){let s=t[r],a=e.argumentTypes[r];if(s.type)n[r]=s.type;else switch(a){case"Number":case"Integer":case"Float":case"ArrayTexture(1)":n[r]=O.getVariableType(s);break;default:n[r]=a}}return n}static getSignature(e,t){throw new Error(`"getSignature" not implemented on ${this.name}`)}functionToIGPUFunction(e,t={}){if(typeof e!="string"&&typeof e!="function")throw new Error("source not a string or function");let n=typeof e=="string"?e:e.toString(),r=[];return Array.isArray(t.argumentTypes)?r=t.argumentTypes:typeof t.argumentTypes=="object"?r=O.getArgumentNamesFromString(n).map(s=>t.argumentTypes[s])||[]:r=t.argumentTypes||[],{name:O.getFunctionNameFromString(n)||null,source:n,argumentTypes:r,returnType:t.returnType||null}}onActivate(e){}};function Ju(i){let e=Object.keys(i),t=[];for(let n=0;n<e.length;n++){let r=e[n];t.push(i[r])}return{argumentTypes:t,argumentNames:e}}nr.exports={Kernel:tr}});var be=p((sf,rr)=>{var Te=class{static fromKernel(e,t,n){let{kernelArguments:r,kernelConstants:s,argumentNames:a,argumentSizes:o,argumentBitRatios:l,constants:u,constantBitRatios:h,debug:c,loopMaxIterations:m,nativeFunctions:f,output:g,optimizeFloatMemory:S,precision:$,plugins:w,source:v,subKernels:K,functions:L,leadingReturnStatement:te,followingReturnStatement:oe,dynamicArguments:fe,dynamicOutput:me}=e,ue=new Array(r.length),Z={};for(let E=0;E<r.length;E++)ue[E]=r[E].type;for(let E=0;E<s.length;E++){let D=s[E];Z[D.name]=D.type}let ie=(E,D)=>q.needsArgumentType(E,D),se=(E,D,k)=>{q.assignArgumentType(E,D,k)},x=(E,D,k)=>q.lookupReturnType(E,D,k),y=E=>q.lookupFunctionArgumentTypes(E),I=(E,D)=>q.lookupFunctionArgumentName(E,D),T=(E,D)=>q.lookupFunctionArgumentBitRatio(E,D),_=(E,D,k,le)=>{q.assignArgumentType(E,D,k,le)},A=(E,D,k,le)=>{q.assignArgumentBitRatio(E,D,k,le)},F=(E,D,k)=>{q.trackFunctionCall(E,D,k)},J=(E,D)=>{let k=[];for(let yt=0;yt<E.params.length;yt++)k.push(E.params[yt].name);let le=new t(D,Object.assign({},P,{returnType:null,ast:E,name:E.id.name,argumentNames:k,lookupReturnType:x,lookupFunctionArgumentTypes:y,lookupFunctionArgumentName:I,lookupFunctionArgumentBitRatio:T,needsArgumentType:ie,assignArgumentType:se,triggerImplyArgumentType:_,triggerImplyArgumentBitRatio:A,onFunctionCall:F}));le.traceFunctionAST(E),q.addFunctionNode(le)},P=Object.assign({isRootKernel:!1,onNestedFunction:J,lookupReturnType:x,lookupFunctionArgumentTypes:y,lookupFunctionArgumentName:I,lookupFunctionArgumentBitRatio:T,needsArgumentType:ie,assignArgumentType:se,triggerImplyArgumentType:_,triggerImplyArgumentBitRatio:A,onFunctionCall:F,optimizeFloatMemory:S,precision:$,constants:u,constantTypes:Z,constantBitRatios:h,debug:c,loopMaxIterations:m,output:g,plugins:w,dynamicArguments:fe,dynamicOutput:me},n||{}),xt=Object.assign({},P,{isRootKernel:!0,name:"kernel",argumentNames:a,argumentTypes:ue,argumentSizes:o,argumentBitRatios:l,leadingReturnStatement:te,followingReturnStatement:oe});if(typeof v=="object"&&v.functionNodes)return new Te().fromJSON(v.functionNodes,t);let ke=new t(v,xt),de=null;L&&(de=L.map(E=>new t(E.source,{returnType:E.returnType,argumentTypes:E.argumentTypes,output:g,plugins:w,constants:u,constantTypes:Z,constantBitRatios:h,optimizeFloatMemory:S,precision:$,lookupReturnType:x,lookupFunctionArgumentTypes:y,lookupFunctionArgumentName:I,lookupFunctionArgumentBitRatio:T,needsArgumentType:ie,assignArgumentType:se,triggerImplyArgumentType:_,triggerImplyArgumentBitRatio:A,onFunctionCall:F,onNestedFunction:J})));let ge=null;K&&(ge=K.map(E=>{let{name:D,source:k}=E;return new t(k,Object.assign({},P,{name:D,isSubKernel:!0,isRootKernel:!1}))}));let q=new Te({kernel:e,rootNode:ke,functionNodes:de,nativeFunctions:f,subKernelNodes:ge});return q}constructor(e){if(e=e||{},this.kernel=e.kernel,this.rootNode=e.rootNode,this.functionNodes=e.functionNodes||[],this.subKernelNodes=e.subKernelNodes||[],this.nativeFunctions=e.nativeFunctions||[],this.functionMap={},this.nativeFunctionNames=[],this.lookupChain=[],this.functionNodeDependencies={},this.functionCalls={},this.rootNode&&(this.functionMap.kernel=this.rootNode),this.functionNodes)for(let t=0;t<this.functionNodes.length;t++)this.functionMap[this.functionNodes[t].name]=this.functionNodes[t];if(this.subKernelNodes)for(let t=0;t<this.subKernelNodes.length;t++)this.functionMap[this.subKernelNodes[t].name]=this.subKernelNodes[t];if(this.nativeFunctions)for(let t=0;t<this.nativeFunctions.length;t++){let n=this.nativeFunctions[t];this.nativeFunctionNames.push(n.name)}}addFunctionNode(e){if(!e.name)throw new Error("functionNode.name needs set");this.functionMap[e.name]=e,e.isRootKernel&&(this.rootNode=e)}traceFunctionCalls(e,t){if(e=e||"kernel",t=t||[],this.nativeFunctionNames.indexOf(e)>-1){let r=t.indexOf(e);if(r===-1)t.push(e);else{let s=t.splice(r,1)[0];t.push(s)}return t}let n=this.functionMap[e];if(n){let r=t.indexOf(e);if(r===-1){t.push(e),n.toString();for(let s=0;s<n.calledFunctions.length;++s)this.traceFunctionCalls(n.calledFunctions[s],t)}else{let s=t.splice(r,1)[0];t.push(s)}}return t}getPrototypeString(e){return this.getPrototypes(e).join(`
`)}getPrototypes(e){return this.rootNode&&this.rootNode.toString(),e?this.getPrototypesFromFunctionNames(this.traceFunctionCalls(e,[]).reverse()):this.getPrototypesFromFunctionNames(Object.keys(this.functionMap))}getStringFromFunctionNames(e){let t=[];for(let n=0;n<e.length;++n)this.functionMap[e[n]]&&t.push(this.functionMap[e[n]].toString());return t.join(`
`)}getPrototypesFromFunctionNames(e){let t=[];for(let n=0;n<e.length;++n){let r=e[n],s=this.nativeFunctionNames.indexOf(r);if(s>-1){t.push(this.nativeFunctions[s].source);continue}let a=this.functionMap[r];a&&t.push(a.toString())}return t}toJSON(){return this.traceFunctionCalls(this.rootNode.name).reverse().map(e=>{let t=this.nativeFunctions.indexOf(e);if(t>-1)return{name:e,source:this.nativeFunctions[t].source};if(this.functionMap[e])return this.functionMap[e].toJSON();throw new Error(`function ${e} not found`)})}fromJSON(e,t){this.functionMap={};for(let n=0;n<e.length;n++){let r=e[n];this.functionMap[r.settings.name]=new t(r.ast,r.settings)}return this}getString(e){return e?this.getStringFromFunctionNames(this.traceFunctionCalls(e).reverse()):this.getStringFromFunctionNames(Object.keys(this.functionMap))}lookupReturnType(e,t,n){if(t.type!=="CallExpression")throw new Error(`expected ast type of "CallExpression", but is ${t.type}`);if(this._isNativeFunction(e))return this._lookupNativeFunctionReturnType(e);if(this._isFunction(e)){let r=this._getFunction(e);if(r.returnType)return r.returnType;{for(let a=0;a<this.lookupChain.length;a++)if(this.lookupChain[a].ast===t){if(r.argumentTypes.length===0&&t.arguments.length>0){let o=t.arguments;for(let l=0;l<o.length;l++)this.lookupChain.push({name:n.name,ast:o[a],requestingNode:n}),r.argumentTypes[l]=n.getType(o[l]),this.lookupChain.pop();return r.returnType=r.getType(r.getJsAST())}throw new Error("circlical logic detected!")}this.lookupChain.push({name:n.name,ast:t,requestingNode:n});let s=r.getType(r.getJsAST());return this.lookupChain.pop(),r.returnType=s}}return null}_getFunction(e){return this._isFunction(e)||new Error(`Function ${e} not found`),this.functionMap[e]}_isFunction(e){return Boolean(this.functionMap[e])}_getNativeFunction(e){for(let t=0;t<this.nativeFunctions.length;t++)if(this.nativeFunctions[t].name===e)return this.nativeFunctions[t];return null}_isNativeFunction(e){return Boolean(this._getNativeFunction(e))}_lookupNativeFunctionReturnType(e){let t=this._getNativeFunction(e);if(t)return t.returnType;throw new Error(`Native function ${e} not found`)}lookupFunctionArgumentTypes(e){return this._isNativeFunction(e)?this._getNativeFunction(e).argumentTypes:this._isFunction(e)?this._getFunction(e).argumentTypes:null}lookupFunctionArgumentName(e,t){return this._getFunction(e).argumentNames[t]}lookupFunctionArgumentBitRatio(e,t){if(!this._isFunction(e))throw new Error("function not found");if(this.rootNode.name===e){let a=this.rootNode.argumentNames.indexOf(t);if(a!==-1)return this.rootNode.argumentBitRatios[a]}let n=this._getFunction(e),r=n.argumentNames.indexOf(t);if(r===-1)throw new Error("argument not found");let s=n.argumentBitRatios[r];if(typeof s!="number")throw new Error("argument bit ratio not found");return s}needsArgumentType(e,t){return this._isFunction(e)?!this._getFunction(e).argumentTypes[t]:!1}assignArgumentType(e,t,n,r){if(!this._isFunction(e))return;let s=this._getFunction(e);s.argumentTypes[t]||(s.argumentTypes[t]=n)}assignArgumentBitRatio(e,t,n,r){let s=this._getFunction(e);if(this._isNativeFunction(n))return null;let a=this._getFunction(n),o=s.argumentNames.indexOf(t);if(o===-1)throw new Error(`Argument ${t} not found in arguments from function ${e}`);let l=s.argumentBitRatios[o];if(typeof l!="number")throw new Error(`Bit ratio for argument ${t} not found in function ${e}`);a.argumentBitRatios||(a.argumentBitRatios=new Array(a.argumentNames.length));let u=a.argumentBitRatios[o];if(typeof u=="number"){if(u!==l)throw new Error(`Incompatible bit ratio found at function ${e} at argument ${t}`);return u}return a.argumentBitRatios[o]=l,l}trackFunctionCall(e,t,n){this.functionNodeDependencies[e]||(this.functionNodeDependencies[e]=new Set,this.functionCalls[e]=[]),this.functionNodeDependencies[e].add(t),this.functionCalls[e].push(n)}getKernelResultType(){return this.rootNode.returnType||this.rootNode.getType(this.rootNode.ast)}getSubKernelResultType(e){let t=this.subKernelNodes[e],n=!1;for(let r=0;r<this.rootNode.functionCalls.length;r++)this.rootNode.functionCalls[r].ast.callee.name===t.name&&(n=!0);if(!n)throw new Error(`SubKernel ${t.name} never called by kernel`);return t.returnType||t.getType(t.getJsAST())}getReturnTypes(){let e={[this.rootNode.name]:this.rootNode.getType(this.rootNode.ast)},t=this.traceFunctionCalls(this.rootNode.name);for(let n=0;n<t.length;n++){let r=t[n],s=this.functionMap[r];e[r]=s.getType(s.ast)}return e}};rr.exports={FunctionBuilder:Te}});var Et=p((af,ar)=>{var{utils:ir}=d();function St(i){return i.length>0?i[i.length-1]:null}var ne={trackIdentifiers:"trackIdentifiers",memberExpression:"memberExpression",inForLoopInit:"inForLoopInit"},sr=class{constructor(e){this.runningContexts=[],this.functionContexts=[],this.contexts=[],this.functionCalls=[],this.declarations=[],this.identifiers=[],this.functions=[],this.returnStatements=[],this.trackedIdentifiers=null,this.states=[],this.newFunctionContext(),this.scan(e)}isState(e){return this.states[this.states.length-1]===e}hasState(e){return this.states.indexOf(e)>-1}pushState(e){this.states.push(e)}popState(e){if(this.isState(e))this.states.pop();else throw new Error(`Cannot pop the non-active state "${e}"`)}get currentFunctionContext(){return St(this.functionContexts)}get currentContext(){return St(this.runningContexts)}newFunctionContext(){let e={"@contextType":"function"};this.contexts.push(e),this.functionContexts.push(e)}newContext(e){let t=Object.assign({"@contextType":"const/let"},this.currentContext);this.contexts.push(t),this.runningContexts.push(t),e();let{currentFunctionContext:n}=this;for(let r in n)!n.hasOwnProperty(r)||t.hasOwnProperty(r)||(t[r]=n[r]);return this.runningContexts.pop(),t}useFunctionContext(e){let t=St(this.functionContexts);this.runningContexts.push(t),e(),this.runningContexts.pop()}getIdentifiers(e){let t=this.trackedIdentifiers=[];return this.pushState(ne.trackIdentifiers),e(),this.trackedIdentifiers=null,this.popState(ne.trackIdentifiers),t}getDeclaration(e){let{currentContext:t,currentFunctionContext:n,runningContexts:r}=this,s=t[e]||n[e]||null;if(!s&&t===n&&r.length>0){let a=r[r.length-2];if(a[e])return a[e]}return s}scan(e){if(!!e){if(Array.isArray(e)){for(let t=0;t<e.length;t++)this.scan(e[t]);return}switch(e.type){case"Program":this.useFunctionContext(()=>{this.scan(e.body)});break;case"BlockStatement":this.newContext(()=>{this.scan(e.body)});break;case"AssignmentExpression":case"LogicalExpression":this.scan(e.left),this.scan(e.right);break;case"BinaryExpression":this.scan(e.left),this.scan(e.right);break;case"UpdateExpression":if(e.operator==="++"){let t=this.getDeclaration(e.argument.name);t&&(t.suggestedType="Integer")}this.scan(e.argument);break;case"UnaryExpression":this.scan(e.argument);break;case"VariableDeclaration":e.kind==="var"?this.useFunctionContext(()=>{e.declarations=ir.normalizeDeclarations(e),this.scan(e.declarations)}):(e.declarations=ir.normalizeDeclarations(e),this.scan(e.declarations));break;case"VariableDeclarator":{let{currentContext:t}=this,n=this.hasState(ne.inForLoopInit),r={ast:e,context:t,name:e.id.name,origin:"declaration",inForLoopInit:n,inForLoopTest:null,assignable:t===this.currentFunctionContext||!n&&!t.hasOwnProperty(e.id.name),suggestedType:null,valueType:null,dependencies:null,isSafe:null};t[e.id.name]||(t[e.id.name]=r),this.declarations.push(r),this.scan(e.id),this.scan(e.init);break}case"FunctionExpression":case"FunctionDeclaration":this.runningContexts.length===0?this.scan(e.body):this.functions.push(e);break;case"IfStatement":this.scan(e.test),this.scan(e.consequent),e.alternate&&this.scan(e.alternate);break;case"ForStatement":{let t,n=this.newContext(()=>{this.pushState(ne.inForLoopInit),this.scan(e.init),this.popState(ne.inForLoopInit),t=this.getIdentifiers(()=>{this.scan(e.test)}),this.scan(e.update),this.newContext(()=>{this.scan(e.body)})});if(t)for(let r in n)r!=="@contextType"&&t.indexOf(r)>-1&&(n[r].inForLoopTest=!0);break}case"DoWhileStatement":case"WhileStatement":this.newContext(()=>{this.scan(e.body),this.scan(e.test)});break;case"Identifier":{this.isState(ne.trackIdentifiers)&&this.trackedIdentifiers.push(e.name),this.identifiers.push({context:this.currentContext,declaration:this.getDeclaration(e.name),ast:e});break}case"ReturnStatement":this.returnStatements.push(e),this.scan(e.argument);break;case"MemberExpression":this.pushState(ne.memberExpression),this.scan(e.object),this.scan(e.property),this.popState(ne.memberExpression);break;case"ExpressionStatement":this.scan(e.expression);break;case"SequenceExpression":this.scan(e.expressions);break;case"CallExpression":this.functionCalls.push({context:this.currentContext,ast:e}),this.scan(e.arguments);break;case"ArrayExpression":this.scan(e.elements);break;case"ConditionalExpression":this.scan(e.test),this.scan(e.alternate),this.scan(e.consequent);break;case"SwitchStatement":this.scan(e.discriminant),this.scan(e.cases);break;case"SwitchCase":this.scan(e.test),this.scan(e.consequent);break;case"ThisExpression":case"Literal":case"DebuggerStatement":case"EmptyStatement":case"BreakStatement":case"ContinueStatement":break;default:throw new Error(`unhandled type "${e.type}"`)}}}};ar.exports={FunctionTracer:sr}});var Ne=p((of,ur)=>{var Qu=Tt(),{utils:Ke}=d(),{FunctionTracer:el}=Et(),or=class{constructor(e,t){if(!e&&!t.ast)throw new Error("source parameter is missing");if(t=t||{},this.source=e,this.ast=null,this.name=typeof e=="string"?t.isRootKernel?"kernel":t.name||Ke.getFunctionNameFromString(e):null,this.calledFunctions=[],this.constants={},this.constantTypes={},this.constantBitRatios={},this.isRootKernel=!1,this.isSubKernel=!1,this.debug=null,this.functions=null,this.identifiers=null,this.contexts=null,this.functionCalls=null,this.states=[],this.needsArgumentType=null,this.assignArgumentType=null,this.lookupReturnType=null,this.lookupFunctionArgumentTypes=null,this.lookupFunctionArgumentBitRatio=null,this.triggerImplyArgumentType=null,this.triggerImplyArgumentBitRatio=null,this.onNestedFunction=null,this.onFunctionCall=null,this.optimizeFloatMemory=null,this.precision=null,this.loopMaxIterations=null,this.argumentNames=typeof this.source=="string"?Ke.getArgumentNamesFromString(this.source):null,this.argumentTypes=[],this.argumentSizes=[],this.argumentBitRatios=null,this.returnType=null,this.output=[],this.plugins=null,this.leadingReturnStatement=null,this.followingReturnStatement=null,this.dynamicOutput=null,this.dynamicArguments=null,this.strictTypingChecking=!1,this.fixIntegerDivisionAccuracy=null,t)for(let n in t)!t.hasOwnProperty(n)||!this.hasOwnProperty(n)||(this[n]=t[n]);this.literalTypes={},this.validate(),this._string=null,this._internalVariableNames={}}validate(){if(typeof this.source!="string"&&!this.ast)throw new Error("this.source not a string");if(!this.ast&&!Ke.isFunctionString(this.source))throw new Error("this.source not a function string");if(!this.name)throw new Error("this.name could not be set");if(this.argumentTypes.length>0&&this.argumentTypes.length!==this.argumentNames.length)throw new Error(`argumentTypes count of ${this.argumentTypes.length} exceeds ${this.argumentNames.length}`);if(this.output.length<1)throw new Error("this.output is not big enough")}isIdentifierConstant(e){return this.constants?this.constants.hasOwnProperty(e):!1}isInput(e){return this.argumentTypes[this.argumentNames.indexOf(e)]==="Input"}pushState(e){this.states.push(e)}popState(e){if(this.state!==e)throw new Error(`Cannot popState ${e} when in ${this.state}`);this.states.pop()}isState(e){return this.state===e}get state(){return this.states[this.states.length-1]}astMemberExpressionUnroll(e){if(e.type==="Identifier")return e.name;if(e.type==="ThisExpression")return"this";if(e.type==="MemberExpression"&&e.object&&e.property)return e.object.hasOwnProperty("name")&&e.object.name!=="Math"?this.astMemberExpressionUnroll(e.property):this.astMemberExpressionUnroll(e.object)+"."+this.astMemberExpressionUnroll(e.property);if(e.hasOwnProperty("expressions")){let t=e.expressions[0];if(t.type==="Literal"&&t.value===0&&e.expressions.length===2)return this.astMemberExpressionUnroll(e.expressions[1])}throw this.astErrorOutput("Unknown astMemberExpressionUnroll",e)}getJsAST(e){if(this.ast)return this.ast;if(typeof this.source=="object")return this.traceFunctionAST(this.source),this.ast=this.source;if(e=e||Qu,e===null)throw new Error("Missing JS to AST parser");let t=Object.freeze(e.parse(`const parser_${this.name} = ${this.source};`,{locations:!0})),n=t.body[0].declarations[0].init;if(this.traceFunctionAST(n),!t)throw new Error("Failed to parse JS code");return this.ast=n}traceFunctionAST(e){let{contexts:t,declarations:n,functions:r,identifiers:s,functionCalls:a}=new el(e);this.contexts=t,this.identifiers=s,this.functionCalls=a,this.functions=r;for(let o=0;o<n.length;o++){let l=n[o],{ast:u,inForLoopInit:h,inForLoopTest:c}=l,{init:m}=u,f=this.getDependencies(m),g=null;if(h&&c)g="Integer";else if(m){let S=this.getType(m);switch(S){case"Integer":case"Float":case"Number":m.type==="MemberExpression"?g=S:g="Number";break;case"LiteralInteger":g="Number";break;default:g=S}}l.valueType=g,l.dependencies=f,l.isSafe=this.isSafeDependencies(f)}for(let o=0;o<r.length;o++)this.onNestedFunction(r[o],this.source)}getDeclaration(e){for(let t=0;t<this.identifiers.length;t++){let n=this.identifiers[t];if(e===n.ast)return n.declaration}return null}getVariableType(e){if(e.type!=="Identifier")throw new Error(`ast of ${e.type} not "Identifier"`);let t=null,n=this.argumentNames.indexOf(e.name);if(n===-1){let r=this.getDeclaration(e);if(r)return r.valueType}else{let r=this.argumentTypes[n];r&&(t=r)}if(!t&&this.strictTypingChecking)throw new Error(`Declaration of ${name} not found`);return t}getLookupType(e){if(!_t.hasOwnProperty(e))throw new Error(`unknown typeLookupMap ${e}`);return _t[e]}getConstantType(e){if(this.constantTypes[e]){let t=this.constantTypes[e];return t==="Float"?"Number":t}throw new Error(`Type for constant "${e}" not declared`)}toString(){return this._string?this._string:this._string=this.astGeneric(this.getJsAST(),[]).join("").trim()}toJSON(){let e={source:this.source,name:this.name,constants:this.constants,constantTypes:this.constantTypes,isRootKernel:this.isRootKernel,isSubKernel:this.isSubKernel,debug:this.debug,output:this.output,loopMaxIterations:this.loopMaxIterations,argumentNames:this.argumentNames,argumentTypes:this.argumentTypes,argumentSizes:this.argumentSizes,returnType:this.returnType,leadingReturnStatement:this.leadingReturnStatement,followingReturnStatement:this.followingReturnStatement};return{ast:this.ast,settings:e}}getType(e){if(Array.isArray(e))return this.getType(e[e.length-1]);switch(e.type){case"BlockStatement":return this.getType(e.body);case"ArrayExpression":switch(this.getType(e.elements[0])){case"Array(2)":case"Array(3)":case"Array(4)":return`Matrix(${e.elements.length})`}return`Array(${e.elements.length})`;case"Literal":let n=this.astKey(e);return this.literalTypes[n]?this.literalTypes[n]:Number.isInteger(e.value)?"LiteralInteger":e.value===!0||e.value===!1?"Boolean":"Number";case"AssignmentExpression":return this.getType(e.left);case"CallExpression":if(this.isAstMathFunction(e))return"Number";if(!e.callee||!e.callee.name){if(e.callee.type==="SequenceExpression"&&e.callee.expressions[e.callee.expressions.length-1].property.name){let l=e.callee.expressions[e.callee.expressions.length-1].property.name;return this.inferArgumentTypesIfNeeded(l,e.arguments),this.lookupReturnType(l,e,this)}if(this.getVariableSignature(e.callee,!0)==="this.color")return null;if(e.callee.type==="MemberExpression"&&e.callee.object&&e.callee.property&&e.callee.property.name&&e.arguments){let l=e.callee.property.name;return this.inferArgumentTypesIfNeeded(l,e.arguments),this.lookupReturnType(l,e,this)}throw this.astErrorOutput("Unknown call expression",e)}if(e.callee&&e.callee.name){let l=e.callee.name;return this.inferArgumentTypesIfNeeded(l,e.arguments),this.lookupReturnType(l,e,this)}throw this.astErrorOutput(`Unhandled getType Type "${e.type}"`,e);case"LogicalExpression":return"Boolean";case"BinaryExpression":switch(e.operator){case"%":case"/":if(this.fixIntegerDivisionAccuracy)return"Number";break;case">":case"<":return"Boolean";case"&":case"|":case"^":case"<<":case">>":case">>>":return"Integer"}let r=this.getType(e.left);if(this.isState("skip-literal-correction"))return r;if(r==="LiteralInteger"){let l=this.getType(e.right);return l==="LiteralInteger"?e.left.value%1==0?"Integer":"Float":l}return _t[r]||r;case"UpdateExpression":return this.getType(e.argument);case"UnaryExpression":return e.operator==="~"?"Integer":this.getType(e.argument);case"VariableDeclaration":{let l=e.declarations,u;for(let h=0;h<l.length;h++){let c=l[h];u=this.getType(c)}if(!u)throw this.astErrorOutput("Unable to find type for declaration",e);return u}case"VariableDeclarator":let s=this.getDeclaration(e.id);if(!s)throw this.astErrorOutput("Unable to find declarator",e);if(!s.valueType)throw this.astErrorOutput("Unable to find declarator valueType",e);return s.valueType;case"Identifier":if(e.name==="Infinity")return"Number";if(this.isAstVariable(e)&&this.getVariableSignature(e)==="value")return this.getCheckVariableType(e);let a=this.findIdentifierOrigin(e);return a&&a.init?this.getType(a.init):null;case"ReturnStatement":return this.getType(e.argument);case"MemberExpression":if(this.isAstMathFunction(e)){switch(e.property.name){case"ceil":return"Integer";case"floor":return"Integer";case"round":return"Integer"}return"Number"}if(this.isAstVariable(e)){switch(this.getVariableSignature(e)){case"value[]":return this.getLookupType(this.getCheckVariableType(e.object));case"value[][]":return this.getLookupType(this.getCheckVariableType(e.object.object));case"value[][][]":return this.getLookupType(this.getCheckVariableType(e.object.object.object));case"value[][][][]":return this.getLookupType(this.getCheckVariableType(e.object.object.object.object));case"value.thread.value":case"this.thread.value":return"Integer";case"this.output.value":return this.dynamicOutput?"Integer":"LiteralInteger";case"this.constants.value":return this.getConstantType(e.property.name);case"this.constants.value[]":return this.getLookupType(this.getConstantType(e.object.property.name));case"this.constants.value[][]":return this.getLookupType(this.getConstantType(e.object.object.property.name));case"this.constants.value[][][]":return this.getLookupType(this.getConstantType(e.object.object.object.property.name));case"this.constants.value[][][][]":return this.getLookupType(this.getConstantType(e.object.object.object.object.property.name));case"fn()[]":case"fn()[][]":case"fn()[][][]":return this.getLookupType(this.getType(e.object));case"value.value":if(this.isAstMathVariable(e))return"Number";switch(e.property.name){case"r":case"g":case"b":case"a":return this.getLookupType(this.getCheckVariableType(e.object))}case"[][]":return"Number"}throw this.astErrorOutput("Unhandled getType MemberExpression",e)}throw this.astErrorOutput("Unhandled getType MemberExpression",e);case"ConditionalExpression":return this.getType(e.consequent);case"FunctionDeclaration":case"FunctionExpression":let o=this.findLastReturn(e.body);return o?this.getType(o):null;case"IfStatement":return this.getType(e.consequent);case"SequenceExpression":return this.getType(e.expressions[e.expressions.length-1]);default:throw this.astErrorOutput(`Unhandled getType Type "${e.type}"`,e)}}getCheckVariableType(e){let t=this.getVariableType(e);if(!t)throw this.astErrorOutput(`${e.type} is not defined`,e);return t}inferArgumentTypesIfNeeded(e,t){for(let n=0;n<t.length;n++){if(!this.needsArgumentType(e,n))continue;let r=this.getType(t[n]);if(!r)throw this.astErrorOutput(`Unable to infer argument ${n}`,t[n]);this.assignArgumentType(e,n,r)}}isAstMathVariable(e){let t=["E","PI","SQRT2","SQRT1_2","LN2","LN10","LOG2E","LOG10E"];return e.type==="MemberExpression"&&e.object&&e.object.type==="Identifier"&&e.object.name==="Math"&&e.property&&e.property.type==="Identifier"&&t.indexOf(e.property.name)>-1}isAstMathFunction(e){let t=["abs","acos","acosh","asin","asinh","atan","atan2","atanh","cbrt","ceil","clz32","cos","cosh","expm1","exp","floor","fround","imul","log","log2","log10","log1p","max","min","pow","random","round","sign","sin","sinh","sqrt","tan","tanh","trunc"];return e.type==="CallExpression"&&e.callee&&e.callee.type==="MemberExpression"&&e.callee.object&&e.callee.object.type==="Identifier"&&e.callee.object.name==="Math"&&e.callee.property&&e.callee.property.type==="Identifier"&&t.indexOf(e.callee.property.name)>-1}isAstVariable(e){return e.type==="Identifier"||e.type==="MemberExpression"}isSafe(e){return this.isSafeDependencies(this.getDependencies(e))}isSafeDependencies(e){return e&&e.every?e.every(t=>t.isSafe):!0}getDependencies(e,t,n){if(t||(t=[]),!e)return null;if(Array.isArray(e)){for(let r=0;r<e.length;r++)this.getDependencies(e[r],t,n);return t}switch(e.type){case"AssignmentExpression":return this.getDependencies(e.left,t,n),this.getDependencies(e.right,t,n),t;case"ConditionalExpression":return this.getDependencies(e.test,t,n),this.getDependencies(e.alternate,t,n),this.getDependencies(e.consequent,t,n),t;case"Literal":t.push({origin:"literal",value:e.value,isSafe:n===!0?!1:e.value>-1/0&&e.value<1/0&&!isNaN(e.value)});break;case"VariableDeclarator":return this.getDependencies(e.init,t,n);case"Identifier":let r=this.getDeclaration(e);if(r)t.push({name:e.name,origin:"declaration",isSafe:n?!1:this.isSafeDependencies(r.dependencies)});else if(this.argumentNames.indexOf(e.name)>-1)t.push({name:e.name,origin:"argument",isSafe:!1});else if(this.strictTypingChecking)throw new Error(`Cannot find identifier origin "${e.name}"`);break;case"FunctionDeclaration":return this.getDependencies(e.body.body[e.body.body.length-1],t,n);case"ReturnStatement":return this.getDependencies(e.argument,t);case"BinaryExpression":case"LogicalExpression":return n=e.operator==="/"||e.operator==="*",this.getDependencies(e.left,t,n),this.getDependencies(e.right,t,n),t;case"UnaryExpression":case"UpdateExpression":return this.getDependencies(e.argument,t,n);case"VariableDeclaration":return this.getDependencies(e.declarations,t,n);case"ArrayExpression":return t.push({origin:"declaration",isSafe:!0}),t;case"CallExpression":return t.push({origin:"function",isSafe:!0}),t;case"MemberExpression":let s=this.getMemberExpressionDetails(e);switch(s.signature){case"value[]":this.getDependencies(e.object,t,n);break;case"value[][]":this.getDependencies(e.object.object,t,n);break;case"value[][][]":this.getDependencies(e.object.object.object,t,n);break;case"this.output.value":this.dynamicOutput&&t.push({name:s.name,origin:"output",isSafe:!1});break}if(s)return s.property&&this.getDependencies(s.property,t,n),s.xProperty&&this.getDependencies(s.xProperty,t,n),s.yProperty&&this.getDependencies(s.yProperty,t,n),s.zProperty&&this.getDependencies(s.zProperty,t,n),t;case"SequenceExpression":return this.getDependencies(e.expressions,t,n);default:throw this.astErrorOutput(`Unhandled type ${e.type} in getDependencies`,e)}return t}getVariableSignature(e,t){if(!this.isAstVariable(e))throw new Error(`ast of type "${e.type}" is not a variable signature`);if(e.type==="Identifier")return"value";let n=[];for(;e;)e.computed?n.push("[]"):e.type==="ThisExpression"?n.unshift("this"):e.property&&e.property.name?e.property.name==="x"||e.property.name==="y"||e.property.name==="z"?n.unshift(t?"."+e.property.name:".value"):e.property.name==="constants"||e.property.name==="thread"||e.property.name==="output"?n.unshift("."+e.property.name):n.unshift(t?"."+e.property.name:".value"):e.name?n.unshift(t?e.name:"value"):e.callee&&e.callee.name?n.unshift(t?e.callee.name+"()":"fn()"):e.elements?n.unshift("[]"):n.unshift("unknown"),e=e.object;let r=n.join("");return t||["value","value[]","value[][]","value[][][]","value[][][][]","value.value","value.thread.value","this.thread.value","this.output.value","this.constants.value","this.constants.value[]","this.constants.value[][]","this.constants.value[][][]","this.constants.value[][][][]","fn()[]","fn()[][]","fn()[][][]","[][]"].indexOf(r)>-1?r:null}build(){return this.toString().length>0}astGeneric(e,t){if(e===null)throw this.astErrorOutput("NULL ast",e);if(Array.isArray(e)){for(let n=0;n<e.length;n++)this.astGeneric(e[n],t);return t}switch(e.type){case"FunctionDeclaration":return this.astFunctionDeclaration(e,t);case"FunctionExpression":return this.astFunctionExpression(e,t);case"ReturnStatement":return this.astReturnStatement(e,t);case"Literal":return this.astLiteral(e,t);case"BinaryExpression":return this.astBinaryExpression(e,t);case"Identifier":return this.astIdentifierExpression(e,t);case"AssignmentExpression":return this.astAssignmentExpression(e,t);case"ExpressionStatement":return this.astExpressionStatement(e,t);case"EmptyStatement":return this.astEmptyStatement(e,t);case"BlockStatement":return this.astBlockStatement(e,t);case"IfStatement":return this.astIfStatement(e,t);case"SwitchStatement":return this.astSwitchStatement(e,t);case"BreakStatement":return this.astBreakStatement(e,t);case"ContinueStatement":return this.astContinueStatement(e,t);case"ForStatement":return this.astForStatement(e,t);case"WhileStatement":return this.astWhileStatement(e,t);case"DoWhileStatement":return this.astDoWhileStatement(e,t);case"VariableDeclaration":return this.astVariableDeclaration(e,t);case"VariableDeclarator":return this.astVariableDeclarator(e,t);case"ThisExpression":return this.astThisExpression(e,t);case"SequenceExpression":return this.astSequenceExpression(e,t);case"UnaryExpression":return this.astUnaryExpression(e,t);case"UpdateExpression":return this.astUpdateExpression(e,t);case"LogicalExpression":return this.astLogicalExpression(e,t);case"MemberExpression":return this.astMemberExpression(e,t);case"CallExpression":return this.astCallExpression(e,t);case"ArrayExpression":return this.astArrayExpression(e,t);case"DebuggerStatement":return this.astDebuggerStatement(e,t);case"ConditionalExpression":return this.astConditionalExpression(e,t)}throw this.astErrorOutput("Unknown ast type : "+e.type,e)}astErrorOutput(e,t){if(typeof this.source!="string")return new Error(e);let n=Ke.getAstString(this.source,t),s=this.source.substr(t.start).split(/\n/),a=s.length>0?s[s.length-1]:0;return new Error(`${e} on line ${s.length}, position ${a.length}:
 ${n}`)}astDebuggerStatement(e,t){return t}astConditionalExpression(e,t){if(e.type!=="ConditionalExpression")throw this.astErrorOutput("Not a conditional expression",e);return t.push("("),this.astGeneric(e.test,t),t.push("?"),this.astGeneric(e.consequent,t),t.push(":"),this.astGeneric(e.alternate,t),t.push(")"),t}astFunction(e,t){throw new Error(`"astFunction" not defined on ${this.constructor.name}`)}astFunctionDeclaration(e,t){return this.isChildFunction(e)?t:this.astFunction(e,t)}astFunctionExpression(e,t){return this.isChildFunction(e)?t:this.astFunction(e,t)}isChildFunction(e){for(let t=0;t<this.functions.length;t++)if(this.functions[t]===e)return!0;return!1}astReturnStatement(e,t){return t}astLiteral(e,t){return this.literalTypes[this.astKey(e)]="Number",t}astBinaryExpression(e,t){return t}astIdentifierExpression(e,t){return t}astAssignmentExpression(e,t){return t}astExpressionStatement(e,t){return this.astGeneric(e.expression,t),t.push(";"),t}astEmptyStatement(e,t){return t}astBlockStatement(e,t){return t}astIfStatement(e,t){return t}astSwitchStatement(e,t){return t}astBreakStatement(e,t){return t.push("break;"),t}astContinueStatement(e,t){return t.push(`continue;
`),t}astForStatement(e,t){return t}astWhileStatement(e,t){return t}astDoWhileStatement(e,t){return t}astVariableDeclarator(e,t){return this.astGeneric(e.id,t),e.init!==null&&(t.push("="),this.astGeneric(e.init,t)),t}astThisExpression(e,t){return t}astSequenceExpression(e,t){let{expressions:n}=e,r=[];for(let s=0;s<n.length;s++){let a=n[s],o=[];this.astGeneric(a,o),r.push(o.join(""))}return r.length>1?t.push("(",r.join(","),")"):t.push(r[0]),t}astUnaryExpression(e,t){return this.checkAndUpconvertBitwiseUnary(e,t)||(e.prefix?(t.push(e.operator),this.astGeneric(e.argument,t)):(this.astGeneric(e.argument,t),t.push(e.operator))),t}checkAndUpconvertBitwiseUnary(e,t){}astUpdateExpression(e,t){return e.prefix?(t.push(e.operator),this.astGeneric(e.argument,t)):(this.astGeneric(e.argument,t),t.push(e.operator)),t}astLogicalExpression(e,t){return t.push("("),this.astGeneric(e.left,t),t.push(e.operator),this.astGeneric(e.right,t),t.push(")"),t}astMemberExpression(e,t){return t}astCallExpression(e,t){return t}astArrayExpression(e,t){return t}getMemberExpressionDetails(e){if(e.type!=="MemberExpression")throw this.astErrorOutput(`Expression ${e.type} not a MemberExpression`,e);let t=null,n=null,r=this.getVariableSignature(e);switch(r){case"value":return null;case"value.thread.value":case"this.thread.value":case"this.output.value":return{signature:r,type:"Integer",name:e.property.name};case"value[]":if(typeof e.object.name!="string")throw this.astErrorOutput("Unexpected expression",e);return t=e.object.name,{name:t,origin:"user",signature:r,type:this.getVariableType(e.object),xProperty:e.property};case"value[][]":if(typeof e.object.object.name!="string")throw this.astErrorOutput("Unexpected expression",e);return t=e.object.object.name,{name:t,origin:"user",signature:r,type:this.getVariableType(e.object.object),yProperty:e.object.property,xProperty:e.property};case"value[][][]":if(typeof e.object.object.object.name!="string")throw this.astErrorOutput("Unexpected expression",e);return t=e.object.object.object.name,{name:t,origin:"user",signature:r,type:this.getVariableType(e.object.object.object),zProperty:e.object.object.property,yProperty:e.object.property,xProperty:e.property};case"value[][][][]":if(typeof e.object.object.object.object.name!="string")throw this.astErrorOutput("Unexpected expression",e);return t=e.object.object.object.object.name,{name:t,origin:"user",signature:r,type:this.getVariableType(e.object.object.object.object),zProperty:e.object.object.property,yProperty:e.object.property,xProperty:e.property};case"value.value":if(typeof e.property.name!="string")throw this.astErrorOutput("Unexpected expression",e);if(this.isAstMathVariable(e))return t=e.property.name,{name:t,origin:"Math",type:"Number",signature:r};switch(e.property.name){case"r":case"g":case"b":case"a":return t=e.object.name,{name:t,property:e.property.name,origin:"user",signature:r,type:"Number"};default:throw this.astErrorOutput("Unexpected expression",e)}case"this.constants.value":if(typeof e.property.name!="string")throw this.astErrorOutput("Unexpected expression",e);if(t=e.property.name,n=this.getConstantType(t),!n)throw this.astErrorOutput("Constant has no type",e);return{name:t,type:n,origin:"constants",signature:r};case"this.constants.value[]":if(typeof e.object.property.name!="string")throw this.astErrorOutput("Unexpected expression",e);if(t=e.object.property.name,n=this.getConstantType(t),!n)throw this.astErrorOutput("Constant has no type",e);return{name:t,type:n,origin:"constants",signature:r,xProperty:e.property};case"this.constants.value[][]":{if(typeof e.object.object.property.name!="string")throw this.astErrorOutput("Unexpected expression",e);if(t=e.object.object.property.name,n=this.getConstantType(t),!n)throw this.astErrorOutput("Constant has no type",e);return{name:t,type:n,origin:"constants",signature:r,yProperty:e.object.property,xProperty:e.property}}case"this.constants.value[][][]":{if(typeof e.object.object.object.property.name!="string")throw this.astErrorOutput("Unexpected expression",e);if(t=e.object.object.object.property.name,n=this.getConstantType(t),!n)throw this.astErrorOutput("Constant has no type",e);return{name:t,type:n,origin:"constants",signature:r,zProperty:e.object.object.property,yProperty:e.object.property,xProperty:e.property}}case"fn()[]":case"fn()[][]":case"[][]":return{signature:r,property:e.property};default:throw this.astErrorOutput("Unexpected expression",e)}}findIdentifierOrigin(e){let t=[this.ast];for(;t.length>0;){let n=t[0];if(n.type==="VariableDeclarator"&&n.id&&n.id.name&&n.id.name===e.name)return n;if(t.shift(),n.argument)t.push(n.argument);else if(n.body)t.push(n.body);else if(n.declarations)t.push(n.declarations);else if(Array.isArray(n))for(let r=0;r<n.length;r++)t.push(n[r])}return null}findLastReturn(e){let t=[e||this.ast];for(;t.length>0;){let n=t.pop();if(n.type==="ReturnStatement")return n;if(n.type!=="FunctionDeclaration")if(n.argument)t.push(n.argument);else if(n.body)t.push(n.body);else if(n.declarations)t.push(n.declarations);else if(Array.isArray(n))for(let r=0;r<n.length;r++)t.push(n[r]);else n.consequent?t.push(n.consequent):n.cases&&t.push(n.cases)}return null}getInternalVariableName(e){return this._internalVariableNames.hasOwnProperty(e)||(this._internalVariableNames[e]=0),this._internalVariableNames[e]++,this._internalVariableNames[e]===1?e:e+this._internalVariableNames[e]}astKey(e,t=","){if(!e.start||!e.end)throw new Error("AST start and end needed");return`${e.start}${t}${e.end}`}},_t={Number:"Number",Float:"Float",Integer:"Integer",Array:"Number","Array(2)":"Number","Array(3)":"Number","Array(4)":"Number","Matrix(2)":"Number","Matrix(3)":"Number","Matrix(4)":"Number",Array2D:"Number",Array3D:"Number",Input:"Number",HTMLCanvas:"Array(4)",HTMLImage:"Array(4)",HTMLVideo:"Array(4)",HTMLImageArray:"Array(4)",NumberTexture:"Number",MemoryOptimizedNumberTexture:"Number","Array1D(2)":"Array(2)","Array1D(3)":"Array(3)","Array1D(4)":"Array(4)","Array2D(2)":"Array(2)","Array2D(3)":"Array(3)","Array2D(4)":"Array(4)","Array3D(2)":"Array(2)","Array3D(3)":"Array(3)","Array3D(4)":"Array(4)","ArrayTexture(1)":"Number","ArrayTexture(2)":"Array(2)","ArrayTexture(3)":"Array(3)","ArrayTexture(4)":"Array(4)"};ur.exports={FunctionNode:or}});var wt=p((uf,cr)=>{var{FunctionNode:tl}=Ne(),lr=class extends tl{astFunction(e,t){if(!this.isRootKernel){t.push("function"),t.push(" "),t.push(this.name),t.push("(");for(let n=0;n<this.argumentNames.length;++n){let r=this.argumentNames[n];n>0&&t.push(", "),t.push("user_"),t.push(r)}t.push(`) {
`)}for(let n=0;n<e.body.body.length;++n)this.astGeneric(e.body.body[n],t),t.push(`
`);return this.isRootKernel||t.push(`}
`),t}astReturnStatement(e,t){let n=this.returnType||this.getType(e.argument);return this.returnType||(this.returnType=n),this.isRootKernel?(t.push(this.leadingReturnStatement),this.astGeneric(e.argument,t),t.push(`;
`),t.push(this.followingReturnStatement),t.push(`continue;
`)):this.isSubKernel?(t.push(`subKernelResult_${this.name} = `),this.astGeneric(e.argument,t),t.push(";"),t.push(`return subKernelResult_${this.name};`)):(t.push("return "),this.astGeneric(e.argument,t),t.push(";")),t}astLiteral(e,t){if(isNaN(e.value))throw this.astErrorOutput("Non-numeric literal not supported : "+e.value,e);return t.push(e.value),t}astBinaryExpression(e,t){return t.push("("),this.astGeneric(e.left,t),t.push(e.operator),this.astGeneric(e.right,t),t.push(")"),t}astIdentifierExpression(e,t){if(e.type!=="Identifier")throw this.astErrorOutput("IdentifierExpression - not an Identifier",e);switch(e.name){case"Infinity":t.push("Infinity");break;default:this.constants&&this.constants.hasOwnProperty(e.name)?t.push("constants_"+e.name):t.push("user_"+e.name)}return t}astForStatement(e,t){if(e.type!=="ForStatement")throw this.astErrorOutput("Invalid for statement",e);let n=[],r=[],s=[],a=[],o=null;if(e.init){this.pushState("in-for-loop-init"),this.astGeneric(e.init,n);for(let l=0;l<n.length;l++)n[l].includes&&n[l].includes(",")&&(o=!1);this.popState("in-for-loop-init")}else o=!1;if(e.test?this.astGeneric(e.test,r):o=!1,e.update?this.astGeneric(e.update,s):o=!1,e.body&&(this.pushState("loop-body"),this.astGeneric(e.body,a),this.popState("loop-body")),o===null&&(o=this.isSafe(e.init)&&this.isSafe(e.test)),o)t.push(`for (${n.join("")};${r.join("")};${s.join("")}){
`),t.push(a.join("")),t.push(`}
`);else{let l=this.getInternalVariableName("safeI");n.length>0&&t.push(n.join(""),`;
`),t.push(`for (let ${l}=0;${l}<LOOP_MAX;${l}++){
`),r.length>0&&t.push(`if (!${r.join("")}) break;
`),t.push(a.join("")),t.push(`
${s.join("")};`),t.push(`}
`)}return t}astWhileStatement(e,t){if(e.type!=="WhileStatement")throw this.astErrorOutput("Invalid while statement",e);return t.push("for (let i = 0; i < LOOP_MAX; i++) {"),t.push("if ("),this.astGeneric(e.test,t),t.push(`) {
`),this.astGeneric(e.body,t),t.push(`} else {
`),t.push(`break;
`),t.push(`}
`),t.push(`}
`),t}astDoWhileStatement(e,t){if(e.type!=="DoWhileStatement")throw this.astErrorOutput("Invalid while statement",e);return t.push("for (let i = 0; i < LOOP_MAX; i++) {"),this.astGeneric(e.body,t),t.push("if (!"),this.astGeneric(e.test,t),t.push(`) {
`),t.push(`break;
`),t.push(`}
`),t.push(`}
`),t}astAssignmentExpression(e,t){let n=this.getDeclaration(e.left);if(n&&!n.assignable)throw this.astErrorOutput(`Variable ${e.left.name} is not assignable here`,e);return this.astGeneric(e.left,t),t.push(e.operator),this.astGeneric(e.right,t),t}astBlockStatement(e,t){if(this.isState("loop-body")){this.pushState("block-body");for(let n=0;n<e.body.length;n++)this.astGeneric(e.body[n],t);this.popState("block-body")}else{t.push(`{
`);for(let n=0;n<e.body.length;n++)this.astGeneric(e.body[n],t);t.push(`}
`)}return t}astVariableDeclaration(e,t){t.push(`${e.kind} `);let{declarations:n}=e;for(let r=0;r<n.length;r++){r>0&&t.push(",");let s=n[r],a=this.getDeclaration(s.id);a.valueType||(a.valueType=this.getType(s.init)),this.astGeneric(s,t)}return this.isState("in-for-loop-init")||t.push(";"),t}astIfStatement(e,t){return t.push("if ("),this.astGeneric(e.test,t),t.push(")"),e.consequent.type==="BlockStatement"?this.astGeneric(e.consequent,t):(t.push(` {
`),this.astGeneric(e.consequent,t),t.push(`
}
`)),e.alternate&&(t.push("else "),e.alternate.type==="BlockStatement"||e.alternate.type==="IfStatement"?this.astGeneric(e.alternate,t):(t.push(` {
`),this.astGeneric(e.alternate,t),t.push(`
}
`))),t}astSwitchStatement(e,t){let{discriminant:n,cases:r}=e;t.push("switch ("),this.astGeneric(n,t),t.push(`) {
`);for(let s=0;s<r.length;s++){if(r[s].test===null){t.push(`default:
`),this.astGeneric(r[s].consequent,t),r[s].consequent&&r[s].consequent.length>0&&t.push(`break;
`);continue}t.push("case "),this.astGeneric(r[s].test,t),t.push(`:
`),r[s].consequent&&r[s].consequent.length>0&&(this.astGeneric(r[s].consequent,t),t.push(`break;
`))}t.push(`
}`)}astThisExpression(e,t){return t.push("_this"),t}astMemberExpression(e,t){let{signature:n,type:r,property:s,xProperty:a,yProperty:o,zProperty:l,name:u,origin:h}=this.getMemberExpressionDetails(e);switch(n){case"this.thread.value":return t.push(`_this.thread.${u}`),t;case"this.output.value":switch(u){case"x":t.push("outputX");break;case"y":t.push("outputY");break;case"z":t.push("outputZ");break;default:throw this.astErrorOutput("Unexpected expression",e)}return t;case"value":throw this.astErrorOutput("Unexpected expression",e);case"value[]":case"value[][]":case"value[][][]":case"value.value":if(h==="Math")return t.push(Math[u]),t;switch(s){case"r":return t.push(`user_${u}[0]`),t;case"g":return t.push(`user_${u}[1]`),t;case"b":return t.push(`user_${u}[2]`),t;case"a":return t.push(`user_${u}[3]`),t}break;case"this.constants.value":case"this.constants.value[]":case"this.constants.value[][]":case"this.constants.value[][][]":break;case"fn()[]":return this.astGeneric(e.object,t),t.push("["),this.astGeneric(e.property,t),t.push("]"),t;case"fn()[][]":return this.astGeneric(e.object.object,t),t.push("["),this.astGeneric(e.object.property,t),t.push("]"),t.push("["),this.astGeneric(e.property,t),t.push("]"),t;default:throw this.astErrorOutput("Unexpected expression",e)}if(!e.computed)switch(r){case"Number":case"Integer":case"Float":case"Boolean":return t.push(`${h}_${u}`),t}let c=`${h}_${u}`;switch(r){case"Array(2)":case"Array(3)":case"Array(4)":case"Matrix(2)":case"Matrix(3)":case"Matrix(4)":case"HTMLImageArray":case"ArrayTexture(1)":case"ArrayTexture(2)":case"ArrayTexture(3)":case"ArrayTexture(4)":case"HTMLImage":default:let m,f;if(h==="constants"){let g=this.constants[u];f=this.constantTypes[u]==="Input",m=f?g.size:null}else f=this.isInput(u),m=f?this.argumentSizes[this.argumentNames.indexOf(u)]:null;t.push(`${c}`),l&&o?f?(t.push("[("),this.astGeneric(l,t),t.push(`*${this.dynamicArguments?"(outputY * outputX)":m[1]*m[0]})+(`),this.astGeneric(o,t),t.push(`*${this.dynamicArguments?"outputX":m[0]})+`),this.astGeneric(a,t),t.push("]")):(t.push("["),this.astGeneric(l,t),t.push("]"),t.push("["),this.astGeneric(o,t),t.push("]"),t.push("["),this.astGeneric(a,t),t.push("]")):o?f?(t.push("[("),this.astGeneric(o,t),t.push(`*${this.dynamicArguments?"outputX":m[0]})+`),this.astGeneric(a,t),t.push("]")):(t.push("["),this.astGeneric(o,t),t.push("]"),t.push("["),this.astGeneric(a,t),t.push("]")):typeof a!="undefined"&&(t.push("["),this.astGeneric(a,t),t.push("]"))}return t}astCallExpression(e,t){if(e.type!=="CallExpression")throw this.astErrorOutput("Unknown CallExpression",e);let n=this.astMemberExpressionUnroll(e.callee);this.calledFunctions.indexOf(n)<0&&this.calledFunctions.push(n);let r=this.isAstMathFunction(e);this.onFunctionCall&&this.onFunctionCall(this.name,n,e.arguments),t.push(n),t.push("(");let s=this.lookupFunctionArgumentTypes(n)||[];for(let a=0;a<e.arguments.length;++a){let o=e.arguments[a],l=this.getType(o);s[a]||this.triggerImplyArgumentType(n,a,l,this),a>0&&t.push(", "),this.astGeneric(o,t)}return t.push(")"),t}astArrayExpression(e,t){let n=this.getType(e),r=e.elements.length,s=[];for(let a=0;a<r;++a){let o=[];this.astGeneric(e.elements[a],o),s.push(o.join(""))}switch(n){case"Matrix(2)":case"Matrix(3)":case"Matrix(4)":t.push(`[${s.join(", ")}]`);break;default:t.push(`new Float32Array([${s.join(", ")}])`)}return t}astDebuggerStatement(e,t){return t.push("debugger;"),t}};cr.exports={CPUFunctionNode:lr}});var pr=p((lf,hr)=>{var{utils:Ue}=d();function nl(i,e){let t=[];for(let n in e){if(!e.hasOwnProperty(n))continue;let r=e[n],s=i[n];switch(r){case"Number":case"Integer":case"Float":case"Boolean":t.push(`${n}:${s}`);break;case"Array(2)":case"Array(3)":case"Array(4)":case"Matrix(2)":case"Matrix(3)":case"Matrix(4)":t.push(`${n}:new ${s.constructor.name}(${JSON.stringify(Array.from(s))})`);break}}return`{ ${t.join()} }`}function rl(i,e){let t=[],n=[],r=[],s=!/^function/.test(i.color.toString());if(t.push("  const { context, canvas, constants: incomingConstants } = settings;",`  const output = new Int32Array(${JSON.stringify(Array.from(i.output))});`,`  const _constantTypes = ${JSON.stringify(i.constantTypes)};`,`  const _constants = ${nl(i.constants,i.constantTypes)};`),n.push("    constants: _constants,","    context,","    output,","    thread: {x: 0, y: 0, z: 0},"),i.graphical){t.push(`  const _imageData = context.createImageData(${i.output[0]}, ${i.output[1]});`),t.push(`  const _colorData = new Uint8ClampedArray(${i.output[0]} * ${i.output[1]} * 4);`);let l=Ue.flattenFunctionToString((s?"function ":"")+i.color.toString(),{thisLookup:h=>{switch(h){case"_colorData":return"_colorData";case"_imageData":return"_imageData";case"output":return"output";case"thread":return"this.thread"}return JSON.stringify(i[h])},findDependency:(h,c)=>null}),u=Ue.flattenFunctionToString((s?"function ":"")+i.getPixels.toString(),{thisLookup:h=>{switch(h){case"_colorData":return"_colorData";case"_imageData":return"_imageData";case"output":return"output";case"thread":return"this.thread"}return JSON.stringify(i[h])},findDependency:()=>null});n.push("    _imageData,","    _colorData,",`    color: ${l},`),r.push(`  kernel.getPixels = ${u};`)}let a=[],o=Object.keys(i.constantTypes);for(let l=0;l<o.length;l++)a.push(i.constantTypes[o]);if(i.argumentTypes.indexOf("HTMLImageArray")!==-1||a.indexOf("HTMLImageArray")!==-1){let l=Ue.flattenFunctionToString((s?"function ":"")+i._imageTo3DArray.toString(),{doNotDefine:["canvas"],findDependency:(u,h)=>u==="this"?(s?"function ":"")+i[h].toString():null,thisLookup:u=>{switch(u){case"canvas":return;case"context":return"context"}}});r.push(l),n.push("    _mediaTo2DArray,"),n.push("    _imageTo3DArray,")}else if(i.argumentTypes.indexOf("HTMLImage")!==-1||a.indexOf("HTMLImage")!==-1){let l=Ue.flattenFunctionToString((s?"function ":"")+i._mediaTo2DArray.toString(),{findDependency:(u,h)=>null,thisLookup:u=>{switch(u){case"canvas":return"settings.canvas";case"context":return"settings.context"}throw new Error("unhandled thisLookup")}});r.push(l),n.push("    _mediaTo2DArray,")}return`function(settings) {
${t.join(`
`)}
  for (const p in _constantTypes) {
    if (!_constantTypes.hasOwnProperty(p)) continue;
    const type = _constantTypes[p];
    switch (type) {
      case 'Number':
      case 'Integer':
      case 'Float':
      case 'Boolean':
      case 'Array(2)':
      case 'Array(3)':
      case 'Array(4)':
      case 'Matrix(2)':
      case 'Matrix(3)':
      case 'Matrix(4)':
        if (incomingConstants.hasOwnProperty(p)) {
          console.warn('constant ' + p + ' of type ' + type + ' cannot be resigned');
        }
        continue;
    }
    if (!incomingConstants.hasOwnProperty(p)) {
      throw new Error('constant ' + p + ' not found');
    }
    _constants[p] = incomingConstants[p];
  }
  const kernel = (function() {
${i._kernelString}
  })
    .apply({ ${n.join(`
`)} });
  ${r.join(`
`)}
  return kernel;
}`}hr.exports={cpuKernelString:rl}});var $t=p((cf,gr)=>{var{Kernel:il}=ye(),{FunctionBuilder:fr}=be(),{CPUFunctionNode:mr}=wt(),{utils:vt}=d(),{cpuKernelString:sl}=pr(),dr=class extends il{static getFeatures(){return this.features}static get features(){return Object.freeze({kernelMap:!0,isIntegerDivisionAccurate:!0})}static get isSupported(){return!0}static isContextMatch(e){return!1}static get mode(){return"cpu"}static nativeFunctionArguments(){return null}static nativeFunctionReturnType(){throw new Error(`Looking up native function return type not supported on ${this.name}`)}static combineKernels(e){return e}static getSignature(e,t){return"cpu"+(t.length>0?":"+t.join(","):"")}constructor(e,t){super(e,t);this.mergeSettings(e.settings||t),this._imageData=null,this._colorData=null,this._kernelString=null,this._prependedString=[],this.thread={x:0,y:0,z:0},this.translatedSources=null}initCanvas(){if(typeof document!="undefined")return document.createElement("canvas");if(typeof OffscreenCanvas!="undefined")return new OffscreenCanvas(0,0)}initContext(){return this.canvas?this.canvas.getContext("2d"):null}initPlugins(e){return[]}validateSettings(e){if(!this.output||this.output.length===0){if(e.length!==1)throw new Error("Auto output only supported for kernels with only one input");let t=vt.getVariableType(e[0],this.strictIntegers);if(t==="Array")this.output=vt.getDimensions(t);else if(t==="NumberTexture"||t==="ArrayTexture(4)")this.output=e[0].output;else throw new Error("Auto output not supported for input type: "+t)}if(this.graphical&&this.output.length!==2)throw new Error("Output must have 2 dimensions on graphical mode");this.checkOutput()}translateSource(){if(this.leadingReturnStatement=this.output.length>1?"resultX[x] = ":"result[x] = ",this.subKernels){let t=[];for(let n=0;n<this.subKernels.length;n++){let{name:r}=this.subKernels[n];t.push(this.output.length>1?`resultX_${r}[x] = subKernelResult_${r};
`:`result_${r}[x] = subKernelResult_${r};
`)}this.followingReturnStatement=t.join("")}let e=fr.fromKernel(this,mr);this.translatedSources=e.getPrototypes("kernel"),!this.graphical&&!this.returnType&&(this.returnType=e.getKernelResultType())}build(){if(this.built)return;if(this.setupConstants(),this.setupArguments(arguments),this.validateSettings(arguments),this.translateSource(),this.graphical){let{canvas:t,output:n}=this;if(!t)throw new Error("no canvas available for using graphical output");let r=n[0],s=n[1]||1;t.width=r,t.height=s,this._imageData=this.context.createImageData(r,s),this._colorData=new Uint8ClampedArray(r*s*4)}let e=this.getKernelString();this.kernelString=e,this.debug&&(console.log("Function output:"),console.log(e));try{this.run=new Function([],e).bind(this)()}catch(t){console.error("An error occurred compiling the javascript: ",t)}this.buildSignature(arguments),this.built=!0}color(e,t,n,r){typeof r=="undefined"&&(r=1),e=Math.floor(e*255),t=Math.floor(t*255),n=Math.floor(n*255),r=Math.floor(r*255);let s=this.output[0],a=this.output[1],o=this.thread.x,l=a-this.thread.y-1,u=o+l*s;this._colorData[u*4+0]=e,this._colorData[u*4+1]=t,this._colorData[u*4+2]=n,this._colorData[u*4+3]=r}getKernelString(){if(this._kernelString!==null)return this._kernelString;let e=null,{translatedSources:t}=this;return t.length>1?t=t.filter(n=>/^function/.test(n)?n:(e=n,!1)):e=t.shift(),this._kernelString=`  const LOOP_MAX = ${this._getLoopMaxString()};
  ${this.injectedNative||""}
  const _this = this;
  ${this._resultKernelHeader()}
  ${this._processConstants()}
  return (${this.argumentNames.map(n=>"user_"+n).join(", ")}) => {
    ${this._prependedString.join("")}
    ${this._earlyThrows()}
    ${this._processArguments()}
    ${this.graphical?this._graphicalKernelBody(e):this._resultKernelBody(e)}
    ${t.length>0?t.join(`
`):""}
  };`}toString(){return sl(this)}_getLoopMaxString(){return this.loopMaxIterations?` ${parseInt(this.loopMaxIterations)};`:" 1000;"}_processConstants(){if(!this.constants)return"";let e=[];for(let t in this.constants)switch(this.constantTypes[t]){case"HTMLCanvas":case"HTMLImage":case"HTMLVideo":e.push(`    const constants_${t} = this._mediaTo2DArray(this.constants.${t});
`);break;case"HTMLImageArray":e.push(`    const constants_${t} = this._imageTo3DArray(this.constants.${t});
`);break;case"Input":e.push(`    const constants_${t} = this.constants.${t}.value;
`);break;default:e.push(`    const constants_${t} = this.constants.${t};
`)}return e.join("")}_earlyThrows(){if(this.graphical||this.immutable||!this.pipeline)return"";let e=[];for(let n=0;n<this.argumentTypes.length;n++)this.argumentTypes[n]==="Array"&&e.push(this.argumentNames[n]);if(e.length===0)return"";let t=[];for(let n=0;n<e.length;n++){let r=e[n],s=this._mapSubKernels(a=>`user_${r} === result_${a.name}`).join(" || ");t.push(`user_${r} === result${s?` || ${s}`:""}`)}return`if (${t.join(" || ")}) throw new Error('Source and destination arrays are the same.  Use immutable = true');`}_processArguments(){let e=[];for(let t=0;t<this.argumentTypes.length;t++){let n=`user_${this.argumentNames[t]}`;switch(this.argumentTypes[t]){case"HTMLCanvas":case"HTMLImage":case"HTMLVideo":e.push(`    ${n} = this._mediaTo2DArray(${n});
`);break;case"HTMLImageArray":e.push(`    ${n} = this._imageTo3DArray(${n});
`);break;case"Input":e.push(`    ${n} = ${n}.value;
`);break;case"ArrayTexture(1)":case"ArrayTexture(2)":case"ArrayTexture(3)":case"ArrayTexture(4)":case"NumberTexture":case"MemoryOptimizedNumberTexture":e.push(`
    if (${n}.toArray) {
      if (!_this.textureCache) {
        _this.textureCache = [];
        _this.arrayCache = [];
      }
      const textureIndex = _this.textureCache.indexOf(${n});
      if (textureIndex !== -1) {
        ${n} = _this.arrayCache[textureIndex];
      } else {
        _this.textureCache.push(${n});
        ${n} = ${n}.toArray();
        _this.arrayCache.push(${n});
      }
    }`);break}}return e.join("")}_mediaTo2DArray(e){let t=this.canvas,n=e.width>0?e.width:e.videoWidth,r=e.height>0?e.height:e.videoHeight;t.width<n&&(t.width=n),t.height<r&&(t.height=r);let s=this.context;s.drawImage(e,0,0,n,r);let a=s.getImageData(0,0,n,r).data,o=new Array(r),l=0;for(let u=r-1;u>=0;u--){let h=o[u]=new Array(n);for(let c=0;c<n;c++){let m=new Float32Array(4);m[0]=a[l++]/255,m[1]=a[l++]/255,m[2]=a[l++]/255,m[3]=a[l++]/255,h[c]=m}}return o}getPixels(e){let[t,n]=this.output;return e?vt.flipPixels(this._imageData.data,t,n):this._imageData.data.slice(0)}_imageTo3DArray(e){let t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=this._mediaTo2DArray(e[n]);return t}_resultKernelHeader(){if(this.graphical||this.immutable||!this.pipeline)return"";switch(this.output.length){case 1:return this._mutableKernel1DResults();case 2:return this._mutableKernel2DResults();case 3:return this._mutableKernel3DResults()}}_resultKernelBody(e){switch(this.output.length){case 1:return(!this.immutable&&this.pipeline?this._resultMutableKernel1DLoop(e):this._resultImmutableKernel1DLoop(e))+this._kernelOutput();case 2:return(!this.immutable&&this.pipeline?this._resultMutableKernel2DLoop(e):this._resultImmutableKernel2DLoop(e))+this._kernelOutput();case 3:return(!this.immutable&&this.pipeline?this._resultMutableKernel3DLoop(e):this._resultImmutableKernel3DLoop(e))+this._kernelOutput();default:throw new Error("unsupported size kernel")}}_graphicalKernelBody(e){switch(this.output.length){case 2:return this._graphicalKernel2DLoop(e)+this._graphicalOutput();default:throw new Error("unsupported size kernel")}}_graphicalOutput(){return`
    this._imageData.data.set(this._colorData);
    this.context.putImageData(this._imageData, 0, 0);
    return;`}_getKernelResultTypeConstructorString(){switch(this.returnType){case"LiteralInteger":case"Number":case"Integer":case"Float":return"Float32Array";case"Array(2)":case"Array(3)":case"Array(4)":return"Array";default:if(this.graphical)return"Float32Array";throw new Error(`unhandled returnType ${this.returnType}`)}}_resultImmutableKernel1DLoop(e){let t=this._getKernelResultTypeConstructorString();return`  const outputX = _this.output[0];
    const result = new ${t}(outputX);
    ${this._mapSubKernels(n=>`const result_${n.name} = new ${t}(outputX);
`).join("    ")}
    ${this._mapSubKernels(n=>`let subKernelResult_${n.name};
`).join("    ")}
    for (let x = 0; x < outputX; x++) {
      this.thread.x = x;
      this.thread.y = 0;
      this.thread.z = 0;
      ${e}
    }`}_mutableKernel1DResults(){let e=this._getKernelResultTypeConstructorString();return`  const outputX = _this.output[0];
    const result = new ${e}(outputX);
    ${this._mapSubKernels(t=>`const result_${t.name} = new ${e}(outputX);
`).join("    ")}
    ${this._mapSubKernels(t=>`let subKernelResult_${t.name};
`).join("    ")}`}_resultMutableKernel1DLoop(e){return`  const outputX = _this.output[0];
    for (let x = 0; x < outputX; x++) {
      this.thread.x = x;
      this.thread.y = 0;
      this.thread.z = 0;
      ${e}
    }`}_resultImmutableKernel2DLoop(e){let t=this._getKernelResultTypeConstructorString();return`  const outputX = _this.output[0];
    const outputY = _this.output[1];
    const result = new Array(outputY);
    ${this._mapSubKernels(n=>`const result_${n.name} = new Array(outputY);
`).join("    ")}
    ${this._mapSubKernels(n=>`let subKernelResult_${n.name};
`).join("    ")}
    for (let y = 0; y < outputY; y++) {
      this.thread.z = 0;
      this.thread.y = y;
      const resultX = result[y] = new ${t}(outputX);
      ${this._mapSubKernels(n=>`const resultX_${n.name} = result_${n.name}[y] = new ${t}(outputX);
`).join("")}
      for (let x = 0; x < outputX; x++) {
        this.thread.x = x;
        ${e}
      }
    }`}_mutableKernel2DResults(){let e=this._getKernelResultTypeConstructorString();return`  const outputX = _this.output[0];
    const outputY = _this.output[1];
    const result = new Array(outputY);
    ${this._mapSubKernels(t=>`const result_${t.name} = new Array(outputY);
`).join("    ")}
    ${this._mapSubKernels(t=>`let subKernelResult_${t.name};
`).join("    ")}
    for (let y = 0; y < outputY; y++) {
      const resultX = result[y] = new ${e}(outputX);
      ${this._mapSubKernels(t=>`const resultX_${t.name} = result_${t.name}[y] = new ${e}(outputX);
`).join("")}
    }`}_resultMutableKernel2DLoop(e){let t=this._getKernelResultTypeConstructorString();return`  const outputX = _this.output[0];
    const outputY = _this.output[1];
    for (let y = 0; y < outputY; y++) {
      this.thread.z = 0;
      this.thread.y = y;
      const resultX = result[y];
      ${this._mapSubKernels(n=>`const resultX_${n.name} = result_${n.name}[y] = new ${t}(outputX);
`).join("")}
      for (let x = 0; x < outputX; x++) {
        this.thread.x = x;
        ${e}
      }
    }`}_graphicalKernel2DLoop(e){return`  const outputX = _this.output[0];
    const outputY = _this.output[1];
    for (let y = 0; y < outputY; y++) {
      this.thread.z = 0;
      this.thread.y = y;
      for (let x = 0; x < outputX; x++) {
        this.thread.x = x;
        ${e}
      }
    }`}_resultImmutableKernel3DLoop(e){let t=this._getKernelResultTypeConstructorString();return`  const outputX = _this.output[0];
    const outputY = _this.output[1];
    const outputZ = _this.output[2];
    const result = new Array(outputZ);
    ${this._mapSubKernels(n=>`const result_${n.name} = new Array(outputZ);
`).join("    ")}
    ${this._mapSubKernels(n=>`let subKernelResult_${n.name};
`).join("    ")}
    for (let z = 0; z < outputZ; z++) {
      this.thread.z = z;
      const resultY = result[z] = new Array(outputY);
      ${this._mapSubKernels(n=>`const resultY_${n.name} = result_${n.name}[z] = new Array(outputY);
`).join("      ")}
      for (let y = 0; y < outputY; y++) {
        this.thread.y = y;
        const resultX = resultY[y] = new ${t}(outputX);
        ${this._mapSubKernels(n=>`const resultX_${n.name} = resultY_${n.name}[y] = new ${t}(outputX);
`).join("        ")}
        for (let x = 0; x < outputX; x++) {
          this.thread.x = x;
          ${e}
        }
      }
    }`}_mutableKernel3DResults(){let e=this._getKernelResultTypeConstructorString();return`  const outputX = _this.output[0];
    const outputY = _this.output[1];
    const outputZ = _this.output[2];
    const result = new Array(outputZ);
    ${this._mapSubKernels(t=>`const result_${t.name} = new Array(outputZ);
`).join("    ")}
    ${this._mapSubKernels(t=>`let subKernelResult_${t.name};
`).join("    ")}
    for (let z = 0; z < outputZ; z++) {
      const resultY = result[z] = new Array(outputY);
      ${this._mapSubKernels(t=>`const resultY_${t.name} = result_${t.name}[z] = new Array(outputY);
`).join("      ")}
      for (let y = 0; y < outputY; y++) {
        const resultX = resultY[y] = new ${e}(outputX);
        ${this._mapSubKernels(t=>`const resultX_${t.name} = resultY_${t.name}[y] = new ${e}(outputX);
`).join("        ")}
      }
    }`}_resultMutableKernel3DLoop(e){return`  const outputX = _this.output[0];
    const outputY = _this.output[1];
    const outputZ = _this.output[2];
    for (let z = 0; z < outputZ; z++) {
      this.thread.z = z;
      const resultY = result[z];
      for (let y = 0; y < outputY; y++) {
        this.thread.y = y;
        const resultX = resultY[y];
        for (let x = 0; x < outputX; x++) {
          this.thread.x = x;
          ${e}
        }
      }
    }`}_kernelOutput(){return this.subKernels?`
    return {
      result: result,
      ${this.subKernels.map(e=>`${e.property}: result_${e.name}`).join(`,
      `)}
    };`:`
    return result;`}_mapSubKernels(e){return this.subKernels===null?[""]:this.subKernels.map(e)}destroy(e){e&&delete this.canvas}static destroyContext(e){}toJSON(){let e=super.toJSON();return e.functionNodes=fr.fromKernel(this,mr).toJSON(),e}setOutput(e){super.setOutput(e);let[t,n]=this.output;this.graphical&&(this._imageData=this.context.createImageData(t,n),this._colorData=new Uint8ClampedArray(t*n*4))}prependString(e){if(this._kernelString)throw new Error("Kernel already built");this._prependedString.push(e)}hasPrependString(e){return this._prependedString.indexOf(e)>-1}};gr.exports={CPUKernel:dr}});var xr=p((hf,al)=>{al.exports={}});var Dt=p((pf,Tr)=>{var{Texture:ol}=Ve(),yr=class extends ol{get textureType(){throw new Error(`"textureType" not implemented on ${this.name}`)}clone(){return new this.constructor(this)}beforeMutate(){return this.texture._refs>1?(this.newTexture(),!0):!1}cloneTexture(){this.texture._refs--;let{context:e,size:t,texture:n,kernel:r}=this;r.debug&&console.warn("cloning internal texture"),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer()),Se(e,n),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0);let s=e.createTexture();Se(e,s),e.texImage2D(e.TEXTURE_2D,0,this.internalFormat,t[0],t[1],0,this.textureFormat,this.textureType,null),e.copyTexSubImage2D(e.TEXTURE_2D,0,0,0,0,0,t[0],t[1]),s._refs=1,this.texture=s}newTexture(){this.texture._refs--;let e=this.context,t=this.size;this.kernel.debug&&console.warn("new internal texture");let r=e.createTexture();Se(e,r),e.texImage2D(e.TEXTURE_2D,0,this.internalFormat,t[0],t[1],0,this.textureFormat,this.textureType,null),r._refs=1,this.texture=r}clear(){if(this.texture._refs){this.texture._refs--;let n=this.context,r=this.texture=n.createTexture();Se(n,r);let s=this.size;r._refs=1,n.texImage2D(n.TEXTURE_2D,0,this.internalFormat,s[0],s[1],0,this.textureFormat,this.textureType,null)}let{context:e,texture:t}=this;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer()),e.bindTexture(e.TEXTURE_2D,t),Se(e,t),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}delete(){this._deleted||(this._deleted=!0,!(this.texture._refs&&(this.texture._refs--,this.texture._refs))&&this.context.deleteTexture(this.texture))}framebuffer(){return this._framebuffer||(this._framebuffer=this.kernel.getRawValueFramebuffer(this.size[0],this.size[1])),this._framebuffer}};function Se(i,e){i.activeTexture(i.TEXTURE15),i.bindTexture(i.TEXTURE_2D,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)}Tr.exports={GLTexture:yr}});var z=p((ff,Sr)=>{var{utils:ul}=d(),{GLTexture:ll}=Dt(),br=class extends ll{get textureType(){return this.context.FLOAT}constructor(e){super(e);this.type="ArrayTexture(1)"}renderRawOutput(){let e=this.context,t=this.size;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer()),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture,0);let n=new Float32Array(t[0]*t[1]*4);return e.readPixels(0,0,t[0],t[1],e.RGBA,e.FLOAT,n),n}renderValues(){return this._deleted?null:this.renderRawOutput()}toArray(){return ul.erectFloat(this.renderValues(),this.output[0])}};Sr.exports={GLTextureFloat:br}});var wr=p((mf,_r)=>{var{utils:cl}=d(),{GLTextureFloat:hl}=z(),Er=class extends hl{constructor(e){super(e);this.type="ArrayTexture(2)"}toArray(){return cl.erectArray2(this.renderValues(),this.output[0],this.output[1])}};_r.exports={GLTextureArray2Float:Er}});var Dr=p((df,$r)=>{var{utils:pl}=d(),{GLTextureFloat:fl}=z(),vr=class extends fl{constructor(e){super(e);this.type="ArrayTexture(2)"}toArray(){return pl.erect2DArray2(this.renderValues(),this.output[0],this.output[1])}};$r.exports={GLTextureArray2Float2D:vr}});var Rr=p((gf,Ar)=>{var{utils:ml}=d(),{GLTextureFloat:dl}=z(),Ir=class extends dl{constructor(e){super(e);this.type="ArrayTexture(2)"}toArray(){return ml.erect3DArray2(this.renderValues(),this.output[0],this.output[1],this.output[2])}};Ar.exports={GLTextureArray2Float3D:Ir}});var Cr=p((xf,zr)=>{var{utils:gl}=d(),{GLTextureFloat:xl}=z(),Fr=class extends xl{constructor(e){super(e);this.type="ArrayTexture(3)"}toArray(){return gl.erectArray3(this.renderValues(),this.output[0])}};zr.exports={GLTextureArray3Float:Fr}});var kr=p((yf,Lr)=>{var{utils:yl}=d(),{GLTextureFloat:Tl}=z(),Mr=class extends Tl{constructor(e){super(e);this.type="ArrayTexture(3)"}toArray(){return yl.erect2DArray3(this.renderValues(),this.output[0],this.output[1])}};Lr.exports={GLTextureArray3Float2D:Mr}});var Kr=p((Tf,Vr)=>{var{utils:bl}=d(),{GLTextureFloat:Sl}=z(),Or=class extends Sl{constructor(e){super(e);this.type="ArrayTexture(3)"}toArray(){return bl.erect3DArray3(this.renderValues(),this.output[0],this.output[1],this.output[2])}};Vr.exports={GLTextureArray3Float3D:Or}});var Gr=p((bf,Ur)=>{var{utils:El}=d(),{GLTextureFloat:_l}=z(),Nr=class extends _l{constructor(e){super(e);this.type="ArrayTexture(4)"}toArray(){return El.erectArray4(this.renderValues(),this.output[0])}};Ur.exports={GLTextureArray4Float:Nr}});var Br=p((Sf,qr)=>{var{utils:wl}=d(),{GLTextureFloat:vl}=z(),Pr=class extends vl{constructor(e){super(e);this.type="ArrayTexture(4)"}toArray(){return wl.erect2DArray4(this.renderValues(),this.output[0],this.output[1])}};qr.exports={GLTextureArray4Float2D:Pr}});var Xr=p((Ef,Wr)=>{var{utils:$l}=d(),{GLTextureFloat:Dl}=z(),jr=class extends Dl{constructor(e){super(e);this.type="ArrayTexture(4)"}toArray(){return $l.erect3DArray4(this.renderValues(),this.output[0],this.output[1],this.output[2])}};Wr.exports={GLTextureArray4Float3D:jr}});var Zr=p((_f,Yr)=>{var{utils:Il}=d(),{GLTextureFloat:Al}=z(),Hr=class extends Al{constructor(e){super(e);this.type="ArrayTexture(1)"}toArray(){return Il.erect2DFloat(this.renderValues(),this.output[0],this.output[1])}};Yr.exports={GLTextureFloat2D:Hr}});var ei=p((wf,Qr)=>{var{utils:Rl}=d(),{GLTextureFloat:Fl}=z(),Jr=class extends Fl{constructor(e){super(e);this.type="ArrayTexture(1)"}toArray(){return Rl.erect3DFloat(this.renderValues(),this.output[0],this.output[1],this.output[2])}};Qr.exports={GLTextureFloat3D:Jr}});var ri=p((vf,ni)=>{var{utils:zl}=d(),{GLTextureFloat:Cl}=z(),ti=class extends Cl{constructor(e){super(e);this.type="MemoryOptimizedNumberTexture"}toArray(){return zl.erectMemoryOptimizedFloat(this.renderValues(),this.output[0])}};ni.exports={GLTextureMemoryOptimized:ti}});var ai=p(($f,si)=>{var{utils:Ml}=d(),{GLTextureFloat:Ll}=z(),ii=class extends Ll{constructor(e){super(e);this.type="MemoryOptimizedNumberTexture"}toArray(){return Ml.erectMemoryOptimized2DFloat(this.renderValues(),this.output[0],this.output[1])}};si.exports={GLTextureMemoryOptimized2D:ii}});var li=p((Df,ui)=>{var{utils:kl}=d(),{GLTextureFloat:Ol}=z(),oi=class extends Ol{constructor(e){super(e);this.type="MemoryOptimizedNumberTexture"}toArray(){return kl.erectMemoryOptimized3DFloat(this.renderValues(),this.output[0],this.output[1],this.output[2])}};ui.exports={GLTextureMemoryOptimized3D:oi}});var Ee=p((If,hi)=>{var{utils:Vl}=d(),{GLTexture:Kl}=Dt(),ci=class extends Kl{get textureType(){return this.context.UNSIGNED_BYTE}constructor(e){super(e);this.type="NumberTexture"}renderRawOutput(){let{context:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer()),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture,0);let t=new Uint8Array(this.size[0]*this.size[1]*4);return e.readPixels(0,0,this.size[0],this.size[1],e.RGBA,e.UNSIGNED_BYTE,t),t}renderValues(){return this._deleted?null:new Float32Array(this.renderRawOutput().buffer)}toArray(){return Vl.erectPackedFloat(this.renderValues(),this.output[0])}};hi.exports={GLTextureUnsigned:ci}});var mi=p((Af,fi)=>{var{utils:Nl}=d(),{GLTextureUnsigned:Ul}=Ee(),pi=class extends Ul{constructor(e){super(e);this.type="NumberTexture"}toArray(){return Nl.erect2DPackedFloat(this.renderValues(),this.output[0],this.output[1])}};fi.exports={GLTextureUnsigned2D:pi}});var xi=p((Rf,gi)=>{var{utils:Gl}=d(),{GLTextureUnsigned:Pl}=Ee(),di=class extends Pl{constructor(e){super(e);this.type="NumberTexture"}toArray(){return Gl.erect3DPackedFloat(this.renderValues(),this.output[0],this.output[1],this.output[2])}};gi.exports={GLTextureUnsigned3D:di}});var bi=p((Ff,Ti)=>{var{GLTextureUnsigned:ql}=Ee(),yi=class extends ql{constructor(e){super(e);this.type="ArrayTexture(4)"}toArray(){return this.renderValues()}};Ti.exports={GLTextureGraphical:yi}});var Ot=p((zf,zi)=>{var{Kernel:Bl}=ye(),{utils:b}=d(),{GLTextureArray2Float:It}=wr(),{GLTextureArray2Float2D:At}=Dr(),{GLTextureArray2Float3D:Rt}=Rr(),{GLTextureArray3Float:Ft}=Cr(),{GLTextureArray3Float2D:zt}=kr(),{GLTextureArray3Float3D:Ct}=Kr(),{GLTextureArray4Float:Mt}=Gr(),{GLTextureArray4Float2D:Lt}=Br(),{GLTextureArray4Float3D:kt}=Xr(),{GLTextureFloat:Si}=z(),{GLTextureFloat2D:Ei}=Zr(),{GLTextureFloat3D:_i}=ei(),{GLTextureMemoryOptimized:wi}=ri(),{GLTextureMemoryOptimized2D:vi}=ai(),{GLTextureMemoryOptimized3D:$i}=li(),{GLTextureUnsigned:Di}=Ee(),{GLTextureUnsigned2D:Ii}=mi(),{GLTextureUnsigned3D:Ai}=xi(),{GLTextureGraphical:jl}=bi(),Ri=class extends Bl{static get mode(){return"gpu"}static getIsFloatRead(){let e=`function kernelFunction() {
      return 1;
    }`,t=new this(e,{context:this.testContext,canvas:this.testCanvas,validate:!1,output:[1],precision:"single",returnType:"Number",tactic:"speed"});t.build(),t.run();let n=t.renderOutput();return t.destroy(!0),n[0]===1}static getIsIntegerDivisionAccurate(){function e(s,a){return s[this.thread.x]/a[this.thread.x]}let t=new this(e.toString(),{context:this.testContext,canvas:this.testCanvas,validate:!1,output:[2],returnType:"Number",precision:"unsigned",tactic:"speed"}),n=[[6,6030401],[3,3991]];t.build.apply(t,n),t.run.apply(t,n);let r=t.renderOutput();return t.destroy(!0),r[0]===2&&r[1]===1511}static getIsSpeedTacticSupported(){function e(s){return s[this.thread.x]}let t=new this(e.toString(),{context:this.testContext,canvas:this.testCanvas,validate:!1,output:[4],returnType:"Number",precision:"unsigned",tactic:"speed"}),n=[[0,1,2,3]];t.build.apply(t,n),t.run.apply(t,n);let r=t.renderOutput();return t.destroy(!0),Math.round(r[0])===0&&Math.round(r[1])===1&&Math.round(r[2])===2&&Math.round(r[3])===3}static get testCanvas(){throw new Error(`"testCanvas" not defined on ${this.name}`)}static get testContext(){throw new Error(`"testContext" not defined on ${this.name}`)}static getFeatures(){let e=this.testContext,t=this.getIsDrawBuffers();return Object.freeze({isFloatRead:this.getIsFloatRead(),isIntegerDivisionAccurate:this.getIsIntegerDivisionAccurate(),isSpeedTacticSupported:this.getIsSpeedTacticSupported(),isTextureFloat:this.getIsTextureFloat(),isDrawBuffers:t,kernelMap:t,channelCount:this.getChannelCount(),maxTextureSize:this.getMaxTextureSize(),lowIntPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.LOW_INT),lowFloatPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.LOW_FLOAT),mediumIntPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_INT),mediumFloatPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT),highIntPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_INT),highFloatPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT)})}static setupFeatureChecks(){throw new Error(`"setupFeatureChecks" not defined on ${this.name}`)}static getSignature(e,t){return e.getVariablePrecisionString()+(t.length>0?":"+t.join(","):"")}setFixIntegerDivisionAccuracy(e){return this.fixIntegerDivisionAccuracy=e,this}setPrecision(e){return this.precision=e,this}setFloatTextures(e){return b.warnDeprecated("method","setFloatTextures","setOptimizeFloatMemory"),this.floatTextures=e,this}static nativeFunctionArguments(e){let t=[],n=[],r=[],s=/^[a-zA-Z_]/,a=/[a-zA-Z_0-9]/,o=0,l=null,u=null;for(;o<e.length;){let h=e[o],c=e[o+1],m=r.length>0?r[r.length-1]:null;if(m==="FUNCTION_ARGUMENTS"&&h==="/"&&c==="*"){r.push("MULTI_LINE_COMMENT"),o+=2;continue}else if(m==="MULTI_LINE_COMMENT"&&h==="*"&&c==="/"){r.pop(),o+=2;continue}else if(m==="FUNCTION_ARGUMENTS"&&h==="/"&&c==="/"){r.push("COMMENT"),o+=2;continue}else if(m==="COMMENT"&&h===`
`){r.pop(),o++;continue}else if(m===null&&h==="("){r.push("FUNCTION_ARGUMENTS"),o++;continue}else if(m==="FUNCTION_ARGUMENTS"){if(h===")"){r.pop();break}if(h==="f"&&c==="l"&&e[o+2]==="o"&&e[o+3]==="a"&&e[o+4]==="t"&&e[o+5]===" "){r.push("DECLARE_VARIABLE"),u="float",l="",o+=6;continue}else if(h==="i"&&c==="n"&&e[o+2]==="t"&&e[o+3]===" "){r.push("DECLARE_VARIABLE"),u="int",l="",o+=4;continue}else if(h==="v"&&c==="e"&&e[o+2]==="c"&&e[o+3]==="2"&&e[o+4]===" "){r.push("DECLARE_VARIABLE"),u="vec2",l="",o+=5;continue}else if(h==="v"&&c==="e"&&e[o+2]==="c"&&e[o+3]==="3"&&e[o+4]===" "){r.push("DECLARE_VARIABLE"),u="vec3",l="",o+=5;continue}else if(h==="v"&&c==="e"&&e[o+2]==="c"&&e[o+3]==="4"&&e[o+4]===" "){r.push("DECLARE_VARIABLE"),u="vec4",l="",o+=5;continue}}else if(m==="DECLARE_VARIABLE"){if(l===""){if(h===" "){o++;continue}if(!s.test(h))throw new Error("variable name is not expected string")}l+=h,a.test(c)||(r.pop(),n.push(l),t.push(Fi[u]))}o++}if(r.length>0)throw new Error("GLSL function was not parsable");return{argumentNames:n,argumentTypes:t}}static nativeFunctionReturnType(e){return Fi[e.match(/int|float|vec[2-4]/)[0]]}static combineKernels(e,t){e.apply(null,arguments);let{texSize:n,context:r,threadDim:s}=t.texSize,a;if(t.precision==="single"){let o=n[0],l=Math.ceil(n[1]/4);a=new Float32Array(o*l*4*4),r.readPixels(0,0,o,l*4,r.RGBA,r.FLOAT,a)}else{let o=new Uint8Array(n[0]*n[1]*4);r.readPixels(0,0,n[0],n[1],r.RGBA,r.UNSIGNED_BYTE,o),a=new Float32Array(o.buffer)}if(a=a.subarray(0,s[0]*s[1]*s[2]),t.output.length===1)return a;if(t.output.length===2)return b.splitArray(a,t.output[0]);if(t.output.length===3)return b.splitArray(a,t.output[0]*t.output[1]).map(function(l){return b.splitArray(l,t.output[0])})}constructor(e,t){super(e,t);this.transferValues=null,this.formatValues=null,this.TextureConstructor=null,this.renderOutput=null,this.renderRawOutput=null,this.texSize=null,this.translatedSource=null,this.compiledFragmentShader=null,this.compiledVertexShader=null,this.switchingKernels=null,this._textureSwitched=null,this._mappedTextureSwitched=null}checkTextureSize(){let{features:e}=this.constructor;if(this.texSize[0]>e.maxTextureSize||this.texSize[1]>e.maxTextureSize)throw new Error(`Texture size [${this.texSize[0]},${this.texSize[1]}] generated by kernel is larger than supported size [${e.maxTextureSize},${e.maxTextureSize}]`)}translateSource(){throw new Error(`"translateSource" not defined on ${this.constructor.name}`)}pickRenderStrategy(e){if(this.graphical)return this.renderRawOutput=this.readPackedPixelsToUint8Array,this.transferValues=t=>t,this.TextureConstructor=jl,null;if(this.precision==="unsigned")if(this.renderRawOutput=this.readPackedPixelsToUint8Array,this.transferValues=this.readPackedPixelsToFloat32Array,this.pipeline)switch(this.renderOutput=this.renderTexture,this.subKernels!==null&&(this.renderKernels=this.renderKernelsToTextures),this.returnType){case"LiteralInteger":case"Float":case"Number":case"Integer":return this.output[2]>0?(this.TextureConstructor=Ai,null):this.output[1]>0?(this.TextureConstructor=Ii,null):(this.TextureConstructor=Di,null);case"Array(2)":case"Array(3)":case"Array(4)":return this.requestFallback(e)}else switch(this.subKernels!==null&&(this.renderKernels=this.renderKernelsToArrays),this.returnType){case"LiteralInteger":case"Float":case"Number":case"Integer":return this.renderOutput=this.renderValues,this.output[2]>0?(this.TextureConstructor=Ai,this.formatValues=b.erect3DPackedFloat,null):this.output[1]>0?(this.TextureConstructor=Ii,this.formatValues=b.erect2DPackedFloat,null):(this.TextureConstructor=Di,this.formatValues=b.erectPackedFloat,null);case"Array(2)":case"Array(3)":case"Array(4)":return this.requestFallback(e)}else if(this.precision==="single"){if(this.renderRawOutput=this.readFloatPixelsToFloat32Array,this.transferValues=this.readFloatPixelsToFloat32Array,this.pipeline)switch(this.renderOutput=this.renderTexture,this.subKernels!==null&&(this.renderKernels=this.renderKernelsToTextures),this.returnType){case"LiteralInteger":case"Float":case"Number":case"Integer":return this.optimizeFloatMemory?this.output[2]>0?(this.TextureConstructor=$i,null):this.output[1]>0?(this.TextureConstructor=vi,null):(this.TextureConstructor=wi,null):this.output[2]>0?(this.TextureConstructor=_i,null):this.output[1]>0?(this.TextureConstructor=Ei,null):(this.TextureConstructor=Si,null);case"Array(2)":return this.output[2]>0?(this.TextureConstructor=Rt,null):this.output[1]>0?(this.TextureConstructor=At,null):(this.TextureConstructor=It,null);case"Array(3)":return this.output[2]>0?(this.TextureConstructor=Ct,null):this.output[1]>0?(this.TextureConstructor=zt,null):(this.TextureConstructor=Ft,null);case"Array(4)":return this.output[2]>0?(this.TextureConstructor=kt,null):this.output[1]>0?(this.TextureConstructor=Lt,null):(this.TextureConstructor=Mt,null)}if(this.renderOutput=this.renderValues,this.subKernels!==null&&(this.renderKernels=this.renderKernelsToArrays),this.optimizeFloatMemory)switch(this.returnType){case"LiteralInteger":case"Float":case"Number":case"Integer":return this.output[2]>0?(this.TextureConstructor=$i,this.formatValues=b.erectMemoryOptimized3DFloat,null):this.output[1]>0?(this.TextureConstructor=vi,this.formatValues=b.erectMemoryOptimized2DFloat,null):(this.TextureConstructor=wi,this.formatValues=b.erectMemoryOptimizedFloat,null);case"Array(2)":return this.output[2]>0?(this.TextureConstructor=Rt,this.formatValues=b.erect3DArray2,null):this.output[1]>0?(this.TextureConstructor=At,this.formatValues=b.erect2DArray2,null):(this.TextureConstructor=It,this.formatValues=b.erectArray2,null);case"Array(3)":return this.output[2]>0?(this.TextureConstructor=Ct,this.formatValues=b.erect3DArray3,null):this.output[1]>0?(this.TextureConstructor=zt,this.formatValues=b.erect2DArray3,null):(this.TextureConstructor=Ft,this.formatValues=b.erectArray3,null);case"Array(4)":return this.output[2]>0?(this.TextureConstructor=kt,this.formatValues=b.erect3DArray4,null):this.output[1]>0?(this.TextureConstructor=Lt,this.formatValues=b.erect2DArray4,null):(this.TextureConstructor=Mt,this.formatValues=b.erectArray4,null)}else switch(this.returnType){case"LiteralInteger":case"Float":case"Number":case"Integer":return this.output[2]>0?(this.TextureConstructor=_i,this.formatValues=b.erect3DFloat,null):this.output[1]>0?(this.TextureConstructor=Ei,this.formatValues=b.erect2DFloat,null):(this.TextureConstructor=Si,this.formatValues=b.erectFloat,null);case"Array(2)":return this.output[2]>0?(this.TextureConstructor=Rt,this.formatValues=b.erect3DArray2,null):this.output[1]>0?(this.TextureConstructor=At,this.formatValues=b.erect2DArray2,null):(this.TextureConstructor=It,this.formatValues=b.erectArray2,null);case"Array(3)":return this.output[2]>0?(this.TextureConstructor=Ct,this.formatValues=b.erect3DArray3,null):this.output[1]>0?(this.TextureConstructor=zt,this.formatValues=b.erect2DArray3,null):(this.TextureConstructor=Ft,this.formatValues=b.erectArray3,null);case"Array(4)":return this.output[2]>0?(this.TextureConstructor=kt,this.formatValues=b.erect3DArray4,null):this.output[1]>0?(this.TextureConstructor=Lt,this.formatValues=b.erect2DArray4,null):(this.TextureConstructor=Mt,this.formatValues=b.erectArray4,null)}}else throw new Error(`unhandled precision of "${this.precision}"`);throw new Error(`unhandled return type "${this.returnType}"`)}getKernelString(){throw new Error("abstract method call")}getMainResultTexture(){switch(this.returnType){case"LiteralInteger":case"Float":case"Integer":case"Number":return this.getMainResultNumberTexture();case"Array(2)":return this.getMainResultArray2Texture();case"Array(3)":return this.getMainResultArray3Texture();case"Array(4)":return this.getMainResultArray4Texture();default:throw new Error(`unhandled returnType type ${this.returnType}`)}}getMainResultKernelNumberTexture(){throw new Error("abstract method call")}getMainResultSubKernelNumberTexture(){throw new Error("abstract method call")}getMainResultKernelArray2Texture(){throw new Error("abstract method call")}getMainResultSubKernelArray2Texture(){throw new Error("abstract method call")}getMainResultKernelArray3Texture(){throw new Error("abstract method call")}getMainResultSubKernelArray3Texture(){throw new Error("abstract method call")}getMainResultKernelArray4Texture(){throw new Error("abstract method call")}getMainResultSubKernelArray4Texture(){throw new Error("abstract method call")}getMainResultGraphical(){throw new Error("abstract method call")}getMainResultMemoryOptimizedFloats(){throw new Error("abstract method call")}getMainResultPackedPixels(){throw new Error("abstract method call")}getMainResultString(){return this.graphical?this.getMainResultGraphical():this.precision==="single"?this.optimizeFloatMemory?this.getMainResultMemoryOptimizedFloats():this.getMainResultTexture():this.getMainResultPackedPixels()}getMainResultNumberTexture(){return b.linesToString(this.getMainResultKernelNumberTexture())+b.linesToString(this.getMainResultSubKernelNumberTexture())}getMainResultArray2Texture(){return b.linesToString(this.getMainResultKernelArray2Texture())+b.linesToString(this.getMainResultSubKernelArray2Texture())}getMainResultArray3Texture(){return b.linesToString(this.getMainResultKernelArray3Texture())+b.linesToString(this.getMainResultSubKernelArray3Texture())}getMainResultArray4Texture(){return b.linesToString(this.getMainResultKernelArray4Texture())+b.linesToString(this.getMainResultSubKernelArray4Texture())}getFloatTacticDeclaration(){return`precision ${this.getVariablePrecisionString(this.texSize,this.tactic)} float;
`}getIntTacticDeclaration(){return`precision ${this.getVariablePrecisionString(this.texSize,this.tactic,!0)} int;
`}getSampler2DTacticDeclaration(){return`precision ${this.getVariablePrecisionString(this.texSize,this.tactic)} sampler2D;
`}getSampler2DArrayTacticDeclaration(){return`precision ${this.getVariablePrecisionString(this.texSize,this.tactic)} sampler2DArray;
`}renderTexture(){return this.immutable?this.texture.clone():this.texture}readPackedPixelsToUint8Array(){if(this.precision!=="unsigned")throw new Error('Requires this.precision to be "unsigned"');let{texSize:e,context:t}=this,n=new Uint8Array(e[0]*e[1]*4);return t.readPixels(0,0,e[0],e[1],t.RGBA,t.UNSIGNED_BYTE,n),n}readPackedPixelsToFloat32Array(){return new Float32Array(this.readPackedPixelsToUint8Array().buffer)}readFloatPixelsToFloat32Array(){if(this.precision!=="single")throw new Error('Requires this.precision to be "single"');let{texSize:e,context:t}=this,n=e[0],r=e[1],s=new Float32Array(n*r*4);return t.readPixels(0,0,n,r,t.RGBA,t.FLOAT,s),s}getPixels(e){let{context:t,output:n}=this,[r,s]=n,a=new Uint8Array(r*s*4);return t.readPixels(0,0,r,s,t.RGBA,t.UNSIGNED_BYTE,a),new Uint8ClampedArray((e?a:b.flipPixels(a,r,s)).buffer)}renderKernelsToArrays(){let e={result:this.renderOutput()};for(let t=0;t<this.subKernels.length;t++)e[this.subKernels[t].property]=this.mappedTextures[t].toArray();return e}renderKernelsToTextures(){let e={result:this.renderOutput()};if(this.immutable)for(let t=0;t<this.subKernels.length;t++)e[this.subKernels[t].property]=this.mappedTextures[t].clone();else for(let t=0;t<this.subKernels.length;t++)e[this.subKernels[t].property]=this.mappedTextures[t];return e}resetSwitchingKernels(){let e=this.switchingKernels;return this.switchingKernels=null,e}setOutput(e){let t=this.toKernelOutput(e);if(this.program){if(!this.dynamicOutput)throw new Error("Resizing a kernel with dynamicOutput: false is not possible");let n=[t[0],t[1]||1,t[2]||1],r=b.getKernelTextureSize({optimizeFloatMemory:this.optimizeFloatMemory,precision:this.precision},n),s=this.texSize;if(s){let o=this.getVariablePrecisionString(s,this.tactic),l=this.getVariablePrecisionString(r,this.tactic);if(o!==l){this.debug&&console.warn("Precision requirement changed, asking GPU instance to recompile"),this.switchKernels({type:"outputPrecisionMismatch",precision:l,needed:e});return}}this.output=t,this.threadDim=n,this.texSize=r;let{context:a}=this;if(a.bindFramebuffer(a.FRAMEBUFFER,this.framebuffer),this.updateMaxTexSize(),this.framebuffer.width=this.texSize[0],this.framebuffer.height=this.texSize[1],a.viewport(0,0,this.maxTexSize[0],this.maxTexSize[1]),this.canvas.width=this.maxTexSize[0],this.canvas.height=this.maxTexSize[1],this.texture&&this.texture.delete(),this.texture=null,this._setupOutputTexture(),this.mappedTextures&&this.mappedTextures.length>0){for(let o=0;o<this.mappedTextures.length;o++)this.mappedTextures[o].delete();this.mappedTextures=null,this._setupSubOutputTextures()}}else this.output=t;return this}renderValues(){return this.formatValues(this.transferValues(),this.output[0],this.output[1],this.output[2])}switchKernels(e){this.switchingKernels?this.switchingKernels.push(e):this.switchingKernels=[e]}getVariablePrecisionString(e=this.texSize,t=this.tactic,n=!1){if(!t){if(!this.constructor.features.isSpeedTacticSupported)return"highp";let r=this.constructor.features[n?"lowIntPrecision":"lowFloatPrecision"],s=this.constructor.features[n?"mediumIntPrecision":"mediumFloatPrecision"],a=this.constructor.features[n?"highIntPrecision":"highFloatPrecision"],o=Math.log2(e[0]*e[1]);if(o<=r.rangeMax)return"lowp";if(o<=s.rangeMax)return"mediump";if(o<=a.rangeMax)return"highp";throw new Error("The required size exceeds that of the ability of your system")}switch(t){case"speed":return"lowp";case"balanced":return"mediump";case"precision":return"highp";default:throw new Error(`Unknown tactic "${t}" use "speed", "balanced", "precision", or empty for auto`)}}updateTextureArgumentRefs(e,t){if(!!this.immutable){if(this.texture.texture===t.texture){let{prevArg:n}=e;n&&(n.texture._refs===1&&(this.texture.delete(),this.texture=n.clone(),this._textureSwitched=!0),n.delete()),e.prevArg=t.clone()}else if(this.mappedTextures&&this.mappedTextures.length>0){let{mappedTextures:n}=this;for(let r=0;r<n.length;r++){let s=n[r];if(s.texture===t.texture){let{prevArg:a}=e;a&&(a.texture._refs===1&&(s.delete(),n[r]=a.clone(),this._mappedTextureSwitched[r]=!0),a.delete()),e.prevArg=t.clone();return}}}}}onActivate(e){if(this._textureSwitched=!0,this.texture=e.texture,this.mappedTextures){for(let t=0;t<this.mappedTextures.length;t++)this._mappedTextureSwitched[t]=!0;this.mappedTextures=e.mappedTextures}}initCanvas(){}},Fi={int:"Integer",float:"Number",vec2:"Array(2)",vec3:"Array(3)",vec4:"Array(4)"};zi.exports={GLKernel:Ri}});var Ge=p((Cf,Mi)=>{var{utils:j}=d(),{FunctionNode:Wl}=Ne(),Ci=class extends Wl{constructor(e,t){super(e,t);t&&t.hasOwnProperty("fixIntegerDivisionAccuracy")&&(this.fixIntegerDivisionAccuracy=t.fixIntegerDivisionAccuracy)}astConditionalExpression(e,t){if(e.type!=="ConditionalExpression")throw this.astErrorOutput("Not a conditional expression",e);let n=this.getType(e.consequent),r=this.getType(e.alternate);return n===null&&r===null?(t.push("if ("),this.astGeneric(e.test,t),t.push(") {"),this.astGeneric(e.consequent,t),t.push(";"),t.push("} else {"),this.astGeneric(e.alternate,t),t.push(";"),t.push("}"),t):(t.push("("),this.astGeneric(e.test,t),t.push("?"),this.astGeneric(e.consequent,t),t.push(":"),this.astGeneric(e.alternate,t),t.push(")"),t)}astFunction(e,t){if(this.isRootKernel)t.push("void");else{this.returnType||this.findLastReturn()&&(this.returnType=this.getType(e.body),this.returnType==="LiteralInteger"&&(this.returnType="Number"));let{returnType:n}=this;if(!n)t.push("void");else{let r=Vt[n];if(!r)throw new Error(`unknown type ${n}`);t.push(r)}}if(t.push(" "),t.push(this.name),t.push("("),!this.isRootKernel)for(let n=0;n<this.argumentNames.length;++n){let r=this.argumentNames[n];n>0&&t.push(", ");let s=this.argumentTypes[this.argumentNames.indexOf(r)];if(!s)throw this.astErrorOutput(`Unknown argument ${r} type`,e);s==="LiteralInteger"&&(this.argumentTypes[n]=s="Number");let a=Vt[s];if(!a)throw this.astErrorOutput("Unexpected expression",e);let o=j.sanitizeName(r);a==="sampler2D"||a==="sampler2DArray"?t.push(`${a} user_${o},ivec2 user_${o}Size,ivec3 user_${o}Dim`):t.push(`${a} user_${o}`)}t.push(`) {
`);for(let n=0;n<e.body.body.length;++n)this.astGeneric(e.body.body[n],t),t.push(`
`);return t.push(`}
`),t}astReturnStatement(e,t){if(!e.argument)throw this.astErrorOutput("Unexpected return statement",e);this.pushState("skip-literal-correction");let n=this.getType(e.argument);this.popState("skip-literal-correction");let r=[];switch(this.returnType||(n==="LiteralInteger"||n==="Integer"?this.returnType="Number":this.returnType=n),this.returnType){case"LiteralInteger":case"Number":case"Float":switch(n){case"Integer":r.push("float("),this.astGeneric(e.argument,r),r.push(")");break;case"LiteralInteger":this.castLiteralToFloat(e.argument,r),this.getType(e)==="Integer"&&(r.unshift("float("),r.push(")"));break;default:this.astGeneric(e.argument,r)}break;case"Integer":switch(n){case"Float":case"Number":this.castValueToInteger(e.argument,r);break;case"LiteralInteger":this.castLiteralToInteger(e.argument,r);break;default:this.astGeneric(e.argument,r)}break;case"Array(4)":case"Array(3)":case"Array(2)":case"Matrix(2)":case"Matrix(3)":case"Matrix(4)":case"Input":this.astGeneric(e.argument,r);break;default:throw this.astErrorOutput(`unhandled return type ${this.returnType}`,e)}return this.isRootKernel?(t.push(`kernelResult = ${r.join("")};`),t.push("return;")):this.isSubKernel?(t.push(`subKernelResult_${this.name} = ${r.join("")};`),t.push(`return subKernelResult_${this.name};`)):t.push(`return ${r.join("")};`),t}astLiteral(e,t){if(isNaN(e.value))throw this.astErrorOutput("Non-numeric literal not supported : "+e.value,e);let n=this.astKey(e);return Number.isInteger(e.value)?this.isState("casting-to-integer")||this.isState("building-integer")?(this.literalTypes[n]="Integer",t.push(`${e.value}`)):this.isState("casting-to-float")||this.isState("building-float")?(this.literalTypes[n]="Number",t.push(`${e.value}.0`)):(this.literalTypes[n]="Number",t.push(`${e.value}.0`)):this.isState("casting-to-integer")||this.isState("building-integer")?(this.literalTypes[n]="Integer",t.push(Math.round(e.value))):(this.literalTypes[n]="Number",t.push(`${e.value}`)),t}astBinaryExpression(e,t){if(this.checkAndUpconvertOperator(e,t))return t;if(this.fixIntegerDivisionAccuracy&&e.operator==="/"){switch(t.push("divWithIntCheck("),this.pushState("building-float"),this.getType(e.left)){case"Integer":this.castValueToFloat(e.left,t);break;case"LiteralInteger":this.castLiteralToFloat(e.left,t);break;default:this.astGeneric(e.left,t)}switch(t.push(", "),this.getType(e.right)){case"Integer":this.castValueToFloat(e.right,t);break;case"LiteralInteger":this.castLiteralToFloat(e.right,t);break;default:this.astGeneric(e.right,t)}return this.popState("building-float"),t.push(")"),t}t.push("(");let n=this.getType(e.left)||"Number",r=this.getType(e.right)||"Number";if(!n||!r)throw this.astErrorOutput("Unhandled binary expression",e);let s=n+" & "+r;switch(s){case"Integer & Integer":this.pushState("building-integer"),this.astGeneric(e.left,t),t.push(V[e.operator]||e.operator),this.astGeneric(e.right,t),this.popState("building-integer");break;case"Number & Float":case"Float & Number":case"Float & Float":case"Number & Number":this.pushState("building-float"),this.astGeneric(e.left,t),t.push(V[e.operator]||e.operator),this.astGeneric(e.right,t),this.popState("building-float");break;case"LiteralInteger & LiteralInteger":this.isState("casting-to-integer")||this.isState("building-integer")?(this.pushState("building-integer"),this.astGeneric(e.left,t),t.push(V[e.operator]||e.operator),this.astGeneric(e.right,t),this.popState("building-integer")):(this.pushState("building-float"),this.castLiteralToFloat(e.left,t),t.push(V[e.operator]||e.operator),this.castLiteralToFloat(e.right,t),this.popState("building-float"));break;case"Integer & Float":case"Integer & Number":if((e.operator===">"||e.operator==="<"&&e.right.type==="Literal")&&!Number.isInteger(e.right.value)){this.pushState("building-float"),this.castValueToFloat(e.left,t),t.push(V[e.operator]||e.operator),this.astGeneric(e.right,t),this.popState("building-float");break}if(this.pushState("building-integer"),this.astGeneric(e.left,t),t.push(V[e.operator]||e.operator),this.pushState("casting-to-integer"),e.right.type==="Literal"){let a=[];if(this.astGeneric(e.right,a),this.getType(e.right)==="Integer")t.push(a.join(""));else throw this.astErrorOutput("Unhandled binary expression with literal",e)}else t.push("int("),this.astGeneric(e.right,t),t.push(")");this.popState("casting-to-integer"),this.popState("building-integer");break;case"Integer & LiteralInteger":this.pushState("building-integer"),this.astGeneric(e.left,t),t.push(V[e.operator]||e.operator),this.castLiteralToInteger(e.right,t),this.popState("building-integer");break;case"Number & Integer":this.pushState("building-float"),this.astGeneric(e.left,t),t.push(V[e.operator]||e.operator),this.castValueToFloat(e.right,t),this.popState("building-float");break;case"Float & LiteralInteger":case"Number & LiteralInteger":this.pushState("building-float"),this.astGeneric(e.left,t),t.push(V[e.operator]||e.operator),this.castLiteralToFloat(e.right,t),this.popState("building-float");break;case"LiteralInteger & Float":case"LiteralInteger & Number":this.isState("casting-to-integer")?(this.pushState("building-integer"),this.castLiteralToInteger(e.left,t),t.push(V[e.operator]||e.operator),this.castValueToInteger(e.right,t),this.popState("building-integer")):(this.pushState("building-float"),this.astGeneric(e.left,t),t.push(V[e.operator]||e.operator),this.pushState("casting-to-float"),this.astGeneric(e.right,t),this.popState("casting-to-float"),this.popState("building-float"));break;case"LiteralInteger & Integer":this.pushState("building-integer"),this.castLiteralToInteger(e.left,t),t.push(V[e.operator]||e.operator),this.astGeneric(e.right,t),this.popState("building-integer");break;case"Boolean & Boolean":this.pushState("building-boolean"),this.astGeneric(e.left,t),t.push(V[e.operator]||e.operator),this.astGeneric(e.right,t),this.popState("building-boolean");break;case"Float & Integer":this.pushState("building-float"),this.astGeneric(e.left,t),t.push(V[e.operator]||e.operator),this.castValueToFloat(e.right,t),this.popState("building-float");break;default:throw this.astErrorOutput(`Unhandled binary expression between ${s}`,e)}return t.push(")"),t}checkAndUpconvertOperator(e,t){let n=this.checkAndUpconvertBitwiseOperators(e,t);if(n)return n;let s={"%":this.fixIntegerDivisionAccuracy?"integerCorrectionModulo":"modulo","**":"pow"}[e.operator];if(!s)return null;switch(t.push(s),t.push("("),this.getType(e.left)){case"Integer":this.castValueToFloat(e.left,t);break;case"LiteralInteger":this.castLiteralToFloat(e.left,t);break;default:this.astGeneric(e.left,t)}switch(t.push(","),this.getType(e.right)){case"Integer":this.castValueToFloat(e.right,t);break;case"LiteralInteger":this.castLiteralToFloat(e.right,t);break;default:this.astGeneric(e.right,t)}return t.push(")"),t}checkAndUpconvertBitwiseOperators(e,t){let r={"&":"bitwiseAnd","|":"bitwiseOr","^":"bitwiseXOR","<<":"bitwiseZeroFillLeftShift",">>":"bitwiseSignedRightShift",">>>":"bitwiseZeroFillRightShift"}[e.operator];if(!r)return null;switch(t.push(r),t.push("("),this.getType(e.left)){case"Number":case"Float":this.castValueToInteger(e.left,t);break;case"LiteralInteger":this.castLiteralToInteger(e.left,t);break;default:this.astGeneric(e.left,t)}switch(t.push(","),this.getType(e.right)){case"Number":case"Float":this.castValueToInteger(e.right,t);break;case"LiteralInteger":this.castLiteralToInteger(e.right,t);break;default:this.astGeneric(e.right,t)}return t.push(")"),t}checkAndUpconvertBitwiseUnary(e,t){let r={"~":"bitwiseNot"}[e.operator];if(!r)return null;switch(t.push(r),t.push("("),this.getType(e.argument)){case"Number":case"Float":this.castValueToInteger(e.argument,t);break;case"LiteralInteger":this.castLiteralToInteger(e.argument,t);break;default:this.astGeneric(e.argument,t)}return t.push(")"),t}castLiteralToInteger(e,t){return this.pushState("casting-to-integer"),this.astGeneric(e,t),this.popState("casting-to-integer"),t}castLiteralToFloat(e,t){return this.pushState("casting-to-float"),this.astGeneric(e,t),this.popState("casting-to-float"),t}castValueToInteger(e,t){return this.pushState("casting-to-integer"),t.push("int("),this.astGeneric(e,t),t.push(")"),this.popState("casting-to-integer"),t}castValueToFloat(e,t){return this.pushState("casting-to-float"),t.push("float("),this.astGeneric(e,t),t.push(")"),this.popState("casting-to-float"),t}astIdentifierExpression(e,t){if(e.type!=="Identifier")throw this.astErrorOutput("IdentifierExpression - not an Identifier",e);let n=this.getType(e),r=j.sanitizeName(e.name);return e.name==="Infinity"?t.push("3.402823466e+38"):n==="Boolean"?this.argumentNames.indexOf(r)>-1?t.push(`bool(user_${r})`):t.push(`user_${r}`):t.push(`user_${r}`),t}astForStatement(e,t){if(e.type!=="ForStatement")throw this.astErrorOutput("Invalid for statement",e);let n=[],r=[],s=[],a=[],o=null;if(e.init){let{declarations:l}=e.init;l.length>1&&(o=!1),this.astGeneric(e.init,n);for(let u=0;u<l.length;u++)l[u].init&&l[u].init.type!=="Literal"&&(o=!1)}else o=!1;if(e.test?this.astGeneric(e.test,r):o=!1,e.update?this.astGeneric(e.update,s):o=!1,e.body&&(this.pushState("loop-body"),this.astGeneric(e.body,a),this.popState("loop-body")),o===null&&(o=this.isSafe(e.init)&&this.isSafe(e.test)),o){let l=n.join(""),u=l[l.length-1]!==";";t.push(`for (${l}${u?";":""}${r.join("")};${s.join("")}){
`),t.push(a.join("")),t.push(`}
`)}else{let l=this.getInternalVariableName("safeI");n.length>0&&t.push(n.join(""),`
`),t.push(`for (int ${l}=0;${l}<LOOP_MAX;${l}++){
`),r.length>0&&t.push(`if (!${r.join("")}) break;
`),t.push(a.join("")),t.push(`
${s.join("")};`),t.push(`}
`)}return t}astWhileStatement(e,t){if(e.type!=="WhileStatement")throw this.astErrorOutput("Invalid while statement",e);let n=this.getInternalVariableName("safeI");return t.push(`for (int ${n}=0;${n}<LOOP_MAX;${n}++){
`),t.push("if (!"),this.astGeneric(e.test,t),t.push(`) break;
`),this.astGeneric(e.body,t),t.push(`}
`),t}astDoWhileStatement(e,t){if(e.type!=="DoWhileStatement")throw this.astErrorOutput("Invalid while statement",e);let n=this.getInternalVariableName("safeI");return t.push(`for (int ${n}=0;${n}<LOOP_MAX;${n}++){
`),this.astGeneric(e.body,t),t.push("if (!"),this.astGeneric(e.test,t),t.push(`) break;
`),t.push(`}
`),t}astAssignmentExpression(e,t){if(e.operator==="%=")this.astGeneric(e.left,t),t.push("="),t.push("mod("),this.astGeneric(e.left,t),t.push(","),this.astGeneric(e.right,t),t.push(")");else if(e.operator==="**=")this.astGeneric(e.left,t),t.push("="),t.push("pow("),this.astGeneric(e.left,t),t.push(","),this.astGeneric(e.right,t),t.push(")");else{let n=this.getType(e.left),r=this.getType(e.right);return this.astGeneric(e.left,t),t.push(e.operator),n!=="Integer"&&r==="Integer"?(t.push("float("),this.astGeneric(e.right,t),t.push(")")):this.astGeneric(e.right,t),t}}astBlockStatement(e,t){if(this.isState("loop-body")){this.pushState("block-body");for(let n=0;n<e.body.length;n++)this.astGeneric(e.body[n],t);this.popState("block-body")}else{t.push(`{
`);for(let n=0;n<e.body.length;n++)this.astGeneric(e.body[n],t);t.push(`}
`)}return t}astVariableDeclaration(e,t){let n=e.declarations;if(!n||!n[0]||!n[0].init)throw this.astErrorOutput("Unexpected expression",e);let r=[],s=null,a=[],o=[];for(let l=0;l<n.length;l++){let u=n[l],h=u.init,c=this.getDeclaration(u.id),m=this.getType(u.init),f=m;f==="LiteralInteger"&&(c.suggestedType==="Integer"?f="Integer":f="Number");let g=Vt[f];if(!g)throw this.astErrorOutput(`Markup type ${f} not handled`,e);let S=[];if(m==="Integer"&&f==="Integer"){if(c.valueType="Number",l===0||s===null)S.push("float ");else if(f!==s)throw new Error("Unhandled declaration");s=f,S.push(`user_${j.sanitizeName(u.id.name)}=`),S.push("float("),this.astGeneric(h,S),S.push(")")}else c.valueType=f,l===0||s===null?S.push(`${g} `):f!==s&&(a.push(o.join(",")),o=[],S.push(`${g} `)),s=f,S.push(`user_${j.sanitizeName(u.id.name)}=`),m==="Number"&&f==="Integer"?h.left&&h.left.type==="Literal"?this.astGeneric(h,S):(S.push("int("),this.astGeneric(h,S),S.push(")")):m==="LiteralInteger"&&f==="Integer"?this.castLiteralToInteger(h,S):this.astGeneric(h,S);o.push(S.join(""))}return o.length>0&&a.push(o.join(",")),r.push(a.join(";")),t.push(r.join("")),t.push(";"),t}astIfStatement(e,t){return t.push("if ("),this.astGeneric(e.test,t),t.push(")"),e.consequent.type==="BlockStatement"?this.astGeneric(e.consequent,t):(t.push(` {
`),this.astGeneric(e.consequent,t),t.push(`
}
`)),e.alternate&&(t.push("else "),e.alternate.type==="BlockStatement"||e.alternate.type==="IfStatement"?this.astGeneric(e.alternate,t):(t.push(` {
`),this.astGeneric(e.alternate,t),t.push(`
}
`))),t}astSwitchStatement(e,t){if(e.type!=="SwitchStatement")throw this.astErrorOutput("Invalid switch statement",e);let{discriminant:n,cases:r}=e,s=this.getType(n),a=`switchDiscriminant${this.astKey(e,"_")}`;switch(s){case"Float":case"Number":t.push(`float ${a} = `),this.astGeneric(n,t),t.push(`;
`);break;case"Integer":t.push(`int ${a} = `),this.astGeneric(n,t),t.push(`;
`);break}if(r.length===1&&!r[0].test)return this.astGeneric(r[0].consequent,t),t;let o=!1,l=[],u=!1,h=!1;for(let c=0;c<r.length;c++){if(r[c].test){if(c===0||!h?(h=!0,t.push(`if (${a} == `)):o?(t.push(`${a} == `),o=!1):t.push(` else if (${a} == `),s==="Integer")switch(this.getType(r[c].test)){case"Number":case"Float":this.castValueToInteger(r[c].test,t);break;case"LiteralInteger":this.castLiteralToInteger(r[c].test,t);break}else if(s==="Float")switch(this.getType(r[c].test)){case"LiteralInteger":this.castLiteralToFloat(r[c].test,t);break;case"Integer":this.castValueToFloat(r[c].test,t);break}else throw new Error("unhanlded");if(!r[c].consequent||r[c].consequent.length===0){o=!0,t.push(" || ");continue}t.push(`) {
`)}else if(r.length>c+1){u=!0,this.astGeneric(r[c].consequent,l);continue}else t.push(` else {
`);this.astGeneric(r[c].consequent,t),t.push(`
}`)}return u&&(t.push(" else {"),t.push(l.join("")),t.push("}")),t}astThisExpression(e,t){return t.push("this"),t}astMemberExpression(e,t){let{property:n,name:r,signature:s,origin:a,type:o,xProperty:l,yProperty:u,zProperty:h}=this.getMemberExpressionDetails(e);switch(s){case"value.thread.value":case"this.thread.value":if(r!=="x"&&r!=="y"&&r!=="z")throw this.astErrorOutput("Unexpected expression, expected `this.thread.x`, `this.thread.y`, or `this.thread.z`",e);return t.push(`threadId.${r}`),t;case"this.output.value":if(this.dynamicOutput)switch(r){case"x":this.isState("casting-to-float")?t.push("float(uOutputDim.x)"):t.push("uOutputDim.x");break;case"y":this.isState("casting-to-float")?t.push("float(uOutputDim.y)"):t.push("uOutputDim.y");break;case"z":this.isState("casting-to-float")?t.push("float(uOutputDim.z)"):t.push("uOutputDim.z");break;default:throw this.astErrorOutput("Unexpected expression",e)}else switch(r){case"x":this.isState("casting-to-integer")?t.push(this.output[0]):t.push(this.output[0],".0");break;case"y":this.isState("casting-to-integer")?t.push(this.output[1]):t.push(this.output[1],".0");break;case"z":this.isState("casting-to-integer")?t.push(this.output[2]):t.push(this.output[2],".0");break;default:throw this.astErrorOutput("Unexpected expression",e)}return t;case"value":throw this.astErrorOutput("Unexpected expression",e);case"value[]":case"value[][]":case"value[][][]":case"value[][][][]":case"value.value":if(a==="Math")return t.push(Math[r]),t;let m=j.sanitizeName(r);switch(n){case"r":return t.push(`user_${m}.r`),t;case"g":return t.push(`user_${m}.g`),t;case"b":return t.push(`user_${m}.b`),t;case"a":return t.push(`user_${m}.a`),t}break;case"this.constants.value":if(typeof l=="undefined")switch(o){case"Array(2)":case"Array(3)":case"Array(4)":return t.push(`constants_${j.sanitizeName(r)}`),t}case"this.constants.value[]":case"this.constants.value[][]":case"this.constants.value[][][]":case"this.constants.value[][][][]":break;case"fn()[]":return this.astCallExpression(e.object,t),t.push("["),t.push(this.memberExpressionPropertyMarkup(n)),t.push("]"),t;case"fn()[][]":return this.astCallExpression(e.object.object,t),t.push("["),t.push(this.memberExpressionPropertyMarkup(e.object.property)),t.push("]"),t.push("["),t.push(this.memberExpressionPropertyMarkup(e.property)),t.push("]"),t;case"[][]":return this.astArrayExpression(e.object,t),t.push("["),t.push(this.memberExpressionPropertyMarkup(n)),t.push("]"),t;default:throw this.astErrorOutput("Unexpected expression",e)}if(e.computed===!1)switch(o){case"Number":case"Integer":case"Float":case"Boolean":return t.push(`${a}_${j.sanitizeName(r)}`),t}let c=`${a}_${j.sanitizeName(r)}`;switch(o){case"Array(2)":case"Array(3)":case"Array(4)":this.astGeneric(e.object,t),t.push("["),t.push(this.memberExpressionPropertyMarkup(l)),t.push("]");break;case"HTMLImageArray":t.push(`getImage3D(${c}, ${c}Size, ${c}Dim, `),this.memberExpressionXYZ(l,u,h,t),t.push(")");break;case"ArrayTexture(1)":t.push(`getFloatFromSampler2D(${c}, ${c}Size, ${c}Dim, `),this.memberExpressionXYZ(l,u,h,t),t.push(")");break;case"Array1D(2)":case"Array2D(2)":case"Array3D(2)":t.push(`getMemoryOptimizedVec2(${c}, ${c}Size, ${c}Dim, `),this.memberExpressionXYZ(l,u,h,t),t.push(")");break;case"ArrayTexture(2)":t.push(`getVec2FromSampler2D(${c}, ${c}Size, ${c}Dim, `),this.memberExpressionXYZ(l,u,h,t),t.push(")");break;case"Array1D(3)":case"Array2D(3)":case"Array3D(3)":t.push(`getMemoryOptimizedVec3(${c}, ${c}Size, ${c}Dim, `),this.memberExpressionXYZ(l,u,h,t),t.push(")");break;case"ArrayTexture(3)":t.push(`getVec3FromSampler2D(${c}, ${c}Size, ${c}Dim, `),this.memberExpressionXYZ(l,u,h,t),t.push(")");break;case"Array1D(4)":case"Array2D(4)":case"Array3D(4)":t.push(`getMemoryOptimizedVec4(${c}, ${c}Size, ${c}Dim, `),this.memberExpressionXYZ(l,u,h,t),t.push(")");break;case"ArrayTexture(4)":case"HTMLCanvas":case"HTMLImage":case"HTMLVideo":t.push(`getVec4FromSampler2D(${c}, ${c}Size, ${c}Dim, `),this.memberExpressionXYZ(l,u,h,t),t.push(")");break;case"NumberTexture":case"Array":case"Array2D":case"Array3D":case"Array4D":case"Input":case"Number":case"Float":case"Integer":if(this.precision==="single")t.push(`getMemoryOptimized32(${c}, ${c}Size, ${c}Dim, `),this.memberExpressionXYZ(l,u,h,t),t.push(")");else{let m=a==="user"?this.lookupFunctionArgumentBitRatio(this.name,r):this.constantBitRatios[r];switch(m){case 1:t.push(`get8(${c}, ${c}Size, ${c}Dim, `);break;case 2:t.push(`get16(${c}, ${c}Size, ${c}Dim, `);break;case 4:case 0:t.push(`get32(${c}, ${c}Size, ${c}Dim, `);break;default:throw new Error(`unhandled bit ratio of ${m}`)}this.memberExpressionXYZ(l,u,h,t),t.push(")")}break;case"MemoryOptimizedNumberTexture":t.push(`getMemoryOptimized32(${c}, ${c}Size, ${c}Dim, `),this.memberExpressionXYZ(l,u,h,t),t.push(")");break;case"Matrix(2)":case"Matrix(3)":case"Matrix(4)":t.push(`${c}[${this.memberExpressionPropertyMarkup(u)}]`),u&&t.push(`[${this.memberExpressionPropertyMarkup(l)}]`);break;default:throw new Error(`unhandled member expression "${o}"`)}return t}astCallExpression(e,t){if(!e.callee)throw this.astErrorOutput("Unknown CallExpression",e);let n=null,r=this.isAstMathFunction(e);if(r||e.callee.object&&e.callee.object.type==="ThisExpression"?n=e.callee.property.name:e.callee.type==="SequenceExpression"&&e.callee.expressions[0].type==="Literal"&&!isNaN(e.callee.expressions[0].raw)?n=e.callee.expressions[1].property.name:n=e.callee.name,!n)throw this.astErrorOutput("Unhandled function, couldn't find name",e);switch(n){case"pow":n="_pow";break;case"round":n="_round";break}if(this.calledFunctions.indexOf(n)<0&&this.calledFunctions.push(n),n==="random"&&this.plugins&&this.plugins.length>0)for(let s=0;s<this.plugins.length;s++){let a=this.plugins[s];if(a.functionMatch==="Math.random()"&&a.functionReplace)return t.push(a.functionReplace),t}if(this.onFunctionCall&&this.onFunctionCall(this.name,n,e.arguments),t.push(n),t.push("("),r)for(let s=0;s<e.arguments.length;++s){let a=e.arguments[s],o=this.getType(a);switch(s>0&&t.push(", "),o){case"Integer":this.castValueToFloat(a,t);break;default:this.astGeneric(a,t);break}}else{let s=this.lookupFunctionArgumentTypes(n)||[];for(let a=0;a<e.arguments.length;++a){let o=e.arguments[a],l=s[a];a>0&&t.push(", ");let u=this.getType(o);switch(l||(this.triggerImplyArgumentType(n,a,u,this),l=u),u){case"Boolean":this.astGeneric(o,t);continue;case"Number":case"Float":if(l==="Integer"){t.push("int("),this.astGeneric(o,t),t.push(")");continue}else if(l==="Number"||l==="Float"){this.astGeneric(o,t);continue}else if(l==="LiteralInteger"){this.castLiteralToFloat(o,t);continue}break;case"Integer":if(l==="Number"||l==="Float"){t.push("float("),this.astGeneric(o,t),t.push(")");continue}else if(l==="Integer"){this.astGeneric(o,t);continue}break;case"LiteralInteger":if(l==="Integer"){this.castLiteralToInteger(o,t);continue}else if(l==="Number"||l==="Float"){this.castLiteralToFloat(o,t);continue}else if(l==="LiteralInteger"){this.astGeneric(o,t);continue}break;case"Array(2)":case"Array(3)":case"Array(4)":if(l===u){if(o.type==="Identifier")t.push(`user_${j.sanitizeName(o.name)}`);else if(o.type==="ArrayExpression"||o.type==="MemberExpression"||o.type==="CallExpression")this.astGeneric(o,t);else throw this.astErrorOutput(`Unhandled argument type ${o.type}`,e);continue}break;case"HTMLCanvas":case"HTMLImage":case"HTMLImageArray":case"HTMLVideo":case"ArrayTexture(1)":case"ArrayTexture(2)":case"ArrayTexture(3)":case"ArrayTexture(4)":case"Array":case"Input":if(l===u){if(o.type!=="Identifier")throw this.astErrorOutput(`Unhandled argument type ${o.type}`,e);this.triggerImplyArgumentBitRatio(this.name,o.name,n,a);let h=j.sanitizeName(o.name);t.push(`user_${h},user_${h}Size,user_${h}Dim`);continue}break}throw this.astErrorOutput(`Unhandled argument combination of ${u} and ${l} for argument named "${o.name}"`,e)}}return t.push(")"),t}astArrayExpression(e,t){let n=this.getType(e),r=e.elements.length;switch(n){case"Matrix(2)":case"Matrix(3)":case"Matrix(4)":t.push(`mat${r}(`);break;default:t.push(`vec${r}(`)}for(let s=0;s<r;++s){s>0&&t.push(", ");let a=e.elements[s];this.astGeneric(a,t)}return t.push(")"),t}memberExpressionXYZ(e,t,n,r){return n?r.push(this.memberExpressionPropertyMarkup(n),", "):r.push("0, "),t?r.push(this.memberExpressionPropertyMarkup(t),", "):r.push("0, "),r.push(this.memberExpressionPropertyMarkup(e)),r}memberExpressionPropertyMarkup(e){if(!e)throw new Error("Property not set");let t=this.getType(e),n=[];switch(t){case"Number":case"Float":this.castValueToInteger(e,n);break;case"LiteralInteger":this.castLiteralToInteger(e,n);break;default:this.astGeneric(e,n)}return n.join("")}},Vt={Array:"sampler2D","Array(2)":"vec2","Array(3)":"vec3","Array(4)":"vec4","Matrix(2)":"mat2","Matrix(3)":"mat3","Matrix(4)":"mat4",Array2D:"sampler2D",Array3D:"sampler2D",Boolean:"bool",Float:"float",Input:"sampler2D",Integer:"int",Number:"float",LiteralInteger:"float",NumberTexture:"sampler2D",MemoryOptimizedNumberTexture:"sampler2D","ArrayTexture(1)":"sampler2D","ArrayTexture(2)":"sampler2D","ArrayTexture(3)":"sampler2D","ArrayTexture(4)":"sampler2D",HTMLVideo:"sampler2D",HTMLCanvas:"sampler2D",HTMLImage:"sampler2D",HTMLImageArray:"sampler2DArray"},V={"===":"==","!==":"!="};Mi.exports={WebGLFunctionNode:Ci}});var Kt=p((Mf,Li)=>{var Xl=`// https://www.shadertoy.com/view/4t2SDh
//note: uniformly distributed, normalized rand, [0,1]
highp float randomSeedShift = 1.0;
highp float slide = 1.0;
uniform highp float randomSeed1;
uniform highp float randomSeed2;

highp float nrand(highp vec2 n) {
  highp float result = fract(sin(dot((n.xy + 1.0) * vec2(randomSeed1 * slide, randomSeed2 * randomSeedShift), vec2(12.9898, 78.233))) * 43758.5453);
  randomSeedShift = result;
  if (randomSeedShift > 0.5) {
    slide += 0.00009; 
  } else {
    slide += 0.0009;
  }
  return result;
}`,Hl="math-random-uniformly-distributed",Yl="Math.random()",Zl="nrand(vTexCoord)",Jl="Number",Ql=i=>{i.setUniform1f("randomSeed1",Math.random()),i.setUniform1f("randomSeed2",Math.random())},ec={name:Hl,onBeforeRun:Ql,functionMatch:Yl,functionReplace:Zl,functionReturnType:Jl,source:Xl};Li.exports=ec});var Oi=p((Lf,ki)=>{var tc=`__HEADER__;
__FLOAT_TACTIC_DECLARATION__;
__INT_TACTIC_DECLARATION__;
__SAMPLER_2D_TACTIC_DECLARATION__;

const int LOOP_MAX = __LOOP_MAX__;

__PLUGINS__;
__CONSTANTS__;

varying vec2 vTexCoord;

float acosh(float x) {
  return log(x + sqrt(x * x - 1.0));
}

float sinh(float x) {
  return (pow(${Math.E}, x) - pow(${Math.E}, -x)) / 2.0;
}

float asinh(float x) {
  return log(x + sqrt(x * x + 1.0));
}

float atan2(float v1, float v2) {
  if (v1 == 0.0 || v2 == 0.0) return 0.0;
  return atan(v1 / v2);
}

float atanh(float x) {
  x = (x + 1.0) / (x - 1.0);
  if (x < 0.0) {
    return 0.5 * log(-x);
  }
  return 0.5 * log(x);
}

float cbrt(float x) {
  if (x >= 0.0) {
    return pow(x, 1.0 / 3.0);
  } else {
    return -pow(x, 1.0 / 3.0);
  }
}

float cosh(float x) {
  return (pow(${Math.E}, x) + pow(${Math.E}, -x)) / 2.0; 
}

float expm1(float x) {
  return pow(${Math.E}, x) - 1.0; 
}

float fround(highp float x) {
  return x;
}

float imul(float v1, float v2) {
  return float(int(v1) * int(v2));
}

float log10(float x) {
  return log2(x) * (1.0 / log2(10.0));
}

float log1p(float x) {
  return log(1.0 + x);
}

float _pow(float v1, float v2) {
  if (v2 == 0.0) return 1.0;
  return pow(v1, v2);
}

float tanh(float x) {
  float e = exp(2.0 * x);
  return (e - 1.0) / (e + 1.0);
}

float trunc(float x) {
  if (x >= 0.0) {
    return floor(x); 
  } else {
    return ceil(x);
  }
}

vec4 _round(vec4 x) {
  return floor(x + 0.5);
}

float _round(float x) {
  return floor(x + 0.5);
}

const int BIT_COUNT = 32;
int modi(int x, int y) {
  return x - y * (x / y);
}

int bitwiseOr(int a, int b) {
  int result = 0;
  int n = 1;
  
  for (int i = 0; i < BIT_COUNT; i++) {
    if ((modi(a, 2) == 1) || (modi(b, 2) == 1)) {
      result += n;
    }
    a = a / 2;
    b = b / 2;
    n = n * 2;
    if(!(a > 0 || b > 0)) {
      break;
    }
  }
  return result;
}
int bitwiseXOR(int a, int b) {
  int result = 0;
  int n = 1;
  
  for (int i = 0; i < BIT_COUNT; i++) {
    if ((modi(a, 2) == 1) != (modi(b, 2) == 1)) {
      result += n;
    }
    a = a / 2;
    b = b / 2;
    n = n * 2;
    if(!(a > 0 || b > 0)) {
      break;
    }
  }
  return result;
}
int bitwiseAnd(int a, int b) {
  int result = 0;
  int n = 1;
  for (int i = 0; i < BIT_COUNT; i++) {
    if ((modi(a, 2) == 1) && (modi(b, 2) == 1)) {
      result += n;
    }
    a = a / 2;
    b = b / 2;
    n = n * 2;
    if(!(a > 0 && b > 0)) {
      break;
    }
  }
  return result;
}
int bitwiseNot(int a) {
  int result = 0;
  int n = 1;
  
  for (int i = 0; i < BIT_COUNT; i++) {
    if (modi(a, 2) == 0) {
      result += n;    
    }
    a = a / 2;
    n = n * 2;
  }
  return result;
}
int bitwiseZeroFillLeftShift(int n, int shift) {
  int maxBytes = BIT_COUNT;
  for (int i = 0; i < BIT_COUNT; i++) {
    if (maxBytes >= n) {
      break;
    }
    maxBytes *= 2;
  }
  for (int i = 0; i < BIT_COUNT; i++) {
    if (i >= shift) {
      break;
    }
    n *= 2;
  }

  int result = 0;
  int byteVal = 1;
  for (int i = 0; i < BIT_COUNT; i++) {
    if (i >= maxBytes) break;
    if (modi(n, 2) > 0) { result += byteVal; }
    n = int(n / 2);
    byteVal *= 2;
  }
  return result;
}

int bitwiseSignedRightShift(int num, int shifts) {
  return int(floor(float(num) / pow(2.0, float(shifts))));
}

int bitwiseZeroFillRightShift(int n, int shift) {
  int maxBytes = BIT_COUNT;
  for (int i = 0; i < BIT_COUNT; i++) {
    if (maxBytes >= n) {
      break;
    }
    maxBytes *= 2;
  }
  for (int i = 0; i < BIT_COUNT; i++) {
    if (i >= shift) {
      break;
    }
    n /= 2;
  }
  int result = 0;
  int byteVal = 1;
  for (int i = 0; i < BIT_COUNT; i++) {
    if (i >= maxBytes) break;
    if (modi(n, 2) > 0) { result += byteVal; }
    n = int(n / 2);
    byteVal *= 2;
  }
  return result;
}

vec2 integerMod(vec2 x, float y) {
  vec2 res = floor(mod(x, y));
  return res * step(1.0 - floor(y), -res);
}

vec3 integerMod(vec3 x, float y) {
  vec3 res = floor(mod(x, y));
  return res * step(1.0 - floor(y), -res);
}

vec4 integerMod(vec4 x, vec4 y) {
  vec4 res = floor(mod(x, y));
  return res * step(1.0 - floor(y), -res);
}

float integerMod(float x, float y) {
  float res = floor(mod(x, y));
  return res * (res > floor(y) - 1.0 ? 0.0 : 1.0);
}

int integerMod(int x, int y) {
  return x - (y * int(x / y));
}

__DIVIDE_WITH_INTEGER_CHECK__;

// Here be dragons!
// DO NOT OPTIMIZE THIS CODE
// YOU WILL BREAK SOMETHING ON SOMEBODY'S MACHINE
// LEAVE IT AS IT IS, LEST YOU WASTE YOUR OWN TIME
const vec2 MAGIC_VEC = vec2(1.0, -256.0);
const vec4 SCALE_FACTOR = vec4(1.0, 256.0, 65536.0, 0.0);
const vec4 SCALE_FACTOR_INV = vec4(1.0, 0.00390625, 0.0000152587890625, 0.0); // 1, 1/256, 1/65536
float decode32(vec4 texel) {
  __DECODE32_ENDIANNESS__;
  texel *= 255.0;
  vec2 gte128;
  gte128.x = texel.b >= 128.0 ? 1.0 : 0.0;
  gte128.y = texel.a >= 128.0 ? 1.0 : 0.0;
  float exponent = 2.0 * texel.a - 127.0 + dot(gte128, MAGIC_VEC);
  float res = exp2(_round(exponent));
  texel.b = texel.b - 128.0 * gte128.x;
  res = dot(texel, SCALE_FACTOR) * exp2(_round(exponent-23.0)) + res;
  res *= gte128.y * -2.0 + 1.0;
  return res;
}

float decode16(vec4 texel, int index) {
  int channel = integerMod(index, 2);
  if (channel == 0) return texel.r * 255.0 + texel.g * 65280.0;
  if (channel == 1) return texel.b * 255.0 + texel.a * 65280.0;
  return 0.0;
}

float decode8(vec4 texel, int index) {
  int channel = integerMod(index, 4);
  if (channel == 0) return texel.r * 255.0;
  if (channel == 1) return texel.g * 255.0;
  if (channel == 2) return texel.b * 255.0;
  if (channel == 3) return texel.a * 255.0;
  return 0.0;
}

vec4 legacyEncode32(float f) {
  float F = abs(f);
  float sign = f < 0.0 ? 1.0 : 0.0;
  float exponent = floor(log2(F));
  float mantissa = (exp2(-exponent) * F);
  // exponent += floor(log2(mantissa));
  vec4 texel = vec4(F * exp2(23.0-exponent)) * SCALE_FACTOR_INV;
  texel.rg = integerMod(texel.rg, 256.0);
  texel.b = integerMod(texel.b, 128.0);
  texel.a = exponent*0.5 + 63.5;
  texel.ba += vec2(integerMod(exponent+127.0, 2.0), sign) * 128.0;
  texel = floor(texel);
  texel *= 0.003921569; // 1/255
  __ENCODE32_ENDIANNESS__;
  return texel;
}

// https://github.com/gpujs/gpu.js/wiki/Encoder-details
vec4 encode32(float value) {
  if (value == 0.0) return vec4(0, 0, 0, 0);

  float exponent;
  float mantissa;
  vec4  result;
  float sgn;

  sgn = step(0.0, -value);
  value = abs(value);

  exponent = floor(log2(value));

  mantissa = value*pow(2.0, -exponent)-1.0;
  exponent = exponent+127.0;
  result   = vec4(0,0,0,0);

  result.a = floor(exponent/2.0);
  exponent = exponent - result.a*2.0;
  result.a = result.a + 128.0*sgn;

  result.b = floor(mantissa * 128.0);
  mantissa = mantissa - result.b / 128.0;
  result.b = result.b + exponent*128.0;

  result.g = floor(mantissa*32768.0);
  mantissa = mantissa - result.g/32768.0;

  result.r = floor(mantissa*8388608.0);
  return result/255.0;
}
// Dragons end here

int index;
ivec3 threadId;

ivec3 indexTo3D(int idx, ivec3 texDim) {
  int z = int(idx / (texDim.x * texDim.y));
  idx -= z * int(texDim.x * texDim.y);
  int y = int(idx / texDim.x);
  int x = int(integerMod(idx, texDim.x));
  return ivec3(x, y, z);
}

float get32(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + texDim.x * (y + texDim.y * z);
  int w = texSize.x;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  vec4 texel = texture2D(tex, st / vec2(texSize));
  return decode32(texel);
}

float get16(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + texDim.x * (y + texDim.y * z);
  int w = texSize.x * 2;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  vec4 texel = texture2D(tex, st / vec2(texSize.x * 2, texSize.y));
  return decode16(texel, index);
}

float get8(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + texDim.x * (y + texDim.y * z);
  int w = texSize.x * 4;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  vec4 texel = texture2D(tex, st / vec2(texSize.x * 4, texSize.y));
  return decode8(texel, index);
}

float getMemoryOptimized32(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + texDim.x * (y + texDim.y * z);
  int channel = integerMod(index, 4);
  index = index / 4;
  int w = texSize.x;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  vec4 texel = texture2D(tex, st / vec2(texSize));
  if (channel == 0) return texel.r;
  if (channel == 1) return texel.g;
  if (channel == 2) return texel.b;
  if (channel == 3) return texel.a;
  return 0.0;
}

vec4 getImage2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + texDim.x * (y + texDim.y * z);
  int w = texSize.x;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  return texture2D(tex, st / vec2(texSize));
}

float getFloatFromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);
  return result[0];
}

vec2 getVec2FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);
  return vec2(result[0], result[1]);
}

vec2 getMemoryOptimizedVec2(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + (texDim.x * (y + (texDim.y * z)));
  int channel = integerMod(index, 2);
  index = index / 2;
  int w = texSize.x;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  vec4 texel = texture2D(tex, st / vec2(texSize));
  if (channel == 0) return vec2(texel.r, texel.g);
  if (channel == 1) return vec2(texel.b, texel.a);
  return vec2(0.0, 0.0);
}

vec3 getVec3FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);
  return vec3(result[0], result[1], result[2]);
}

vec3 getMemoryOptimizedVec3(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int fieldIndex = 3 * (x + texDim.x * (y + texDim.y * z));
  int vectorIndex = fieldIndex / 4;
  int vectorOffset = fieldIndex - vectorIndex * 4;
  int readY = vectorIndex / texSize.x;
  int readX = vectorIndex - readY * texSize.x;
  vec4 tex1 = texture2D(tex, (vec2(readX, readY) + 0.5) / vec2(texSize));
  
  if (vectorOffset == 0) {
    return tex1.xyz;
  } else if (vectorOffset == 1) {
    return tex1.yzw;
  } else {
    readX++;
    if (readX >= texSize.x) {
      readX = 0;
      readY++;
    }
    vec4 tex2 = texture2D(tex, vec2(readX, readY) / vec2(texSize));
    if (vectorOffset == 2) {
      return vec3(tex1.z, tex1.w, tex2.x);
    } else {
      return vec3(tex1.w, tex2.x, tex2.y);
    }
  }
}

vec4 getVec4FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  return getImage2D(tex, texSize, texDim, z, y, x);
}

vec4 getMemoryOptimizedVec4(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + texDim.x * (y + texDim.y * z);
  int channel = integerMod(index, 2);
  int w = texSize.x;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  vec4 texel = texture2D(tex, st / vec2(texSize));
  return vec4(texel.r, texel.g, texel.b, texel.a);
}

vec4 actualColor;
void color(float r, float g, float b, float a) {
  actualColor = vec4(r,g,b,a);
}

void color(float r, float g, float b) {
  color(r,g,b,1.0);
}

void color(sampler2D image) {
  actualColor = texture2D(image, vTexCoord);
}

float modulo(float number, float divisor) {
  if (number < 0.0) {
    number = abs(number);
    if (divisor < 0.0) {
      divisor = abs(divisor);
    }
    return -mod(number, divisor);
  }
  if (divisor < 0.0) {
    divisor = abs(divisor);
  }
  return mod(number, divisor);
}

__INJECTED_NATIVE__;
__MAIN_CONSTANTS__;
__MAIN_ARGUMENTS__;
__KERNEL__;

void main(void) {
  index = int(vTexCoord.s * float(uTexSize.x)) + int(vTexCoord.t * float(uTexSize.y)) * uTexSize.x;
  __MAIN_RESULT__;
}`;ki.exports={fragmentShader:tc}});var Ki=p((kf,Vi)=>{var nc=`__FLOAT_TACTIC_DECLARATION__;
__INT_TACTIC_DECLARATION__;
__SAMPLER_2D_TACTIC_DECLARATION__;

attribute vec2 aPos;
attribute vec2 aTexCoord;

varying vec2 vTexCoord;
uniform vec2 ratio;

void main(void) {
  gl_Position = vec4((aPos + vec2(1)) * ratio + vec2(-1), 0, 1);
  vTexCoord = aTexCoord;
}`;Vi.exports={vertexShader:nc}});var Ni=p((Of,Gt)=>{function Nt(i,e={}){let{contextName:t="gl",throwGetError:n,useTrackablePrimitives:r,readPixelsFile:s,recording:a=[],variables:o={},onReadPixels:l,onUnrecognizedArgumentLookup:u}=e,h=new Proxy(i,{get:$}),c=[],m={},f=0,g="",S;return h;function $(x,y){switch(y){case"addComment":return me;case"checkThrowError":return ue;case"getReadPixelsVariableName":return S;case"insertVariable":return K;case"reset":return v;case"setIndent":return te;case"toString":return w;case"getContextVariableName":return se}return typeof i[y]=="function"?function(){switch(y){case"getError":return n?a.push(`${g}if (${t}.getError() !== ${t}.NONE) throw new Error('error');`):a.push(`${g}${t}.getError();`),i.getError();case"getExtension":{let F=`${t}Variables${c.length}`;a.push(`${g}const ${F} = ${t}.getExtension('${arguments[0]}');`);let J=i.getExtension(arguments[0]);if(J&&typeof J=="object"){let P=Ut(J,{getEntity:L,useTrackablePrimitives:r,recording:a,contextName:F,contextVariables:c,variables:o,indent:g,onUnrecognizedArgumentLookup:u});return c.push(P),P}else c.push(null);return J}case"readPixels":let T=c.indexOf(arguments[6]),_;if(T===-1){let F=ie(arguments[6]);F?(_=F,a.push(`${g}${F}`)):(_=`${t}Variable${c.length}`,c.push(arguments[6]),a.push(`${g}const ${_} = new ${arguments[6].constructor.name}(${arguments[6].length});`))}else _=`${t}Variable${T}`;S=_;let A=[arguments[0],arguments[1],arguments[2],arguments[3],L(arguments[4]),L(arguments[5]),_];return a.push(`${g}${t}.readPixels(${A.join(", ")});`),s&&fe(arguments[2],arguments[3]),l&&l(_,A),i.readPixels.apply(i,arguments);case"drawBuffers":return a.push(`${g}${t}.drawBuffers([${Pe(arguments[0],{contextName:t,contextVariables:c,getEntity:L,addVariable:oe,variables:o,onUnrecognizedArgumentLookup:u})}]);`),i.drawBuffers(arguments[0])}let I=i[y].apply(i,arguments);switch(typeof I){case"undefined":a.push(`${g}${Z(y,arguments)};`);return;case"number":case"boolean":if(r&&c.indexOf(qe(I))===-1){a.push(`${g}const ${t}Variable${c.length} = ${Z(y,arguments)};`),c.push(I=qe(I));break}default:I===null?a.push(`${Z(y,arguments)};`):a.push(`${g}const ${t}Variable${c.length} = ${Z(y,arguments)};`),c.push(I)}return I}:(m[i[y]]=y,i[y])}function w(){return a.join(`
`)}function v(){for(;a.length>0;)a.pop()}function K(x,y){o[x]=y}function L(x){let y=m[x];return y?t+"."+y:x}function te(x){g=" ".repeat(x)}function oe(x,y){let I=`${t}Variable${c.length}`;return a.push(`${g}const ${I} = ${y};`),c.push(x),I}function fe(x,y){let I=`${t}Variable${c.length}`,T=`imageDatum${f}`;a.push(`${g}let ${T} = ["P3\\n# ${s}.ppm\\n", ${x}, ' ', ${y}, "\\n255\\n"].join("");`),a.push(`${g}for (let i = 0; i < ${T}.length; i += 4) {`),a.push(`${g}  ${T} += ${I}[i] + ' ' + ${I}[i + 1] + ' ' + ${I}[i + 2] + ' ';`),a.push(`${g}}`),a.push(`${g}if (typeof require !== "undefined") {`),a.push(`${g}  require('fs').writeFileSync('./${s}.ppm', ${T});`),a.push(`${g}}`),f++}function me(x){a.push(`${g}// ${x}`)}function ue(){a.push(`${g}(() => {
${g}const error = ${t}.getError();
${g}if (error !== ${t}.NONE) {
${g}  const names = Object.getOwnPropertyNames(gl);
${g}  for (let i = 0; i < names.length; i++) {
${g}    const name = names[i];
${g}    if (${t}[name] === error) {
${g}      throw new Error('${t} threw ' + name);
${g}    }
${g}  }
${g}}
${g}})();`)}function Z(x,y){return`${t}.${x}(${Pe(y,{contextName:t,contextVariables:c,getEntity:L,addVariable:oe,variables:o,onUnrecognizedArgumentLookup:u})})`}function ie(x){if(o){for(let y in o)if(o[y]===x)return y}return null}function se(x){let y=c.indexOf(x);return y!==-1?`${t}Variable${y}`:null}}function Ut(i,e){let t=new Proxy(i,{get:m}),n={},{contextName:r,contextVariables:s,getEntity:a,useTrackablePrimitives:o,recording:l,variables:u,indent:h,onUnrecognizedArgumentLookup:c}=e;return t;function m($,w){return typeof $[w]=="function"?function(){switch(w){case"drawBuffersWEBGL":return l.push(`${h}${r}.drawBuffersWEBGL([${Pe(arguments[0],{contextName:r,contextVariables:s,getEntity:f,addVariable:S,variables:u,onUnrecognizedArgumentLookup:c})}]);`),i.drawBuffersWEBGL(arguments[0])}let v=i[w].apply(i,arguments);switch(typeof v){case"undefined":l.push(`${h}${g(w,arguments)};`);return;case"number":case"boolean":o&&s.indexOf(qe(v))===-1?(l.push(`${h}const ${r}Variable${s.length} = ${g(w,arguments)};`),s.push(v=qe(v))):(l.push(`${h}const ${r}Variable${s.length} = ${g(w,arguments)};`),s.push(v));break;default:v===null?l.push(`${g(w,arguments)};`):l.push(`${h}const ${r}Variable${s.length} = ${g(w,arguments)};`),s.push(v)}return v}:(n[i[w]]=w,i[w])}function f($){return n.hasOwnProperty($)?`${r}.${n[$]}`:a($)}function g($,w){return`${r}.${$}(${Pe(w,{contextName:r,contextVariables:s,getEntity:f,addVariable:S,variables:u,onUnrecognizedArgumentLookup:c})})`}function S($,w){let v=`${r}Variable${s.length}`;return s.push($),l.push(`${h}const ${v} = ${w};`),v}}function Pe(i,e){let{variables:t,onUnrecognizedArgumentLookup:n}=e;return Array.from(i).map(s=>{let a=r(s);return a||rc(s,e)}).join(", ");function r(s){if(t){for(let a in t)if(!!t.hasOwnProperty(a)&&t[a]===s)return a}return n?n(s):null}}function rc(i,e){let{contextName:t,contextVariables:n,getEntity:r,addVariable:s,onUnrecognizedArgumentLookup:a}=e;if(typeof i=="undefined")return"undefined";if(i===null)return"null";let o=n.indexOf(i);if(o>-1)return`${t}Variable${o}`;switch(i.constructor.name){case"String":let l=/\n/.test(i),u=/'/.test(i),h=/"/.test(i);return l?"`"+i+"`":u&&!h?'"'+i+'"':"'"+i+"'";case"Number":return r(i);case"Boolean":return r(i);case"Array":return s(i,`new ${i.constructor.name}([${Array.from(i).join(",")}])`);case"Float32Array":case"Uint8Array":case"Uint16Array":case"Int32Array":return s(i,`new ${i.constructor.name}(${JSON.stringify(Array.from(i))})`);default:if(a){let c=a(i);if(c)return c}throw new Error(`unrecognized argument type ${i.constructor.name}`)}}function qe(i){return new i.constructor(i)}typeof Gt!="undefined"&&(Gt.exports={glWiretap:Nt,glExtensionWiretap:Ut});typeof window!="undefined"&&(Nt.glExtensionWiretap=Ut,window.glWiretap=Nt)});var Bt=p((Vf,Gi)=>{var{glWiretap:ic}=Ni(),{utils:Q}=d();function ce(i){return i.toString().replace("=>","").replace(/^function /,"").replace(/utils[.]/g,"/*utils.*/")}function sc(i,e,t,n,r){t.built||t.build.apply(t,e),e=e?Array.from(e).map(T=>{switch(typeof T){case"boolean":return new Boolean(T);case"number":return new Number(T);default:return T}}):null;let s=[],a=[],o=ic(t.context,{useTrackablePrimitives:!0,onReadPixels:T=>{if(x.subKernels){if(!l)a.push(`    const result = { result: ${Pt(T,x)} };`),l=!0;else{let _=x.subKernels[u++].property;a.push(`    result${isNaN(_)?"."+_:`[${_}]`} = ${Pt(T,x)};`)}u===x.subKernels.length&&a.push("    return result;");return}T?a.push(`    return ${Pt(T,x)};`):a.push("    return null;")},onUnrecognizedArgumentLookup:T=>{let _=Ui(T,x.kernelArguments,[],o,s);if(_)return _;let A=Ui(T,x.kernelConstants,$?Object.keys($).map(F=>$[F]):[],o,s);return A||null}}),l=!1,u=0,{source:h,canvas:c,output:m,pipeline:f,graphical:g,loopMaxIterations:S,constants:$,optimizeFloatMemory:w,precision:v,fixIntegerDivisionAccuracy:K,functions:L,nativeFunctions:te,subKernels:oe,immutable:fe,argumentTypes:me,constantTypes:ue,kernelArguments:Z,kernelConstants:ie,tactic:se}=t,x=new i(h,{canvas:c,context:o,checkContext:!1,output:m,pipeline:f,graphical:g,loopMaxIterations:S,constants:$,optimizeFloatMemory:w,precision:v,fixIntegerDivisionAccuracy:K,functions:L,nativeFunctions:te,subKernels:oe,immutable:fe,argumentTypes:me,constantTypes:ue,tactic:se}),y=[];if(o.setIndent(2),x.build.apply(x,e),y.push(o.toString()),o.reset(),x.kernelArguments.forEach((T,_)=>{switch(T.type){case"Integer":case"Boolean":case"Number":case"Float":case"Array":case"Array(2)":case"Array(3)":case"Array(4)":case"HTMLCanvas":case"HTMLImage":case"HTMLVideo":o.insertVariable(`uploadValue_${T.name}`,T.uploadValue);break;case"HTMLImageArray":for(let A=0;A<e[_].length;A++){let F=e[_];o.insertVariable(`uploadValue_${T.name}[${A}]`,F[A])}break;case"Input":o.insertVariable(`uploadValue_${T.name}`,T.uploadValue);break;case"MemoryOptimizedNumberTexture":case"NumberTexture":case"Array1D(2)":case"Array1D(3)":case"Array1D(4)":case"Array2D(2)":case"Array2D(3)":case"Array2D(4)":case"Array3D(2)":case"Array3D(3)":case"Array3D(4)":case"ArrayTexture(1)":case"ArrayTexture(2)":case"ArrayTexture(3)":case"ArrayTexture(4)":o.insertVariable(`uploadValue_${T.name}`,e[_].texture);break;default:throw new Error(`unhandled kernelArgumentType insertion for glWiretap of type ${T.type}`)}}),y.push("/** start of injected functions **/"),y.push(`function ${ce(Q.flattenTo)}`),y.push(`function ${ce(Q.flatten2dArrayTo)}`),y.push(`function ${ce(Q.flatten3dArrayTo)}`),y.push(`function ${ce(Q.flatten4dArrayTo)}`),y.push(`function ${ce(Q.isArray)}`),x.renderOutput!==x.renderTexture&&x.formatValues&&y.push(`  const renderOutput = function ${ce(x.formatValues)};`),y.push("/** end of injected functions **/"),y.push(`  const innerKernel = function (${x.kernelArguments.map(T=>T.varName).join(", ")}) {`),o.setIndent(4),x.run.apply(x,e),x.renderKernels?x.renderKernels():x.renderOutput&&x.renderOutput(),y.push("    /** start setup uploads for kernel values **/"),x.kernelArguments.forEach(T=>{y.push("    "+T.getStringValueHandler().split(`
`).join(`
    `))}),y.push("    /** end setup uploads for kernel values **/"),y.push(o.toString()),x.renderOutput===x.renderTexture){o.reset();let T=o.getContextVariableName(x.framebuffer);if(x.renderKernels){let _=x.renderKernels(),A=o.getContextVariableName(x.texture.texture);y.push(`    return {
      result: {
        texture: ${A},
        type: '${_.result.type}',
        toArray: ${qt(_.result,A,T)}
      },`);let{subKernels:F,mappedTextures:J}=x;for(let P=0;P<F.length;P++){let xt=J[P],ke=F[P],de=_[ke.property],ge=o.getContextVariableName(xt.texture);y.push(`
      ${ke.property}: {
        texture: ${ge},
        type: '${de.type}',
        toArray: ${qt(de,ge,T)}
      },`)}y.push("    };")}else{let _=x.renderOutput(),A=o.getContextVariableName(x.texture.texture);y.push(`    return {
        texture: ${A},
        type: '${_.type}',
        toArray: ${qt(_,A,T)}
      };`)}}y.push(`    ${r?`
`+r+"    ":""}`),y.push(a.join(`
`)),y.push("  };"),x.graphical&&(y.push(ac(x)),y.push("  innerKernel.getPixels = getPixels;")),y.push("  return innerKernel;");let I=[];return ie.forEach(T=>{I.push(`${T.getStringValueHandler()}`)}),`function kernel(settings) {
  const { context, constants } = settings;
  ${I.join("")}
  ${n||""}
${y.join(`
`)}
}`}function Pt(i,e){let t=e.precision==="single"?i:`new Float32Array(${i}.buffer)`;return e.output[2]?`renderOutput(${t}, ${e.output[0]}, ${e.output[1]}, ${e.output[2]})`:e.output[1]?`renderOutput(${t}, ${e.output[0]}, ${e.output[1]})`:`renderOutput(${t}, ${e.output[0]})`}function ac(i){let e=i.getPixels.toString(),t=!/^function/.test(e);return Q.flattenFunctionToString(`${t?"function ":""}${e}`,{findDependency:(n,r)=>n==="utils"?`const ${r} = ${Q[r].toString()};`:null,thisLookup:n=>{if(n==="context")return null;if(i.hasOwnProperty(n))return JSON.stringify(i[n]);throw new Error(`unhandled thisLookup ${n}`)}})}function qt(i,e,t){let n=i.toArray.toString(),r=!/^function/.test(n),s=Q.flattenFunctionToString(`${r?"function ":""}${n}`,{findDependency:(a,o)=>{if(a==="utils")return`const ${o} = ${Q[o].toString()};`;if(a==="this")return o==="framebuffer"?"":`${r?"function ":""}${i[o].toString()}`;throw new Error("unhandled fromObject")},thisLookup:(a,o)=>{if(a==="texture")return e;if(a==="context")return o?null:"gl";if(i.hasOwnProperty(a))return JSON.stringify(i[a]);throw new Error(`unhandled thisLookup ${a}`)}});return`() => {
  function framebuffer() { return ${t}; };
  ${s}
  return toArray();
  }`}function Ui(i,e,t,n,r){if(i===null||e===null)return null;switch(typeof i){case"boolean":case"number":return null}if(typeof HTMLImageElement!="undefined"&&i instanceof HTMLImageElement)for(let s=0;s<e.length;s++){let a=e[s];if(a.type!=="HTMLImageArray"&&a||a.uploadValue!==i)continue;let o=t[s].indexOf(i);if(o===-1)continue;let l=`uploadValue_${a.name}[${o}]`;return n.insertVariable(l,i),l}for(let s=0;s<e.length;s++){let a=e[s];if(i!==a.uploadValue)continue;let o=`uploadValue_${a.name}`;return n.insertVariable(o,a),o}return null}Gi.exports={glKernelString:sc}});var Bi=p((Kf,qi)=>{var Pi=class{constructor(e,t){let{name:n,kernel:r,context:s,checkContext:a,onRequestContextHandle:o,onUpdateValueMismatch:l,origin:u,strictIntegers:h,type:c,tactic:m}=t;if(!n)throw new Error("name not set");if(!c)throw new Error("type not set");if(!u)throw new Error("origin not set");if(u!=="user"&&u!=="constants")throw new Error(`origin must be "user" or "constants" value is "${u}"`);if(!o)throw new Error("onRequestContextHandle is not set");this.name=n,this.origin=u,this.tactic=m,this.varName=u==="constants"?`constants.${n}`:n,this.kernel=r,this.strictIntegers=h,this.type=e.type||c,this.size=e.size||null,this.index=null,this.context=s,this.checkContext=a!=null?a:!0,this.contextHandle=null,this.onRequestContextHandle=o,this.onUpdateValueMismatch=l,this.forceUploadEachRun=null}get id(){return`${this.origin}_${name}`}getSource(){throw new Error(`"getSource" not defined on ${this.constructor.name}`)}updateValue(e){throw new Error(`"updateValue" not defined on ${this.constructor.name}`)}};qi.exports={KernelValue:Pi}});var re=p((Nf,Wi)=>{var{utils:oc}=d(),{KernelValue:uc}=Bi(),ji=class extends uc{constructor(e,t){super(e,t);this.dimensionsId=null,this.sizeId=null,this.initialValueConstructor=e.constructor,this.onRequestTexture=t.onRequestTexture,this.onRequestIndex=t.onRequestIndex,this.uploadValue=null,this.textureSize=null,this.bitRatio=null,this.prevArg=null}get id(){return`${this.origin}_${oc.sanitizeName(this.name)}`}setup(){}getTransferArrayType(e){if(Array.isArray(e[0]))return this.getTransferArrayType(e[0]);switch(e.constructor){case Array:case Int32Array:case Int16Array:case Int8Array:return Float32Array;case Uint8ClampedArray:case Uint8Array:case Uint16Array:case Uint32Array:case Float32Array:case Float64Array:return e.constructor}return console.warn("Unfamiliar constructor type.  Will go ahead and use, but likley this may result in a transfer of zeros"),e.constructor}getStringValueHandler(){throw new Error(`"getStringValueHandler" not implemented on ${this.constructor.name}`)}getVariablePrecisionString(){return this.kernel.getVariablePrecisionString(this.textureSize||void 0,this.tactic||void 0)}destroy(){}};Wi.exports={WebGLKernelValue:ji}});var jt=p((Gf,Hi)=>{var{utils:Uf}=d(),{WebGLKernelValue:lc}=re(),Xi=class extends lc{constructor(e,t){super(e,t);this.uploadValue=e}getSource(e){return this.origin==="constants"?`const bool ${this.id} = ${e};
`:`uniform bool ${this.id};
`}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName};
`}updateValue(e){this.origin!=="constants"&&this.kernel.setUniform1i(this.id,this.uploadValue=e)}};Hi.exports={WebGLKernelValueBoolean:Xi}});var Wt=p((qf,Zi)=>{var{utils:Pf}=d(),{WebGLKernelValue:cc}=re(),Yi=class extends cc{constructor(e,t){super(e,t);this.uploadValue=e}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName};
`}getSource(e){return this.origin==="constants"?Number.isInteger(e)?`const float ${this.id} = ${e}.0;
`:`const float ${this.id} = ${e};
`:`uniform float ${this.id};
`}updateValue(e){this.origin!=="constants"&&this.kernel.setUniform1f(this.id,this.uploadValue=e)}};Zi.exports={WebGLKernelValueFloat:Yi}});var Xt=p((jf,Qi)=>{var{utils:Bf}=d(),{WebGLKernelValue:hc}=re(),Ji=class extends hc{constructor(e,t){super(e,t);this.uploadValue=e}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName};
`}getSource(e){return this.origin==="constants"?`const int ${this.id} = ${parseInt(e)};
`:`uniform int ${this.id};
`}updateValue(e){this.origin!=="constants"&&this.kernel.setUniform1i(this.id,this.uploadValue=e)}};Qi.exports={WebGLKernelValueInteger:Ji}});var N=p((Wf,ts)=>{var{WebGLKernelValue:pc}=re(),{Input:fc}=xe(),es=class extends pc{checkSize(e,t){if(!this.kernel.validate)return;let{maxTextureSize:n}=this.kernel.constructor.features;if(e>n||t>n)throw e>t?new Error(`Argument texture width of ${e} larger than maximum size of ${n} for your GPU`):e<t?new Error(`Argument texture height of ${t} larger than maximum size of ${n} for your GPU`):new Error(`Argument texture height and width of ${t} larger than maximum size of ${n} for your GPU`)}setup(){this.requestTexture(),this.setupTexture(),this.defineTexture()}requestTexture(){this.texture=this.onRequestTexture()}defineTexture(){let{context:e}=this;e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)}setupTexture(){this.contextHandle=this.onRequestContextHandle(),this.index=this.onRequestIndex(),this.dimensionsId=this.id+"Dim",this.sizeId=this.id+"Size"}getBitRatio(e){if(Array.isArray(e[0]))return this.getBitRatio(e[0]);if(e.constructor===fc)return this.getBitRatio(e.value);switch(e.constructor){case Uint8ClampedArray:case Uint8Array:case Int8Array:return 1;case Uint16Array:case Int16Array:return 2;case Float32Array:case Int32Array:default:return 4}}destroy(){this.prevArg&&this.prevArg.delete(),this.context.deleteTexture(this.texture)}};ts.exports={WebGLKernelArray:es}});var _e=p((Xf,rs)=>{var{utils:mc}=d(),{WebGLKernelArray:dc}=N(),ns=class extends dc{constructor(e,t){super(e,t);let{width:n,height:r}=e;this.checkSize(n,r),this.dimensions=[n,r,1],this.textureSize=[n,r],this.uploadValue=e}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName};
`}getSource(){return mc.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}let{context:t}=this;t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.uploadValue=e),this.kernel.setUniform1i(this.id,this.index)}};rs.exports={WebGLKernelValueHTMLImage:ns}});var Be=p((Hf,ss)=>{var{utils:gc}=d(),{WebGLKernelValueHTMLImage:xc}=_e(),is=class extends xc{getSource(){return gc.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(e){let{width:t,height:n}=e;this.checkSize(t,n),this.dimensions=[t,n,1],this.textureSize=[t,n],this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};ss.exports={WebGLKernelValueDynamicHTMLImage:is}});var us=p((Yf,os)=>{var{WebGLKernelValueHTMLImage:yc}=_e(),as=class extends yc{};os.exports={WebGLKernelValueHTMLVideo:as}});var hs=p((Zf,cs)=>{var{WebGLKernelValueDynamicHTMLImage:Tc}=Be(),ls=class extends Tc{};cs.exports={WebGLKernelValueDynamicHTMLVideo:ls}});var We=p((Jf,fs)=>{var{utils:je}=d(),{WebGLKernelArray:bc}=N(),ps=class extends bc{constructor(e,t){super(e,t);this.bitRatio=4;let[n,r,s]=e.size;this.dimensions=new Int32Array([n||1,r||1,s||1]),this.textureSize=je.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0],this.textureSize[1]),this.uploadValue=new Float32Array(this.uploadArrayLength)}getStringValueHandler(){return je.linesToString([`const uploadValue_${this.name} = new Float32Array(${this.uploadArrayLength})`,`flattenTo(${this.varName}.value, uploadValue_${this.name})`])}getSource(){return je.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}let{context:t}=this;je.flattenTo(e.value,this.uploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};fs.exports={WebGLKernelValueSingleInput:ps}});var xs=p((Qf,gs)=>{var{utils:ms}=d(),{WebGLKernelValueSingleInput:Sc}=We(),ds=class extends Sc{getSource(){return ms.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(e){let[t,n,r]=e.size;this.dimensions=new Int32Array([t||1,n||1,r||1]),this.textureSize=ms.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0],this.textureSize[1]),this.uploadValue=new Float32Array(this.uploadArrayLength),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};gs.exports={WebGLKernelValueDynamicSingleInput:ds}});var He=p((em,Ts)=>{var{utils:Xe}=d(),{WebGLKernelArray:Ec}=N(),ys=class extends Ec{constructor(e,t){super(e,t);this.bitRatio=this.getBitRatio(e);let[n,r,s]=e.size;this.dimensions=new Int32Array([n||1,r||1,s||1]),this.textureSize=Xe.getMemoryOptimizedPackedTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*(4/this.bitRatio),this.checkSize(this.textureSize[0],this.textureSize[1]),this.TranserArrayType=this.getTransferArrayType(e.value),this.preUploadValue=new this.TranserArrayType(this.uploadArrayLength),this.uploadValue=new Uint8Array(this.preUploadValue.buffer)}getStringValueHandler(){return Xe.linesToString([`const preUploadValue_${this.name} = new ${this.TranserArrayType.name}(${this.uploadArrayLength})`,`const uploadValue_${this.name} = new Uint8Array(preUploadValue_${this.name}.buffer)`,`flattenTo(${this.varName}.value, preUploadValue_${this.name})`])}getSource(){return Xe.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(value.constructor);return}let{context:t}=this;Xe.flattenTo(e.value,this.preUploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.UNSIGNED_BYTE,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};Ts.exports={WebGLKernelValueUnsignedInput:ys}});var Ht=p((tm,Es)=>{var{utils:bs}=d(),{WebGLKernelValueUnsignedInput:_c}=He(),Ss=class extends _c{getSource(){return bs.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(e){let[t,n,r]=e.size;this.dimensions=new Int32Array([t||1,n||1,r||1]),this.textureSize=bs.getMemoryOptimizedPackedTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*(4/this.bitRatio),this.checkSize(this.textureSize[0],this.textureSize[1]);let s=this.getTransferArrayType(e.value);this.preUploadValue=new s(this.uploadArrayLength),this.uploadValue=new Uint8Array(this.preUploadValue.buffer),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};Es.exports={WebGLKernelValueDynamicUnsignedInput:Ss}});var we=p((nm,ws)=>{var{utils:wc}=d(),{WebGLKernelArray:vc}=N(),Yt="Source and destination textures are the same.  Use immutable = true and manually cleanup kernel output texture memory with texture.delete()",_s=class extends vc{constructor(e,t){super(e,t);let[n,r]=e.size;this.checkSize(n,r),this.dimensions=e.dimensions,this.textureSize=e.size,this.uploadValue=e.texture,this.forceUploadEachRun=!0}setup(){this.setupTexture()}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName}.texture;
`}getSource(){return wc.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}if(this.checkContext&&e.context!==this.context)throw new Error(`Value ${this.name} (${this.type}) must be from same context`);let{kernel:t,context:n}=this;if(t.pipeline)if(t.immutable)t.updateTextureArgumentRefs(this,e);else{if(t.texture&&t.texture.texture===e.texture)throw new Error(Yt);if(t.mappedTextures){let{mappedTextures:r}=t;for(let s=0;s<r.length;s++)if(r[s].texture===e.texture)throw new Error(Yt)}}n.activeTexture(this.contextHandle),n.bindTexture(n.TEXTURE_2D,this.uploadValue=e.texture),this.kernel.setUniform1i(this.id,this.index)}};ws.exports={WebGLKernelValueMemoryOptimizedNumberTexture:_s,sameError:Yt}});var Zt=p((rm,$s)=>{var{utils:$c}=d(),{WebGLKernelValueMemoryOptimizedNumberTexture:Dc}=we(),vs=class extends Dc{getSource(){return $c.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(e){this.dimensions=e.dimensions,this.checkSize(e.size[0],e.size[1]),this.textureSize=e.size,this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};$s.exports={WebGLKernelValueDynamicMemoryOptimizedNumberTexture:vs}});var Ye=p((im,As)=>{var{utils:Ic}=d(),{WebGLKernelArray:Ac}=N(),{sameError:Ds}=we(),Is=class extends Ac{constructor(e,t){super(e,t);let[n,r]=e.size;this.checkSize(n,r);let{size:s,dimensions:a}=e;this.bitRatio=this.getBitRatio(e),this.dimensions=a,this.textureSize=s,this.uploadValue=e.texture,this.forceUploadEachRun=!0}setup(){this.setupTexture()}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName}.texture;
`}getSource(){return Ic.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}if(this.checkContext&&e.context!==this.context)throw new Error(`Value ${this.name} (${this.type}) must be from same context`);let{kernel:t,context:n}=this;if(t.pipeline)if(t.immutable)t.updateTextureArgumentRefs(this,e);else{if(t.texture&&t.texture.texture===e.texture)throw new Error(Ds);if(t.mappedTextures){let{mappedTextures:r}=t;for(let s=0;s<r.length;s++)if(r[s].texture===e.texture)throw new Error(Ds)}}n.activeTexture(this.contextHandle),n.bindTexture(n.TEXTURE_2D,this.uploadValue=e.texture),this.kernel.setUniform1i(this.id,this.index)}};As.exports={WebGLKernelValueNumberTexture:Is}});var Jt=p((sm,Fs)=>{var{utils:Rc}=d(),{WebGLKernelValueNumberTexture:Fc}=Ye(),Rs=class extends Fc{getSource(){return Rc.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(e){this.dimensions=e.dimensions,this.checkSize(e.size[0],e.size[1]),this.textureSize=e.size,this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};Fs.exports={WebGLKernelValueDynamicNumberTexture:Rs}});var Ze=p((am,Cs)=>{var{utils:ve}=d(),{WebGLKernelArray:zc}=N(),zs=class extends zc{constructor(e,t){super(e,t);this.bitRatio=4,this.dimensions=ve.getDimensions(e,!0),this.textureSize=ve.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0],this.textureSize[1]),this.uploadValue=new Float32Array(this.uploadArrayLength)}getStringValueHandler(){return ve.linesToString([`const uploadValue_${this.name} = new Float32Array(${this.uploadArrayLength})`,`flattenTo(${this.varName}, uploadValue_${this.name})`])}getSource(){return ve.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}let{context:t}=this;ve.flattenTo(e,this.uploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};Cs.exports={WebGLKernelValueSingleArray:zs}});var ks=p((om,Ls)=>{var{utils:Qt}=d(),{WebGLKernelValueSingleArray:Cc}=Ze(),Ms=class extends Cc{getSource(){return Qt.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(e){this.dimensions=Qt.getDimensions(e,!0),this.textureSize=Qt.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0],this.textureSize[1]),this.uploadValue=new Float32Array(this.uploadArrayLength),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};Ls.exports={WebGLKernelValueDynamicSingleArray:Ms}});var Je=p((um,Vs)=>{var{utils:$e}=d(),{WebGLKernelArray:Mc}=N(),Os=class extends Mc{constructor(e,t){super(e,t);this.bitRatio=4,this.setShape(e)}setShape(e){let t=$e.getDimensions(e,!0);this.textureSize=$e.getMemoryOptimizedFloatTextureSize(t,this.bitRatio),this.dimensions=new Int32Array([t[1],1,1]),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0],this.textureSize[1]),this.uploadValue=new Float32Array(this.uploadArrayLength)}getStringValueHandler(){return $e.linesToString([`const uploadValue_${this.name} = new Float32Array(${this.uploadArrayLength})`,`flattenTo(${this.varName}, uploadValue_${this.name})`])}getSource(){return $e.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}let{context:t}=this;$e.flatten2dArrayTo(e,this.uploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};Vs.exports={WebGLKernelValueSingleArray1DI:Os}});var Us=p((lm,Ns)=>{var{utils:Lc}=d(),{WebGLKernelValueSingleArray1DI:kc}=Je(),Ks=class extends kc{getSource(){return Lc.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(e){this.setShape(e),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};Ns.exports={WebGLKernelValueDynamicSingleArray1DI:Ks}});var Qe=p((cm,Ps)=>{var{utils:De}=d(),{WebGLKernelArray:Oc}=N(),Gs=class extends Oc{constructor(e,t){super(e,t);this.bitRatio=4,this.setShape(e)}setShape(e){let t=De.getDimensions(e,!0);this.textureSize=De.getMemoryOptimizedFloatTextureSize(t,this.bitRatio),this.dimensions=new Int32Array([t[1],t[2],1]),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0],this.textureSize[1]),this.uploadValue=new Float32Array(this.uploadArrayLength)}getStringValueHandler(){return De.linesToString([`const uploadValue_${this.name} = new Float32Array(${this.uploadArrayLength})`,`flattenTo(${this.varName}, uploadValue_${this.name})`])}getSource(){return De.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}let{context:t}=this;De.flatten3dArrayTo(e,this.uploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};Ps.exports={WebGLKernelValueSingleArray2DI:Gs}});var js=p((hm,Bs)=>{var{utils:Vc}=d(),{WebGLKernelValueSingleArray2DI:Kc}=Qe(),qs=class extends Kc{getSource(){return Vc.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(e){this.setShape(e),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};Bs.exports={WebGLKernelValueDynamicSingleArray2DI:qs}});var et=p((pm,Xs)=>{var{utils:Ie}=d(),{WebGLKernelArray:Nc}=N(),Ws=class extends Nc{constructor(e,t){super(e,t);this.bitRatio=4,this.setShape(e)}setShape(e){let t=Ie.getDimensions(e,!0);this.textureSize=Ie.getMemoryOptimizedFloatTextureSize(t,this.bitRatio),this.dimensions=new Int32Array([t[1],t[2],t[3]]),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0],this.textureSize[1]),this.uploadValue=new Float32Array(this.uploadArrayLength)}getStringValueHandler(){return Ie.linesToString([`const uploadValue_${this.name} = new Float32Array(${this.uploadArrayLength})`,`flattenTo(${this.varName}, uploadValue_${this.name})`])}getSource(){return Ie.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}let{context:t}=this;Ie.flatten4dArrayTo(e,this.uploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};Xs.exports={WebGLKernelValueSingleArray3DI:Ws}});var Zs=p((fm,Ys)=>{var{utils:Uc}=d(),{WebGLKernelValueSingleArray3DI:Gc}=et(),Hs=class extends Gc{getSource(){return Uc.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(e){this.setShape(e),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};Ys.exports={WebGLKernelValueDynamicSingleArray3DI:Hs}});var en=p((dm,Qs)=>{var{utils:mm}=d(),{WebGLKernelValue:Pc}=re(),Js=class extends Pc{constructor(e,t){super(e,t);this.uploadValue=e}getSource(e){return this.origin==="constants"?`const vec2 ${this.id} = vec2(${e[0]},${e[1]});
`:`uniform vec2 ${this.id};
`}getStringValueHandler(){return this.origin==="constants"?"":`const uploadValue_${this.name} = ${this.varName};
`}updateValue(e){this.origin!=="constants"&&this.kernel.setUniform2fv(this.id,this.uploadValue=e)}};Qs.exports={WebGLKernelValueSingleArray2:Js}});var tn=p((xm,ta)=>{var{utils:gm}=d(),{WebGLKernelValue:qc}=re(),ea=class extends qc{constructor(e,t){super(e,t);this.uploadValue=e}getSource(e){return this.origin==="constants"?`const vec3 ${this.id} = vec3(${e[0]},${e[1]},${e[2]});
`:`uniform vec3 ${this.id};
`}getStringValueHandler(){return this.origin==="constants"?"":`const uploadValue_${this.name} = ${this.varName};
`}updateValue(e){this.origin!=="constants"&&this.kernel.setUniform3fv(this.id,this.uploadValue=e)}};ta.exports={WebGLKernelValueSingleArray3:ea}});var nn=p((Tm,ra)=>{var{utils:ym}=d(),{WebGLKernelValue:Bc}=re(),na=class extends Bc{constructor(e,t){super(e,t);this.uploadValue=e}getSource(e){return this.origin==="constants"?`const vec4 ${this.id} = vec4(${e[0]},${e[1]},${e[2]},${e[3]});
`:`uniform vec4 ${this.id};
`}getStringValueHandler(){return this.origin==="constants"?"":`const uploadValue_${this.name} = ${this.varName};
`}updateValue(e){this.origin!=="constants"&&this.kernel.setUniform4fv(this.id,this.uploadValue=e)}};ra.exports={WebGLKernelValueSingleArray4:na}});var tt=p((bm,sa)=>{var{utils:Ae}=d(),{WebGLKernelArray:jc}=N(),ia=class extends jc{constructor(e,t){super(e,t);this.bitRatio=this.getBitRatio(e),this.dimensions=Ae.getDimensions(e,!0),this.textureSize=Ae.getMemoryOptimizedPackedTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*(4/this.bitRatio),this.checkSize(this.textureSize[0],this.textureSize[1]),this.TranserArrayType=this.getTransferArrayType(e),this.preUploadValue=new this.TranserArrayType(this.uploadArrayLength),this.uploadValue=new Uint8Array(this.preUploadValue.buffer)}getStringValueHandler(){return Ae.linesToString([`const preUploadValue_${this.name} = new ${this.TranserArrayType.name}(${this.uploadArrayLength})`,`const uploadValue_${this.name} = new Uint8Array(preUploadValue_${this.name}.buffer)`,`flattenTo(${this.varName}, preUploadValue_${this.name})`])}getSource(){return Ae.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}let{context:t}=this;Ae.flattenTo(e,this.preUploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.UNSIGNED_BYTE,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};sa.exports={WebGLKernelValueUnsignedArray:ia}});var sn=p((Sm,oa)=>{var{utils:rn}=d(),{WebGLKernelValueUnsignedArray:Wc}=tt(),aa=class extends Wc{getSource(){return rn.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(e){this.dimensions=rn.getDimensions(e,!0),this.textureSize=rn.getMemoryOptimizedPackedTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*(4/this.bitRatio),this.checkSize(this.textureSize[0],this.textureSize[1]);let t=this.getTransferArrayType(e);this.preUploadValue=new t(this.uploadArrayLength),this.uploadValue=new Uint8Array(this.preUploadValue.buffer),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};oa.exports={WebGLKernelValueDynamicUnsignedArray:aa}});var pn=p((Em,ga)=>{var{WebGLKernelValueBoolean:nt}=jt(),{WebGLKernelValueFloat:rt}=Wt(),{WebGLKernelValueInteger:it}=Xt(),{WebGLKernelValueHTMLImage:st}=_e(),{WebGLKernelValueDynamicHTMLImage:at}=Be(),{WebGLKernelValueHTMLVideo:ua}=us(),{WebGLKernelValueDynamicHTMLVideo:la}=hs(),{WebGLKernelValueSingleInput:Xc}=We(),{WebGLKernelValueDynamicSingleInput:Hc}=xs(),{WebGLKernelValueUnsignedInput:Yc}=He(),{WebGLKernelValueDynamicUnsignedInput:Zc}=Ht(),{WebGLKernelValueMemoryOptimizedNumberTexture:ca}=we(),{WebGLKernelValueDynamicMemoryOptimizedNumberTexture:ha}=Zt(),{WebGLKernelValueNumberTexture:W}=Ye(),{WebGLKernelValueDynamicNumberTexture:X}=Jt(),{WebGLKernelValueSingleArray:Jc}=Ze(),{WebGLKernelValueDynamicSingleArray:Qc}=ks(),{WebGLKernelValueSingleArray1DI:an}=Je(),{WebGLKernelValueDynamicSingleArray1DI:on}=Us(),{WebGLKernelValueSingleArray2DI:un}=Qe(),{WebGLKernelValueDynamicSingleArray2DI:ln}=js(),{WebGLKernelValueSingleArray3DI:cn}=et(),{WebGLKernelValueDynamicSingleArray3DI:hn}=Zs(),{WebGLKernelValueSingleArray2:pa}=en(),{WebGLKernelValueSingleArray3:fa}=tn(),{WebGLKernelValueSingleArray4:ma}=nn(),{WebGLKernelValueUnsignedArray:eh}=tt(),{WebGLKernelValueDynamicUnsignedArray:th}=sn(),da={unsigned:{dynamic:{Boolean:nt,Integer:it,Float:rt,Array:th,"Array(2)":!1,"Array(3)":!1,"Array(4)":!1,"Array1D(2)":!1,"Array1D(3)":!1,"Array1D(4)":!1,"Array2D(2)":!1,"Array2D(3)":!1,"Array2D(4)":!1,"Array3D(2)":!1,"Array3D(3)":!1,"Array3D(4)":!1,Input:Zc,NumberTexture:X,"ArrayTexture(1)":X,"ArrayTexture(2)":X,"ArrayTexture(3)":X,"ArrayTexture(4)":X,MemoryOptimizedNumberTexture:ha,HTMLCanvas:at,HTMLImage:at,HTMLImageArray:!1,HTMLVideo:la},static:{Boolean:nt,Float:rt,Integer:it,Array:eh,"Array(2)":!1,"Array(3)":!1,"Array(4)":!1,"Array1D(2)":!1,"Array1D(3)":!1,"Array1D(4)":!1,"Array2D(2)":!1,"Array2D(3)":!1,"Array2D(4)":!1,"Array3D(2)":!1,"Array3D(3)":!1,"Array3D(4)":!1,Input:Yc,NumberTexture:W,"ArrayTexture(1)":W,"ArrayTexture(2)":W,"ArrayTexture(3)":W,"ArrayTexture(4)":W,MemoryOptimizedNumberTexture:ca,HTMLCanvas:st,HTMLImage:st,HTMLImageArray:!1,HTMLVideo:ua}},single:{dynamic:{Boolean:nt,Integer:it,Float:rt,Array:Qc,"Array(2)":pa,"Array(3)":fa,"Array(4)":ma,"Array1D(2)":on,"Array1D(3)":on,"Array1D(4)":on,"Array2D(2)":ln,"Array2D(3)":ln,"Array2D(4)":ln,"Array3D(2)":hn,"Array3D(3)":hn,"Array3D(4)":hn,Input:Hc,NumberTexture:X,"ArrayTexture(1)":X,"ArrayTexture(2)":X,"ArrayTexture(3)":X,"ArrayTexture(4)":X,MemoryOptimizedNumberTexture:ha,HTMLCanvas:at,HTMLImage:at,HTMLImageArray:!1,HTMLVideo:la},static:{Boolean:nt,Float:rt,Integer:it,Array:Jc,"Array(2)":pa,"Array(3)":fa,"Array(4)":ma,"Array1D(2)":an,"Array1D(3)":an,"Array1D(4)":an,"Array2D(2)":un,"Array2D(3)":un,"Array2D(4)":un,"Array3D(2)":cn,"Array3D(3)":cn,"Array3D(4)":cn,Input:Xc,NumberTexture:W,"ArrayTexture(1)":W,"ArrayTexture(2)":W,"ArrayTexture(3)":W,"ArrayTexture(4)":W,MemoryOptimizedNumberTexture:ca,HTMLCanvas:st,HTMLImage:st,HTMLImageArray:!1,HTMLVideo:ua}}};function nh(i,e,t,n){if(!i)throw new Error("type missing");if(!e)throw new Error("dynamic missing");if(!t)throw new Error("precision missing");n.type&&(i=n.type);let r=da[t][e];if(r[i]===!1)return null;if(r[i]===void 0)throw new Error(`Could not find a KernelValue for ${i}`);return r[i]}ga.exports={lookupKernelValueType:nh,kernelValueMaps:da}});var ze=p((_m,Sa)=>{var{GLKernel:rh}=Ot(),{FunctionBuilder:xa}=be(),{WebGLFunctionNode:ya}=Ge(),{utils:C}=d(),ih=Kt(),{fragmentShader:sh}=Oi(),{vertexShader:ah}=Ki(),{glKernelString:oh}=Bt(),{lookupKernelValueType:uh}=pn(),ot=null,he=null,U=null,Re=null,Ta=null,ut=[ih],Fe=[],fn={},ba=class extends rh{static get isSupported(){return ot!==null||(this.setupFeatureChecks(),ot=this.isContextMatch(U)),ot}static setupFeatureChecks(){typeof document!="undefined"?he=document.createElement("canvas"):typeof OffscreenCanvas!="undefined"&&(he=new OffscreenCanvas(0,0)),!!he&&(U=he.getContext("webgl")||he.getContext("experimental-webgl"),!(!U||!U.getExtension)&&(Re={OES_texture_float:U.getExtension("OES_texture_float"),OES_texture_float_linear:U.getExtension("OES_texture_float_linear"),OES_element_index_uint:U.getExtension("OES_element_index_uint"),WEBGL_draw_buffers:U.getExtension("WEBGL_draw_buffers")},Ta=this.getFeatures()))}static isContextMatch(e){return typeof WebGLRenderingContext!="undefined"?e instanceof WebGLRenderingContext:!1}static getIsTextureFloat(){return Boolean(Re.OES_texture_float)}static getIsDrawBuffers(){return Boolean(Re.WEBGL_draw_buffers)}static getChannelCount(){return Re.WEBGL_draw_buffers?U.getParameter(Re.WEBGL_draw_buffers.MAX_DRAW_BUFFERS_WEBGL):1}static getMaxTextureSize(){return U.getParameter(U.MAX_TEXTURE_SIZE)}static lookupKernelValueType(e,t,n,r){return uh(e,t,n,r)}static get testCanvas(){return he}static get testContext(){return U}static get features(){return Ta}static get fragmentShader(){return sh}static get vertexShader(){return ah}constructor(e,t){super(e,t);this.program=null,this.pipeline=t.pipeline,this.endianness=C.systemEndianness(),this.extensions={},this.argumentTextureCount=0,this.constantTextureCount=0,this.fragShader=null,this.vertShader=null,this.drawBuffersMap=null,this.maxTexSize=null,this.onRequestSwitchKernel=null,this.texture=null,this.mappedTextures=null,this.mergeSettings(e.settings||t),this.threadDim=null,this.framebuffer=null,this.buffer=null,this.textureCache=[],this.programUniformLocationCache={},this.uniform1fCache={},this.uniform1iCache={},this.uniform2fCache={},this.uniform2fvCache={},this.uniform2ivCache={},this.uniform3fvCache={},this.uniform3ivCache={},this.uniform4fvCache={},this.uniform4ivCache={}}initCanvas(){if(typeof document!="undefined"){let e=document.createElement("canvas");return e.width=2,e.height=2,e}else if(typeof OffscreenCanvas!="undefined")return new OffscreenCanvas(0,0)}initContext(){let e={alpha:!1,depth:!1,antialias:!1};return this.canvas.getContext("webgl",e)||this.canvas.getContext("experimental-webgl",e)}initPlugins(e){let t=[],{source:n}=this;if(typeof n=="string")for(let r=0;r<ut.length;r++){let s=ut[r];n.match(s.functionMatch)&&t.push(s)}else if(typeof n=="object"&&e.pluginNames)for(let r=0;r<ut.length;r++){let s=ut[r];e.pluginNames.some(o=>o===s.name)&&t.push(s)}return t}initExtensions(){this.extensions={OES_texture_float:this.context.getExtension("OES_texture_float"),OES_texture_float_linear:this.context.getExtension("OES_texture_float_linear"),OES_element_index_uint:this.context.getExtension("OES_element_index_uint"),WEBGL_draw_buffers:this.context.getExtension("WEBGL_draw_buffers"),WEBGL_color_buffer_float:this.context.getExtension("WEBGL_color_buffer_float")}}validateSettings(e){if(!this.validate){this.texSize=C.getKernelTextureSize({optimizeFloatMemory:this.optimizeFloatMemory,precision:this.precision},this.output);return}let{features:t}=this.constructor;if(this.optimizeFloatMemory===!0&&!t.isTextureFloat)throw new Error("Float textures are not supported");if(this.precision==="single"&&!t.isFloatRead)throw new Error("Single precision not supported");if(!this.graphical&&this.precision===null&&t.isTextureFloat&&(this.precision=t.isFloatRead?"single":"unsigned"),this.subKernels&&this.subKernels.length>0&&!this.extensions.WEBGL_draw_buffers)throw new Error("could not instantiate draw buffers extension");if(this.fixIntegerDivisionAccuracy===null?this.fixIntegerDivisionAccuracy=!t.isIntegerDivisionAccurate:this.fixIntegerDivisionAccuracy&&t.isIntegerDivisionAccurate&&(this.fixIntegerDivisionAccuracy=!1),this.checkOutput(),!this.output||this.output.length===0){if(e.length!==1)throw new Error("Auto output only supported for kernels with only one input");let n=C.getVariableType(e[0],this.strictIntegers);switch(n){case"Array":this.output=C.getDimensions(n);break;case"NumberTexture":case"MemoryOptimizedNumberTexture":case"ArrayTexture(1)":case"ArrayTexture(2)":case"ArrayTexture(3)":case"ArrayTexture(4)":this.output=e[0].output;break;default:throw new Error("Auto output not supported for input type: "+n)}}if(this.graphical){if(this.output.length!==2)throw new Error("Output must have 2 dimensions on graphical mode");this.precision==="precision"&&(this.precision="unsigned",console.warn("Cannot use graphical mode and single precision at the same time")),this.texSize=C.clone(this.output);return}else this.precision===null&&t.isTextureFloat&&(this.precision="single");this.texSize=C.getKernelTextureSize({optimizeFloatMemory:this.optimizeFloatMemory,precision:this.precision},this.output),this.checkTextureSize()}updateMaxTexSize(){let{texSize:e,canvas:t}=this;if(this.maxTexSize===null){let n=Fe.indexOf(t);n===-1&&(n=Fe.length,Fe.push(t),fn[n]=[e[0],e[1]]),this.maxTexSize=fn[n]}this.maxTexSize[0]<e[0]&&(this.maxTexSize[0]=e[0]),this.maxTexSize[1]<e[1]&&(this.maxTexSize[1]=e[1])}setupArguments(e){this.kernelArguments=[],this.argumentTextureCount=0;let t=this.argumentTypes===null;if(t&&(this.argumentTypes=[]),this.argumentSizes=[],this.argumentBitRatios=[],e.length<this.argumentNames.length)throw new Error("not enough arguments for kernel");if(e.length>this.argumentNames.length)throw new Error("too many arguments for kernel");let{context:n}=this,r=0,s=()=>this.createTexture(),a=()=>this.constantTextureCount+r++,o=u=>{this.switchKernels({type:"argumentMismatch",needed:u})},l=()=>n.TEXTURE0+this.constantTextureCount+this.argumentTextureCount++;for(let u=0;u<e.length;u++){let h=e[u],c=this.argumentNames[u],m;t?(m=C.getVariableType(h,this.strictIntegers),this.argumentTypes.push(m)):m=this.argumentTypes[u];let f=this.constructor.lookupKernelValueType(m,this.dynamicArguments?"dynamic":"static",this.precision,e[u]);if(f===null)return this.requestFallback(e);let g=new f(h,{name:c,type:m,tactic:this.tactic,origin:"user",context:n,checkContext:this.checkContext,kernel:this,strictIntegers:this.strictIntegers,onRequestTexture:s,onRequestIndex:a,onUpdateValueMismatch:o,onRequestContextHandle:l});this.kernelArguments.push(g),g.setup(),this.argumentSizes.push(g.textureSize),this.argumentBitRatios[u]=g.bitRatio}}createTexture(){let e=this.context.createTexture();return this.textureCache.push(e),e}setupConstants(e){let{context:t}=this;this.kernelConstants=[],this.forceUploadKernelConstants=[];let n=this.constantTypes===null;n&&(this.constantTypes={}),this.constantBitRatios={};let r=0;for(let s in this.constants){let a=this.constants[s],o;n?(o=C.getVariableType(a,this.strictIntegers),this.constantTypes[s]=o):o=this.constantTypes[s];let l=this.constructor.lookupKernelValueType(o,"static",this.precision,a);if(l===null)return this.requestFallback(e);let u=new l(a,{name:s,type:o,tactic:this.tactic,origin:"constants",context:this.context,checkContext:this.checkContext,kernel:this,strictIntegers:this.strictIntegers,onRequestTexture:()=>this.createTexture(),onRequestIndex:()=>r++,onRequestContextHandle:()=>t.TEXTURE0+this.constantTextureCount++});this.constantBitRatios[s]=u.bitRatio,this.kernelConstants.push(u),u.setup(),u.forceUploadEachRun&&this.forceUploadKernelConstants.push(u)}}build(){if(this.built||(this.initExtensions(),this.validateSettings(arguments),this.setupConstants(arguments),this.fallbackRequested)||(this.setupArguments(arguments),this.fallbackRequested))return;this.updateMaxTexSize(),this.translateSource();let e=this.pickRenderStrategy(arguments);if(e)return e;let{texSize:t,context:n,canvas:r}=this;n.enable(n.SCISSOR_TEST),this.pipeline&&this.precision==="single"?(n.viewport(0,0,this.maxTexSize[0],this.maxTexSize[1]),r.width=this.maxTexSize[0],r.height=this.maxTexSize[1]):(n.viewport(0,0,this.maxTexSize[0],this.maxTexSize[1]),r.width=this.maxTexSize[0],r.height=this.maxTexSize[1]);let s=this.threadDim=Array.from(this.output);for(;s.length<3;)s.push(1);let a=this.getVertexShader(arguments),o=n.createShader(n.VERTEX_SHADER);n.shaderSource(o,a),n.compileShader(o),this.vertShader=o;let l=this.getFragmentShader(arguments),u=n.createShader(n.FRAGMENT_SHADER);if(n.shaderSource(u,l),n.compileShader(u),this.fragShader=u,this.debug&&(console.log("GLSL Shader Output:"),console.log(l)),!n.getShaderParameter(o,n.COMPILE_STATUS))throw new Error("Error compiling vertex shader: "+n.getShaderInfoLog(o));if(!n.getShaderParameter(u,n.COMPILE_STATUS))throw new Error("Error compiling fragment shader: "+n.getShaderInfoLog(u));let h=this.program=n.createProgram();n.attachShader(h,o),n.attachShader(h,u),n.linkProgram(h),this.framebuffer=n.createFramebuffer(),this.framebuffer.width=t[0],this.framebuffer.height=t[1],this.rawValueFramebuffers={};let c=new Float32Array([-1,-1,1,-1,-1,1,1,1]),m=new Float32Array([0,0,1,0,0,1,1,1]),f=c.byteLength,g=this.buffer;g?n.bindBuffer(n.ARRAY_BUFFER,g):(g=this.buffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,g),n.bufferData(n.ARRAY_BUFFER,c.byteLength+m.byteLength,n.STATIC_DRAW)),n.bufferSubData(n.ARRAY_BUFFER,0,c),n.bufferSubData(n.ARRAY_BUFFER,f,m);let S=n.getAttribLocation(this.program,"aPos");n.enableVertexAttribArray(S),n.vertexAttribPointer(S,2,n.FLOAT,!1,0,0);let $=n.getAttribLocation(this.program,"aTexCoord");n.enableVertexAttribArray($),n.vertexAttribPointer($,2,n.FLOAT,!1,0,f),n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer);let w=0;n.useProgram(this.program);for(let v in this.constants)this.kernelConstants[w++].updateValue(this.constants[v]);this._setupOutputTexture(),this.subKernels!==null&&this.subKernels.length>0&&(this._mappedTextureSwitched={},this._setupSubOutputTextures()),this.buildSignature(arguments),this.built=!0}translateSource(){let e=xa.fromKernel(this,ya,{fixIntegerDivisionAccuracy:this.fixIntegerDivisionAccuracy});this.translatedSource=e.getPrototypeString("kernel"),this.setupReturnTypes(e)}setupReturnTypes(e){if(!this.graphical&&!this.returnType&&(this.returnType=e.getKernelResultType()),this.subKernels&&this.subKernels.length>0)for(let t=0;t<this.subKernels.length;t++){let n=this.subKernels[t];n.returnType||(n.returnType=e.getSubKernelResultType(t))}}run(){let{kernelArguments:e,texSize:t,forceUploadKernelConstants:n,context:r}=this;r.useProgram(this.program),r.scissor(0,0,t[0],t[1]),this.dynamicOutput&&(this.setUniform3iv("uOutputDim",new Int32Array(this.threadDim)),this.setUniform2iv("uTexSize",t)),this.setUniform2f("ratio",t[0]/this.maxTexSize[0],t[1]/this.maxTexSize[1]);for(let s=0;s<n.length;s++){let a=n[s];if(a.updateValue(this.constants[a.name]),this.switchingKernels)return}for(let s=0;s<e.length;s++)if(e[s].updateValue(arguments[s]),this.switchingKernels)return;if(this.plugins)for(let s=0;s<this.plugins.length;s++){let a=this.plugins[s];a.onBeforeRun&&a.onBeforeRun(this)}if(this.graphical){if(this.pipeline)return r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,this.framebuffer),this.immutable&&this._replaceOutputTexture(),r.drawArrays(r.TRIANGLE_STRIP,0,4),this.immutable?this.texture.clone():this.texture;r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null),r.drawArrays(r.TRIANGLE_STRIP,0,4);return}r.bindFramebuffer(r.FRAMEBUFFER,this.framebuffer),this.immutable&&this._replaceOutputTexture(),this.subKernels!==null&&(this.immutable&&this._replaceSubOutputTextures(),this.drawBuffers()),r.drawArrays(r.TRIANGLE_STRIP,0,4)}drawBuffers(){this.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(this.drawBuffersMap)}getInternalFormat(){return this.context.RGBA}getTextureFormat(){let{context:e}=this;switch(this.getInternalFormat()){case e.RGBA:return e.RGBA;default:throw new Error("Unknown internal format")}}_replaceOutputTexture(){if(this.texture.beforeMutate()||this._textureSwitched){let e=this.context;e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture.texture,0),this._textureSwitched=!1}}_setupOutputTexture(){let e=this.context,t=this.texSize;if(this.texture){e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture.texture,0);return}let n=this.createTexture();e.activeTexture(e.TEXTURE0+this.constantTextureCount+this.argumentTextureCount),e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);let r=this.getInternalFormat();this.precision==="single"?e.texImage2D(e.TEXTURE_2D,0,r,t[0],t[1],0,e.RGBA,e.FLOAT,null):e.texImage2D(e.TEXTURE_2D,0,r,t[0],t[1],0,r,e.UNSIGNED_BYTE,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0),this.texture=new this.TextureConstructor({texture:n,size:t,dimensions:this.threadDim,output:this.output,context:this.context,internalFormat:this.getInternalFormat(),textureFormat:this.getTextureFormat(),kernel:this})}_replaceSubOutputTextures(){let e=this.context;for(let t=0;t<this.mappedTextures.length;t++){let n=this.mappedTextures[t];(n.beforeMutate()||this._mappedTextureSwitched[t])&&(e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t+1,e.TEXTURE_2D,n.texture,0),this._mappedTextureSwitched[t]=!1)}}_setupSubOutputTextures(){let e=this.context;if(this.mappedTextures){for(let n=0;n<this.subKernels.length;n++)e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n+1,e.TEXTURE_2D,this.mappedTextures[n].texture,0);return}let t=this.texSize;this.drawBuffersMap=[e.COLOR_ATTACHMENT0],this.mappedTextures=[];for(let n=0;n<this.subKernels.length;n++){let r=this.createTexture();this.drawBuffersMap.push(e.COLOR_ATTACHMENT0+n+1),e.activeTexture(e.TEXTURE0+this.constantTextureCount+this.argumentTextureCount+n),e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),this.precision==="single"?e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t[0],t[1],0,e.RGBA,e.FLOAT,null):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t[0],t[1],0,e.RGBA,e.UNSIGNED_BYTE,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n+1,e.TEXTURE_2D,r,0),this.mappedTextures.push(new this.TextureConstructor({texture:r,size:t,dimensions:this.threadDim,output:this.output,context:this.context,internalFormat:this.getInternalFormat(),textureFormat:this.getTextureFormat(),kernel:this}))}}setUniform1f(e,t){if(this.uniform1fCache.hasOwnProperty(e)){let r=this.uniform1fCache[e];if(t===r)return}this.uniform1fCache[e]=t;let n=this.getUniformLocation(e);this.context.uniform1f(n,t)}setUniform1i(e,t){if(this.uniform1iCache.hasOwnProperty(e)){let r=this.uniform1iCache[e];if(t===r)return}this.uniform1iCache[e]=t;let n=this.getUniformLocation(e);this.context.uniform1i(n,t)}setUniform2f(e,t,n){if(this.uniform2fCache.hasOwnProperty(e)){let s=this.uniform2fCache[e];if(t===s[0]&&n===s[1])return}this.uniform2fCache[e]=[t,n];let r=this.getUniformLocation(e);this.context.uniform2f(r,t,n)}setUniform2fv(e,t){if(this.uniform2fvCache.hasOwnProperty(e)){let r=this.uniform2fvCache[e];if(t[0]===r[0]&&t[1]===r[1])return}this.uniform2fvCache[e]=t;let n=this.getUniformLocation(e);this.context.uniform2fv(n,t)}setUniform2iv(e,t){if(this.uniform2ivCache.hasOwnProperty(e)){let r=this.uniform2ivCache[e];if(t[0]===r[0]&&t[1]===r[1])return}this.uniform2ivCache[e]=t;let n=this.getUniformLocation(e);this.context.uniform2iv(n,t)}setUniform3fv(e,t){if(this.uniform3fvCache.hasOwnProperty(e)){let r=this.uniform3fvCache[e];if(t[0]===r[0]&&t[1]===r[1]&&t[2]===r[2])return}this.uniform3fvCache[e]=t;let n=this.getUniformLocation(e);this.context.uniform3fv(n,t)}setUniform3iv(e,t){if(this.uniform3ivCache.hasOwnProperty(e)){let r=this.uniform3ivCache[e];if(t[0]===r[0]&&t[1]===r[1]&&t[2]===r[2])return}this.uniform3ivCache[e]=t;let n=this.getUniformLocation(e);this.context.uniform3iv(n,t)}setUniform4fv(e,t){if(this.uniform4fvCache.hasOwnProperty(e)){let r=this.uniform4fvCache[e];if(t[0]===r[0]&&t[1]===r[1]&&t[2]===r[2]&&t[3]===r[3])return}this.uniform4fvCache[e]=t;let n=this.getUniformLocation(e);this.context.uniform4fv(n,t)}setUniform4iv(e,t){if(this.uniform4ivCache.hasOwnProperty(e)){let r=this.uniform4ivCache[e];if(t[0]===r[0]&&t[1]===r[1]&&t[2]===r[2]&&t[3]===r[3])return}this.uniform4ivCache[e]=t;let n=this.getUniformLocation(e);this.context.uniform4iv(n,t)}getUniformLocation(e){return this.programUniformLocationCache.hasOwnProperty(e)?this.programUniformLocationCache[e]:this.programUniformLocationCache[e]=this.context.getUniformLocation(this.program,e)}_getFragShaderArtifactMap(e){return{HEADER:this._getHeaderString(),LOOP_MAX:this._getLoopMaxString(),PLUGINS:this._getPluginsString(),CONSTANTS:this._getConstantsString(),DECODE32_ENDIANNESS:this._getDecode32EndiannessString(),ENCODE32_ENDIANNESS:this._getEncode32EndiannessString(),DIVIDE_WITH_INTEGER_CHECK:this._getDivideWithIntegerCheckString(),INJECTED_NATIVE:this._getInjectedNative(),MAIN_CONSTANTS:this._getMainConstantsString(),MAIN_ARGUMENTS:this._getMainArgumentsString(e),KERNEL:this.getKernelString(),MAIN_RESULT:this.getMainResultString(),FLOAT_TACTIC_DECLARATION:this.getFloatTacticDeclaration(),INT_TACTIC_DECLARATION:this.getIntTacticDeclaration(),SAMPLER_2D_TACTIC_DECLARATION:this.getSampler2DTacticDeclaration(),SAMPLER_2D_ARRAY_TACTIC_DECLARATION:this.getSampler2DArrayTacticDeclaration()}}_getVertShaderArtifactMap(e){return{FLOAT_TACTIC_DECLARATION:this.getFloatTacticDeclaration(),INT_TACTIC_DECLARATION:this.getIntTacticDeclaration(),SAMPLER_2D_TACTIC_DECLARATION:this.getSampler2DTacticDeclaration(),SAMPLER_2D_ARRAY_TACTIC_DECLARATION:this.getSampler2DArrayTacticDeclaration()}}_getHeaderString(){return this.subKernels!==null?`#extension GL_EXT_draw_buffers : require
`:""}_getLoopMaxString(){return this.loopMaxIterations?` ${parseInt(this.loopMaxIterations)};
`:` 1000;
`}_getPluginsString(){return this.plugins?this.plugins.map(e=>e.source&&this.source.match(e.functionMatch)?e.source:"").join(`
`):`
`}_getConstantsString(){let e=[],{threadDim:t,texSize:n}=this;return this.dynamicOutput?e.push("uniform ivec3 uOutputDim","uniform ivec2 uTexSize"):e.push(`ivec3 uOutputDim = ivec3(${t[0]}, ${t[1]}, ${t[2]})`,`ivec2 uTexSize = ivec2(${n[0]}, ${n[1]})`),C.linesToString(e)}_getTextureCoordinate(){let e=this.subKernels;return e===null||e.length<1?`varying vec2 vTexCoord;
`:`out vec2 vTexCoord;
`}_getDecode32EndiannessString(){return this.endianness==="LE"?"":`  texel.rgba = texel.abgr;
`}_getEncode32EndiannessString(){return this.endianness==="LE"?"":`  texel.rgba = texel.abgr;
`}_getDivideWithIntegerCheckString(){return this.fixIntegerDivisionAccuracy?`float divWithIntCheck(float x, float y) {
  if (floor(x) == x && floor(y) == y && integerMod(x, y) == 0.0) {
    return float(int(x) / int(y));
  }
  return x / y;
}

float integerCorrectionModulo(float number, float divisor) {
  if (number < 0.0) {
    number = abs(number);
    if (divisor < 0.0) {
      divisor = abs(divisor);
    }
    return -(number - (divisor * floor(divWithIntCheck(number, divisor))));
  }
  if (divisor < 0.0) {
    divisor = abs(divisor);
  }
  return number - (divisor * floor(divWithIntCheck(number, divisor)));
}`:""}_getMainArgumentsString(e){let t=[],{argumentNames:n}=this;for(let r=0;r<n.length;r++)t.push(this.kernelArguments[r].getSource(e[r]));return t.join("")}_getInjectedNative(){return this.injectedNative||""}_getMainConstantsString(){let e=[],{constants:t}=this;if(t){let n=0;for(let r in t)!this.constants.hasOwnProperty(r)||e.push(this.kernelConstants[n++].getSource(this.constants[r]))}return e.join("")}getRawValueFramebuffer(e,t){if(this.rawValueFramebuffers[e]||(this.rawValueFramebuffers[e]={}),!this.rawValueFramebuffers[e][t]){let n=this.context.createFramebuffer();n.width=e,n.height=t,this.rawValueFramebuffers[e][t]=n}return this.rawValueFramebuffers[e][t]}getKernelResultDeclaration(){switch(this.returnType){case"Array(2)":return"vec2 kernelResult";case"Array(3)":return"vec3 kernelResult";case"Array(4)":return"vec4 kernelResult";case"LiteralInteger":case"Float":case"Number":case"Integer":return"float kernelResult";default:if(this.graphical)return"float kernelResult";throw new Error(`unrecognized output type "${this.returnType}"`)}}getKernelString(){let e=[this.getKernelResultDeclaration()],{subKernels:t}=this;if(t!==null)switch(this.returnType){case"Number":case"Float":case"Integer":for(let n=0;n<t.length;n++){let r=t[n];e.push(r.returnType==="Integer"?`int subKernelResult_${r.name} = 0`:`float subKernelResult_${r.name} = 0.0`)}break;case"Array(2)":for(let n=0;n<t.length;n++)e.push(`vec2 subKernelResult_${t[n].name}`);break;case"Array(3)":for(let n=0;n<t.length;n++)e.push(`vec3 subKernelResult_${t[n].name}`);break;case"Array(4)":for(let n=0;n<t.length;n++)e.push(`vec4 subKernelResult_${t[n].name}`);break}return C.linesToString(e)+this.translatedSource}getMainResultGraphical(){return C.linesToString(["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  gl_FragColor = actualColor"])}getMainResultPackedPixels(){switch(this.returnType){case"LiteralInteger":case"Number":case"Integer":case"Float":return this.getMainResultKernelPackedPixels()+this.getMainResultSubKernelPackedPixels();default:throw new Error(`packed output only usable with Numbers, "${this.returnType}" specified`)}}getMainResultKernelPackedPixels(){return C.linesToString(["  threadId = indexTo3D(index, uOutputDim)","  kernel()",`  gl_FragData[0] = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(kernelResult)`])}getMainResultSubKernelPackedPixels(){let e=[];if(!this.subKernels)return"";for(let t=0;t<this.subKernels.length;t++)this.subKernels[t].returnType==="Integer"?e.push(`  gl_FragData[${t+1}] = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(float(subKernelResult_${this.subKernels[t].name}))`):e.push(`  gl_FragData[${t+1}] = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(subKernelResult_${this.subKernels[t].name})`);return C.linesToString(e)}getMainResultMemoryOptimizedFloats(){let e=["  index *= 4"];switch(this.returnType){case"Number":case"Integer":case"Float":let t=["r","g","b","a"];for(let n=0;n<t.length;n++){let r=t[n];this.getMainResultKernelMemoryOptimizedFloats(e,r),this.getMainResultSubKernelMemoryOptimizedFloats(e,r),n+1<t.length&&e.push("  index += 1")}break;default:throw new Error(`optimized output only usable with Numbers, ${this.returnType} specified`)}return C.linesToString(e)}getMainResultKernelMemoryOptimizedFloats(e,t){e.push("  threadId = indexTo3D(index, uOutputDim)","  kernel()",`  gl_FragData[0].${t} = kernelResult`)}getMainResultSubKernelMemoryOptimizedFloats(e,t){if(!this.subKernels)return e;for(let n=0;n<this.subKernels.length;n++)this.subKernels[n].returnType==="Integer"?e.push(`  gl_FragData[${n+1}].${t} = float(subKernelResult_${this.subKernels[n].name})`):e.push(`  gl_FragData[${n+1}].${t} = subKernelResult_${this.subKernels[n].name}`)}getMainResultKernelNumberTexture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  gl_FragData[0][0] = kernelResult"]}getMainResultSubKernelNumberTexture(){let e=[];if(!this.subKernels)return e;for(let t=0;t<this.subKernels.length;++t){let n=this.subKernels[t];n.returnType==="Integer"?e.push(`  gl_FragData[${t+1}][0] = float(subKernelResult_${n.name})`):e.push(`  gl_FragData[${t+1}][0] = subKernelResult_${n.name}`)}return e}getMainResultKernelArray2Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  gl_FragData[0][0] = kernelResult[0]","  gl_FragData[0][1] = kernelResult[1]"]}getMainResultSubKernelArray2Texture(){let e=[];if(!this.subKernels)return e;for(let t=0;t<this.subKernels.length;++t)e.push(`  gl_FragData[${t+1}][0] = subKernelResult_${this.subKernels[t].name}[0]`,`  gl_FragData[${t+1}][1] = subKernelResult_${this.subKernels[t].name}[1]`);return e}getMainResultKernelArray3Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  gl_FragData[0][0] = kernelResult[0]","  gl_FragData[0][1] = kernelResult[1]","  gl_FragData[0][2] = kernelResult[2]"]}getMainResultSubKernelArray3Texture(){let e=[];if(!this.subKernels)return e;for(let t=0;t<this.subKernels.length;++t)e.push(`  gl_FragData[${t+1}][0] = subKernelResult_${this.subKernels[t].name}[0]`,`  gl_FragData[${t+1}][1] = subKernelResult_${this.subKernels[t].name}[1]`,`  gl_FragData[${t+1}][2] = subKernelResult_${this.subKernels[t].name}[2]`);return e}getMainResultKernelArray4Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  gl_FragData[0] = kernelResult"]}getMainResultSubKernelArray4Texture(){let e=[];if(!this.subKernels)return e;switch(this.returnType){case"Number":case"Float":case"Integer":for(let t=0;t<this.subKernels.length;++t)this.subKernels[t].returnType==="Integer"?e.push(`  gl_FragData[${t+1}] = float(subKernelResult_${this.subKernels[t].name})`):e.push(`  gl_FragData[${t+1}] = subKernelResult_${this.subKernels[t].name}`);break;case"Array(2)":for(let t=0;t<this.subKernels.length;++t)e.push(`  gl_FragData[${t+1}][0] = subKernelResult_${this.subKernels[t].name}[0]`,`  gl_FragData[${t+1}][1] = subKernelResult_${this.subKernels[t].name}[1]`);break;case"Array(3)":for(let t=0;t<this.subKernels.length;++t)e.push(`  gl_FragData[${t+1}][0] = subKernelResult_${this.subKernels[t].name}[0]`,`  gl_FragData[${t+1}][1] = subKernelResult_${this.subKernels[t].name}[1]`,`  gl_FragData[${t+1}][2] = subKernelResult_${this.subKernels[t].name}[2]`);break;case"Array(4)":for(let t=0;t<this.subKernels.length;++t)e.push(`  gl_FragData[${t+1}][0] = subKernelResult_${this.subKernels[t].name}[0]`,`  gl_FragData[${t+1}][1] = subKernelResult_${this.subKernels[t].name}[1]`,`  gl_FragData[${t+1}][2] = subKernelResult_${this.subKernels[t].name}[2]`,`  gl_FragData[${t+1}][3] = subKernelResult_${this.subKernels[t].name}[3]`);break}return e}replaceArtifacts(e,t){return e.replace(/[ ]*__([A-Z]+[0-9]*([_]?[A-Z]*[0-9]?)*)__;\n/g,(n,r)=>{if(t.hasOwnProperty(r))return t[r];throw`unhandled artifact ${r}`})}getFragmentShader(e){return this.compiledFragmentShader!==null?this.compiledFragmentShader:this.compiledFragmentShader=this.replaceArtifacts(this.constructor.fragmentShader,this._getFragShaderArtifactMap(e))}getVertexShader(e){return this.compiledVertexShader!==null?this.compiledVertexShader:this.compiledVertexShader=this.replaceArtifacts(this.constructor.vertexShader,this._getVertShaderArtifactMap(e))}toString(){let e=C.linesToString(["const gl = context"]);return oh(this.constructor,arguments,this,e)}destroy(e){if(!this.context)return;this.buffer&&this.context.deleteBuffer(this.buffer),this.framebuffer&&this.context.deleteFramebuffer(this.framebuffer);for(let n in this.rawValueFramebuffers){for(let r in this.rawValueFramebuffers[n])this.context.deleteFramebuffer(this.rawValueFramebuffers[n][r]),delete this.rawValueFramebuffers[n][r];delete this.rawValueFramebuffers[n]}if(this.vertShader&&this.context.deleteShader(this.vertShader),this.fragShader&&this.context.deleteShader(this.fragShader),this.program&&this.context.deleteProgram(this.program),this.texture){this.texture.delete();let n=this.textureCache.indexOf(this.texture.texture);n>-1&&this.textureCache.splice(n,1),this.texture=null}if(this.mappedTextures&&this.mappedTextures.length){for(let n=0;n<this.mappedTextures.length;n++){let r=this.mappedTextures[n];r.delete();let s=this.textureCache.indexOf(r.texture);s>-1&&this.textureCache.splice(s,1)}this.mappedTextures=null}if(this.kernelArguments)for(let n=0;n<this.kernelArguments.length;n++)this.kernelArguments[n].destroy();if(this.kernelConstants)for(let n=0;n<this.kernelConstants.length;n++)this.kernelConstants[n].destroy();for(;this.textureCache.length>0;){let n=this.textureCache.pop();this.context.deleteTexture(n)}if(e){let n=Fe.indexOf(this.canvas);n>=0&&(Fe[n]=null,fn[n]=null)}if(this.destroyExtensions(),delete this.context,delete this.canvas,!this.gpu)return;let t=this.gpu.kernels.indexOf(this);t!==-1&&this.gpu.kernels.splice(t,1)}destroyExtensions(){this.extensions.OES_texture_float=null,this.extensions.OES_texture_float_linear=null,this.extensions.OES_element_index_uint=null,this.extensions.WEBGL_draw_buffers=null}static destroyContext(e){let t=e.getExtension("WEBGL_lose_context");t&&t.loseContext()}toJSON(){let e=super.toJSON();return e.functionNodes=xa.fromKernel(this,ya).toJSON(),e.settings.threadDim=this.threadDim,e}};Sa.exports={WebGLKernel:ba}});var dn=p((wm,va)=>{var mn=xr(),{WebGLKernel:lh}=ze(),{glKernelString:ch}=Bt(),lt=null,Ea=null,M=null,pe=null,_a=null,wa=class extends lh{static get isSupported(){return lt!==null||(this.setupFeatureChecks(),lt=M!==null),lt}static setupFeatureChecks(){if(Ea=null,pe=null,typeof mn=="function")try{if(M=mn(2,2,{preserveDrawingBuffer:!0}),!M||!M.getExtension)return;pe={STACKGL_resize_drawingbuffer:M.getExtension("STACKGL_resize_drawingbuffer"),STACKGL_destroy_context:M.getExtension("STACKGL_destroy_context"),OES_texture_float:M.getExtension("OES_texture_float"),OES_texture_float_linear:M.getExtension("OES_texture_float_linear"),OES_element_index_uint:M.getExtension("OES_element_index_uint"),WEBGL_draw_buffers:M.getExtension("WEBGL_draw_buffers"),WEBGL_color_buffer_float:M.getExtension("WEBGL_color_buffer_float")},_a=this.getFeatures()}catch(e){console.warn(e)}}static isContextMatch(e){try{return e.getParameter(e.RENDERER)==="ANGLE"}catch(t){return!1}}static getIsTextureFloat(){return Boolean(pe.OES_texture_float)}static getIsDrawBuffers(){return Boolean(pe.WEBGL_draw_buffers)}static getChannelCount(){return pe.WEBGL_draw_buffers?M.getParameter(pe.WEBGL_draw_buffers.MAX_DRAW_BUFFERS_WEBGL):1}static getMaxTextureSize(){return M.getParameter(M.MAX_TEXTURE_SIZE)}static get testCanvas(){return Ea}static get testContext(){return M}static get features(){return _a}initCanvas(){return{}}initContext(){return mn(2,2,{preserveDrawingBuffer:!0})}initExtensions(){this.extensions={STACKGL_resize_drawingbuffer:this.context.getExtension("STACKGL_resize_drawingbuffer"),STACKGL_destroy_context:this.context.getExtension("STACKGL_destroy_context"),OES_texture_float:this.context.getExtension("OES_texture_float"),OES_texture_float_linear:this.context.getExtension("OES_texture_float_linear"),OES_element_index_uint:this.context.getExtension("OES_element_index_uint"),WEBGL_draw_buffers:this.context.getExtension("WEBGL_draw_buffers")}}build(){super.build.apply(this,arguments),this.fallbackRequested||this.extensions.STACKGL_resize_drawingbuffer.resize(this.maxTexSize[0],this.maxTexSize[1])}destroyExtensions(){this.extensions.STACKGL_resize_drawingbuffer=null,this.extensions.STACKGL_destroy_context=null,this.extensions.OES_texture_float=null,this.extensions.OES_texture_float_linear=null,this.extensions.OES_element_index_uint=null,this.extensions.WEBGL_draw_buffers=null}static destroyContext(e){let t=e.getExtension("STACKGL_destroy_context");t&&t.destroy&&t.destroy()}toString(){let e=`const gl = context || require('gl')(1, 1);
`,t=`    if (!context) { gl.getExtension('STACKGL_destroy_context').destroy(); }
`;return ch(this.constructor,arguments,this,e,t)}setOutput(e){return super.setOutput(e),this.graphical&&this.extensions.STACKGL_resize_drawingbuffer&&this.extensions.STACKGL_resize_drawingbuffer.resize(this.maxTexSize[0],this.maxTexSize[1]),this}};va.exports={HeadlessGLKernel:wa}});var gn=p((vm,Da)=>{var{utils:hh}=d(),{WebGLFunctionNode:ph}=Ge(),$a=class extends ph{astIdentifierExpression(e,t){if(e.type!=="Identifier")throw this.astErrorOutput("IdentifierExpression - not an Identifier",e);let n=this.getType(e),r=hh.sanitizeName(e.name);return e.name==="Infinity"?t.push("intBitsToFloat(2139095039)"):n==="Boolean"?this.argumentNames.indexOf(r)>-1?t.push(`bool(user_${r})`):t.push(`user_${r}`):t.push(`user_${r}`),t}};Da.exports={WebGL2FunctionNode:$a}});var Aa=p(($m,Ia)=>{var fh=`#version 300 es
__HEADER__;
__FLOAT_TACTIC_DECLARATION__;
__INT_TACTIC_DECLARATION__;
__SAMPLER_2D_TACTIC_DECLARATION__;
__SAMPLER_2D_ARRAY_TACTIC_DECLARATION__;

const int LOOP_MAX = __LOOP_MAX__;

__PLUGINS__;
__CONSTANTS__;

in vec2 vTexCoord;

float atan2(float v1, float v2) {
  if (v1 == 0.0 || v2 == 0.0) return 0.0;
  return atan(v1 / v2);
}

float cbrt(float x) {
  if (x >= 0.0) {
    return pow(x, 1.0 / 3.0);
  } else {
    return -pow(x, 1.0 / 3.0);
  }
}

float expm1(float x) {
  return pow(${Math.E}, x) - 1.0; 
}

float fround(highp float x) {
  return x;
}

float imul(float v1, float v2) {
  return float(int(v1) * int(v2));
}

float log10(float x) {
  return log2(x) * (1.0 / log2(10.0));
}

float log1p(float x) {
  return log(1.0 + x);
}

float _pow(float v1, float v2) {
  if (v2 == 0.0) return 1.0;
  return pow(v1, v2);
}

float _round(float x) {
  return floor(x + 0.5);
}


const int BIT_COUNT = 32;
int modi(int x, int y) {
  return x - y * (x / y);
}

int bitwiseOr(int a, int b) {
  int result = 0;
  int n = 1;
  
  for (int i = 0; i < BIT_COUNT; i++) {
    if ((modi(a, 2) == 1) || (modi(b, 2) == 1)) {
      result += n;
    }
    a = a / 2;
    b = b / 2;
    n = n * 2;
    if(!(a > 0 || b > 0)) {
      break;
    }
  }
  return result;
}
int bitwiseXOR(int a, int b) {
  int result = 0;
  int n = 1;
  
  for (int i = 0; i < BIT_COUNT; i++) {
    if ((modi(a, 2) == 1) != (modi(b, 2) == 1)) {
      result += n;
    }
    a = a / 2;
    b = b / 2;
    n = n * 2;
    if(!(a > 0 || b > 0)) {
      break;
    }
  }
  return result;
}
int bitwiseAnd(int a, int b) {
  int result = 0;
  int n = 1;
  for (int i = 0; i < BIT_COUNT; i++) {
    if ((modi(a, 2) == 1) && (modi(b, 2) == 1)) {
      result += n;
    }
    a = a / 2;
    b = b / 2;
    n = n * 2;
    if(!(a > 0 && b > 0)) {
      break;
    }
  }
  return result;
}
int bitwiseNot(int a) {
  int result = 0;
  int n = 1;
  
  for (int i = 0; i < BIT_COUNT; i++) {
    if (modi(a, 2) == 0) {
      result += n;    
    }
    a = a / 2;
    n = n * 2;
  }
  return result;
}
int bitwiseZeroFillLeftShift(int n, int shift) {
  int maxBytes = BIT_COUNT;
  for (int i = 0; i < BIT_COUNT; i++) {
    if (maxBytes >= n) {
      break;
    }
    maxBytes *= 2;
  }
  for (int i = 0; i < BIT_COUNT; i++) {
    if (i >= shift) {
      break;
    }
    n *= 2;
  }

  int result = 0;
  int byteVal = 1;
  for (int i = 0; i < BIT_COUNT; i++) {
    if (i >= maxBytes) break;
    if (modi(n, 2) > 0) { result += byteVal; }
    n = int(n / 2);
    byteVal *= 2;
  }
  return result;
}

int bitwiseSignedRightShift(int num, int shifts) {
  return int(floor(float(num) / pow(2.0, float(shifts))));
}

int bitwiseZeroFillRightShift(int n, int shift) {
  int maxBytes = BIT_COUNT;
  for (int i = 0; i < BIT_COUNT; i++) {
    if (maxBytes >= n) {
      break;
    }
    maxBytes *= 2;
  }
  for (int i = 0; i < BIT_COUNT; i++) {
    if (i >= shift) {
      break;
    }
    n /= 2;
  }
  int result = 0;
  int byteVal = 1;
  for (int i = 0; i < BIT_COUNT; i++) {
    if (i >= maxBytes) break;
    if (modi(n, 2) > 0) { result += byteVal; }
    n = int(n / 2);
    byteVal *= 2;
  }
  return result;
}

vec2 integerMod(vec2 x, float y) {
  vec2 res = floor(mod(x, y));
  return res * step(1.0 - floor(y), -res);
}

vec3 integerMod(vec3 x, float y) {
  vec3 res = floor(mod(x, y));
  return res * step(1.0 - floor(y), -res);
}

vec4 integerMod(vec4 x, vec4 y) {
  vec4 res = floor(mod(x, y));
  return res * step(1.0 - floor(y), -res);
}

float integerMod(float x, float y) {
  float res = floor(mod(x, y));
  return res * (res > floor(y) - 1.0 ? 0.0 : 1.0);
}

int integerMod(int x, int y) {
  return x - (y * int(x/y));
}

__DIVIDE_WITH_INTEGER_CHECK__;

// Here be dragons!
// DO NOT OPTIMIZE THIS CODE
// YOU WILL BREAK SOMETHING ON SOMEBODY'S MACHINE
// LEAVE IT AS IT IS, LEST YOU WASTE YOUR OWN TIME
const vec2 MAGIC_VEC = vec2(1.0, -256.0);
const vec4 SCALE_FACTOR = vec4(1.0, 256.0, 65536.0, 0.0);
const vec4 SCALE_FACTOR_INV = vec4(1.0, 0.00390625, 0.0000152587890625, 0.0); // 1, 1/256, 1/65536
float decode32(vec4 texel) {
  __DECODE32_ENDIANNESS__;
  texel *= 255.0;
  vec2 gte128;
  gte128.x = texel.b >= 128.0 ? 1.0 : 0.0;
  gte128.y = texel.a >= 128.0 ? 1.0 : 0.0;
  float exponent = 2.0 * texel.a - 127.0 + dot(gte128, MAGIC_VEC);
  float res = exp2(round(exponent));
  texel.b = texel.b - 128.0 * gte128.x;
  res = dot(texel, SCALE_FACTOR) * exp2(round(exponent-23.0)) + res;
  res *= gte128.y * -2.0 + 1.0;
  return res;
}

float decode16(vec4 texel, int index) {
  int channel = integerMod(index, 2);
  return texel[channel*2] * 255.0 + texel[channel*2 + 1] * 65280.0;
}

float decode8(vec4 texel, int index) {
  int channel = integerMod(index, 4);
  return texel[channel] * 255.0;
}

vec4 legacyEncode32(float f) {
  float F = abs(f);
  float sign = f < 0.0 ? 1.0 : 0.0;
  float exponent = floor(log2(F));
  float mantissa = (exp2(-exponent) * F);
  // exponent += floor(log2(mantissa));
  vec4 texel = vec4(F * exp2(23.0-exponent)) * SCALE_FACTOR_INV;
  texel.rg = integerMod(texel.rg, 256.0);
  texel.b = integerMod(texel.b, 128.0);
  texel.a = exponent*0.5 + 63.5;
  texel.ba += vec2(integerMod(exponent+127.0, 2.0), sign) * 128.0;
  texel = floor(texel);
  texel *= 0.003921569; // 1/255
  __ENCODE32_ENDIANNESS__;
  return texel;
}

// https://github.com/gpujs/gpu.js/wiki/Encoder-details
vec4 encode32(float value) {
  if (value == 0.0) return vec4(0, 0, 0, 0);

  float exponent;
  float mantissa;
  vec4  result;
  float sgn;

  sgn = step(0.0, -value);
  value = abs(value);

  exponent = floor(log2(value));

  mantissa = value*pow(2.0, -exponent)-1.0;
  exponent = exponent+127.0;
  result   = vec4(0,0,0,0);

  result.a = floor(exponent/2.0);
  exponent = exponent - result.a*2.0;
  result.a = result.a + 128.0*sgn;

  result.b = floor(mantissa * 128.0);
  mantissa = mantissa - result.b / 128.0;
  result.b = result.b + exponent*128.0;

  result.g = floor(mantissa*32768.0);
  mantissa = mantissa - result.g/32768.0;

  result.r = floor(mantissa*8388608.0);
  return result/255.0;
}
// Dragons end here

int index;
ivec3 threadId;

ivec3 indexTo3D(int idx, ivec3 texDim) {
  int z = int(idx / (texDim.x * texDim.y));
  idx -= z * int(texDim.x * texDim.y);
  int y = int(idx / texDim.x);
  int x = int(integerMod(idx, texDim.x));
  return ivec3(x, y, z);
}

float get32(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + texDim.x * (y + texDim.y * z);
  int w = texSize.x;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  vec4 texel = texture(tex, st / vec2(texSize));
  return decode32(texel);
}

float get16(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + (texDim.x * (y + (texDim.y * z)));
  int w = texSize.x * 2;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  vec4 texel = texture(tex, st / vec2(texSize.x * 2, texSize.y));
  return decode16(texel, index);
}

float get8(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + (texDim.x * (y + (texDim.y * z)));
  int w = texSize.x * 4;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  vec4 texel = texture(tex, st / vec2(texSize.x * 4, texSize.y));
  return decode8(texel, index);
}

float getMemoryOptimized32(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + (texDim.x * (y + (texDim.y * z)));
  int channel = integerMod(index, 4);
  index = index / 4;
  int w = texSize.x;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  index = index / 4;
  vec4 texel = texture(tex, st / vec2(texSize));
  return texel[channel];
}

vec4 getImage2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + texDim.x * (y + texDim.y * z);
  int w = texSize.x;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  return texture(tex, st / vec2(texSize));
}

vec4 getImage3D(sampler2DArray tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + texDim.x * (y + texDim.y * z);
  int w = texSize.x;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  return texture(tex, vec3(st / vec2(texSize), z));
}

float getFloatFromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);
  return result[0];
}

vec2 getVec2FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);
  return vec2(result[0], result[1]);
}

vec2 getMemoryOptimizedVec2(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + texDim.x * (y + texDim.y * z);
  int channel = integerMod(index, 2);
  index = index / 2;
  int w = texSize.x;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  vec4 texel = texture(tex, st / vec2(texSize));
  if (channel == 0) return vec2(texel.r, texel.g);
  if (channel == 1) return vec2(texel.b, texel.a);
  return vec2(0.0, 0.0);
}

vec3 getVec3FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);
  return vec3(result[0], result[1], result[2]);
}

vec3 getMemoryOptimizedVec3(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int fieldIndex = 3 * (x + texDim.x * (y + texDim.y * z));
  int vectorIndex = fieldIndex / 4;
  int vectorOffset = fieldIndex - vectorIndex * 4;
  int readY = vectorIndex / texSize.x;
  int readX = vectorIndex - readY * texSize.x;
  vec4 tex1 = texture(tex, (vec2(readX, readY) + 0.5) / vec2(texSize));

  if (vectorOffset == 0) {
    return tex1.xyz;
  } else if (vectorOffset == 1) {
    return tex1.yzw;
  } else {
    readX++;
    if (readX >= texSize.x) {
      readX = 0;
      readY++;
    }
    vec4 tex2 = texture(tex, vec2(readX, readY) / vec2(texSize));
    if (vectorOffset == 2) {
      return vec3(tex1.z, tex1.w, tex2.x);
    } else {
      return vec3(tex1.w, tex2.x, tex2.y);
    }
  }
}

vec4 getVec4FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  return getImage2D(tex, texSize, texDim, z, y, x);
}

vec4 getMemoryOptimizedVec4(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {
  int index = x + texDim.x * (y + texDim.y * z);
  int channel = integerMod(index, 2);
  int w = texSize.x;
  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;
  vec4 texel = texture(tex, st / vec2(texSize));
  return vec4(texel.r, texel.g, texel.b, texel.a);
}

vec4 actualColor;
void color(float r, float g, float b, float a) {
  actualColor = vec4(r,g,b,a);
}

void color(float r, float g, float b) {
  color(r,g,b,1.0);
}

float modulo(float number, float divisor) {
  if (number < 0.0) {
    number = abs(number);
    if (divisor < 0.0) {
      divisor = abs(divisor);
    }
    return -mod(number, divisor);
  }
  if (divisor < 0.0) {
    divisor = abs(divisor);
  }
  return mod(number, divisor);
}

__INJECTED_NATIVE__;
__MAIN_CONSTANTS__;
__MAIN_ARGUMENTS__;
__KERNEL__;

void main(void) {
  index = int(vTexCoord.s * float(uTexSize.x)) + int(vTexCoord.t * float(uTexSize.y)) * uTexSize.x;
  __MAIN_RESULT__;
}`;Ia.exports={fragmentShader:fh}});var Fa=p((Dm,Ra)=>{var mh=`#version 300 es
__FLOAT_TACTIC_DECLARATION__;
__INT_TACTIC_DECLARATION__;
__SAMPLER_2D_TACTIC_DECLARATION__;

in vec2 aPos;
in vec2 aTexCoord;

out vec2 vTexCoord;
uniform vec2 ratio;

void main(void) {
  gl_Position = vec4((aPos + vec2(1)) * ratio + vec2(-1), 0, 1);
  vTexCoord = aTexCoord;
}`;Ra.exports={vertexShader:mh}});var Ma=p((Im,Ca)=>{var{WebGLKernelValueBoolean:dh}=jt(),za=class extends dh{};Ca.exports={WebGL2KernelValueBoolean:za}});var Oa=p((Rm,ka)=>{var{utils:Am}=d(),{WebGLKernelValueFloat:gh}=Wt(),La=class extends gh{};ka.exports={WebGL2KernelValueFloat:La}});var Na=p((Fm,Ka)=>{var{WebGLKernelValueInteger:xh}=Xt(),Va=class extends xh{getSource(e){let t=this.getVariablePrecisionString();return this.origin==="constants"?`const ${t} int ${this.id} = ${parseInt(e)};
`:`uniform ${t} int ${this.id};
`}updateValue(e){this.origin!=="constants"&&this.kernel.setUniform1i(this.id,this.uploadValue=e)}};Ka.exports={WebGL2KernelValueInteger:Va}});var xn=p((zm,Ga)=>{var{utils:yh}=d(),{WebGLKernelValueHTMLImage:Th}=_e(),Ua=class extends Th{getSource(){let e=this.getVariablePrecisionString();return yh.linesToString([`uniform ${e} sampler2D ${this.id}`,`${e} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${e} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}};Ga.exports={WebGL2KernelValueHTMLImage:Ua}});var yn=p((Cm,qa)=>{var{utils:bh}=d(),{WebGLKernelValueDynamicHTMLImage:Sh}=Be(),Pa=class extends Sh{getSource(){let e=this.getVariablePrecisionString();return bh.linesToString([`uniform ${e} sampler2D ${this.id}`,`uniform ${e} ivec2 ${this.sizeId}`,`uniform ${e} ivec3 ${this.dimensionsId}`])}};qa.exports={WebGL2KernelValueDynamicHTMLImage:Pa}});var Tn=p((Mm,ja)=>{var{utils:Eh}=d(),{WebGLKernelArray:_h}=N(),Ba=class extends _h{constructor(e,t){super(e,t);this.checkSize(e[0].width,e[0].height),this.dimensions=[e[0].width,e[0].height,e.length],this.textureSize=[e[0].width,e[0].height]}defineTexture(){let{context:e}=this;e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D_ARRAY,this.texture),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.NEAREST)}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName};
`}getSource(){let e=this.getVariablePrecisionString();return Eh.linesToString([`uniform ${e} sampler2DArray ${this.id}`,`${e} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${e} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){let{context:t}=this;t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D_ARRAY,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texImage3D(t.TEXTURE_2D_ARRAY,0,t.RGBA,e[0].width,e[0].height,e.length,0,t.RGBA,t.UNSIGNED_BYTE,null);for(let n=0;n<e.length;n++){let r=0,s=0,a=1;t.texSubImage3D(t.TEXTURE_2D_ARRAY,0,r,s,n,e[n].width,e[n].height,a,t.RGBA,t.UNSIGNED_BYTE,this.uploadValue=e[n])}this.kernel.setUniform1i(this.id,this.index)}};ja.exports={WebGL2KernelValueHTMLImageArray:Ba}});var Ha=p((Lm,Xa)=>{var{utils:wh}=d(),{WebGL2KernelValueHTMLImageArray:vh}=Tn(),Wa=class extends vh{getSource(){let e=this.getVariablePrecisionString();return wh.linesToString([`uniform ${e} sampler2DArray ${this.id}`,`uniform ${e} ivec2 ${this.sizeId}`,`uniform ${e} ivec3 ${this.dimensionsId}`])}updateValue(e){let{width:t,height:n}=e[0];this.checkSize(t,n),this.dimensions=[t,n,e.length],this.textureSize=[t,n],this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};Xa.exports={WebGL2KernelValueDynamicHTMLImageArray:Wa}});var Ja=p((Om,Za)=>{var{utils:km}=d(),{WebGL2KernelValueHTMLImage:$h}=xn(),Ya=class extends $h{};Za.exports={WebGL2KernelValueHTMLVideo:Ya}});var to=p((Km,eo)=>{var{utils:Vm}=d(),{WebGL2KernelValueDynamicHTMLImage:Dh}=yn(),Qa=class extends Dh{};eo.exports={WebGL2KernelValueDynamicHTMLVideo:Qa}});var bn=p((Nm,io)=>{var{utils:no}=d(),{WebGLKernelValueSingleInput:Ih}=We(),ro=class extends Ih{getSource(){let e=this.getVariablePrecisionString();return no.linesToString([`uniform ${e} sampler2D ${this.id}`,`${e} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${e} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){let{context:t}=this;no.flattenTo(e.value,this.uploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};io.exports={WebGL2KernelValueSingleInput:ro}});var uo=p((Um,oo)=>{var{utils:so}=d(),{WebGL2KernelValueSingleInput:Ah}=bn(),ao=class extends Ah{getSource(){let e=this.getVariablePrecisionString();return so.linesToString([`uniform ${e} sampler2D ${this.id}`,`uniform ${e} ivec2 ${this.sizeId}`,`uniform ${e} ivec3 ${this.dimensionsId}`])}updateValue(e){let[t,n,r]=e.size;this.dimensions=new Int32Array([t||1,n||1,r||1]),this.textureSize=so.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0],this.textureSize[1]),this.uploadValue=new Float32Array(this.uploadArrayLength),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};oo.exports={WebGL2KernelValueDynamicSingleInput:ao}});var ho=p((Gm,co)=>{var{utils:Rh}=d(),{WebGLKernelValueUnsignedInput:Fh}=He(),lo=class extends Fh{getSource(){let e=this.getVariablePrecisionString();return Rh.linesToString([`uniform ${e} sampler2D ${this.id}`,`${e} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${e} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}};co.exports={WebGL2KernelValueUnsignedInput:lo}});var mo=p((Pm,fo)=>{var{utils:zh}=d(),{WebGLKernelValueDynamicUnsignedInput:Ch}=Ht(),po=class extends Ch{getSource(){let e=this.getVariablePrecisionString();return zh.linesToString([`uniform ${e} sampler2D ${this.id}`,`uniform ${e} ivec2 ${this.sizeId}`,`uniform ${e} ivec3 ${this.dimensionsId}`])}};fo.exports={WebGL2KernelValueDynamicUnsignedInput:po}});var yo=p((qm,xo)=>{var{utils:Mh}=d(),{WebGLKernelValueMemoryOptimizedNumberTexture:Lh}=we(),go=class extends Lh{getSource(){let{id:e,sizeId:t,textureSize:n,dimensionsId:r,dimensions:s}=this,a=this.getVariablePrecisionString();return Mh.linesToString([`uniform sampler2D ${e}`,`${a} ivec2 ${t} = ivec2(${n[0]}, ${n[1]})`,`${a} ivec3 ${r} = ivec3(${s[0]}, ${s[1]}, ${s[2]})`])}};xo.exports={WebGL2KernelValueMemoryOptimizedNumberTexture:go}});var So=p((Bm,bo)=>{var{utils:kh}=d(),{WebGLKernelValueDynamicMemoryOptimizedNumberTexture:Oh}=Zt(),To=class extends Oh{getSource(){return kh.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}};bo.exports={WebGL2KernelValueDynamicMemoryOptimizedNumberTexture:To}});var wo=p((jm,_o)=>{var{utils:Vh}=d(),{WebGLKernelValueNumberTexture:Kh}=Ye(),Eo=class extends Kh{getSource(){let{id:e,sizeId:t,textureSize:n,dimensionsId:r,dimensions:s}=this,a=this.getVariablePrecisionString();return Vh.linesToString([`uniform ${a} sampler2D ${e}`,`${a} ivec2 ${t} = ivec2(${n[0]}, ${n[1]})`,`${a} ivec3 ${r} = ivec3(${s[0]}, ${s[1]}, ${s[2]})`])}};_o.exports={WebGL2KernelValueNumberTexture:Eo}});var Do=p((Wm,$o)=>{var{utils:Nh}=d(),{WebGLKernelValueDynamicNumberTexture:Uh}=Jt(),vo=class extends Uh{getSource(){let e=this.getVariablePrecisionString();return Nh.linesToString([`uniform ${e} sampler2D ${this.id}`,`uniform ${e} ivec2 ${this.sizeId}`,`uniform ${e} ivec3 ${this.dimensionsId}`])}};$o.exports={WebGL2KernelValueDynamicNumberTexture:vo}});var Sn=p((Xm,Ro)=>{var{utils:Io}=d(),{WebGLKernelValueSingleArray:Gh}=Ze(),Ao=class extends Gh{getSource(){let e=this.getVariablePrecisionString();return Io.linesToString([`uniform ${e} sampler2D ${this.id}`,`${e} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${e} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}let{context:t}=this;Io.flattenTo(e,this.uploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};Ro.exports={WebGL2KernelValueSingleArray:Ao}});var Co=p((Hm,zo)=>{var{utils:En}=d(),{WebGL2KernelValueSingleArray:Ph}=Sn(),Fo=class extends Ph{getSource(){let e=this.getVariablePrecisionString();return En.linesToString([`uniform ${e} sampler2D ${this.id}`,`uniform ${e} ivec2 ${this.sizeId}`,`uniform ${e} ivec3 ${this.dimensionsId}`])}updateValue(e){this.dimensions=En.getDimensions(e,!0),this.textureSize=En.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0],this.textureSize[1]),this.uploadValue=new Float32Array(this.uploadArrayLength),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};zo.exports={WebGL2KernelValueDynamicSingleArray:Fo}});var _n=p((Ym,Lo)=>{var{utils:qh}=d(),{WebGLKernelValueSingleArray1DI:Bh}=Je(),Mo=class extends Bh{updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}let{context:t}=this;qh.flattenTo(e,this.uploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};Lo.exports={WebGL2KernelValueSingleArray1DI:Mo}});var Vo=p((Zm,Oo)=>{var{utils:jh}=d(),{WebGL2KernelValueSingleArray1DI:Wh}=_n(),ko=class extends Wh{getSource(){let e=this.getVariablePrecisionString();return jh.linesToString([`uniform ${e} sampler2D ${this.id}`,`uniform ${e} ivec2 ${this.sizeId}`,`uniform ${e} ivec3 ${this.dimensionsId}`])}updateValue(e){this.setShape(e),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};Oo.exports={WebGL2KernelValueDynamicSingleArray1DI:ko}});var wn=p((Jm,No)=>{var{utils:Xh}=d(),{WebGLKernelValueSingleArray2DI:Hh}=Qe(),Ko=class extends Hh{updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}let{context:t}=this;Xh.flattenTo(e,this.uploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};No.exports={WebGL2KernelValueSingleArray2DI:Ko}});var Po=p((Qm,Go)=>{var{utils:Yh}=d(),{WebGL2KernelValueSingleArray2DI:Zh}=wn(),Uo=class extends Zh{getSource(){let e=this.getVariablePrecisionString();return Yh.linesToString([`uniform ${e} sampler2D ${this.id}`,`uniform ${e} ivec2 ${this.sizeId}`,`uniform ${e} ivec3 ${this.dimensionsId}`])}updateValue(e){this.setShape(e),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};Go.exports={WebGL2KernelValueDynamicSingleArray2DI:Uo}});var vn=p((ed,Bo)=>{var{utils:Jh}=d(),{WebGLKernelValueSingleArray3DI:Qh}=et(),qo=class extends Qh{updateValue(e){if(e.constructor!==this.initialValueConstructor){this.onUpdateValueMismatch(e.constructor);return}let{context:t}=this;Jh.flattenTo(e,this.uploadValue),t.activeTexture(this.contextHandle),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,this.textureSize[0],this.textureSize[1],0,t.RGBA,t.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}};Bo.exports={WebGL2KernelValueSingleArray3DI:qo}});var Xo=p((td,Wo)=>{var{utils:ep}=d(),{WebGL2KernelValueSingleArray3DI:tp}=vn(),jo=class extends tp{getSource(){let e=this.getVariablePrecisionString();return ep.linesToString([`uniform ${e} sampler2D ${this.id}`,`uniform ${e} ivec2 ${this.sizeId}`,`uniform ${e} ivec3 ${this.dimensionsId}`])}updateValue(e){this.setShape(e),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(e)}};Wo.exports={WebGL2KernelValueDynamicSingleArray3DI:jo}});var Zo=p((nd,Yo)=>{var{WebGLKernelValueSingleArray2:np}=en(),Ho=class extends np{};Yo.exports={WebGL2KernelValueSingleArray2:Ho}});var eu=p((rd,Qo)=>{var{WebGLKernelValueSingleArray3:rp}=tn(),Jo=class extends rp{};Qo.exports={WebGL2KernelValueSingleArray3:Jo}});var ru=p((id,nu)=>{var{WebGLKernelValueSingleArray4:ip}=nn(),tu=class extends ip{};nu.exports={WebGL2KernelValueSingleArray4:tu}});var au=p((sd,su)=>{var{utils:sp}=d(),{WebGLKernelValueUnsignedArray:ap}=tt(),iu=class extends ap{getSource(){let e=this.getVariablePrecisionString();return sp.linesToString([`uniform ${e} sampler2D ${this.id}`,`${e} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${e} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}};su.exports={WebGL2KernelValueUnsignedArray:iu}});var lu=p((ad,uu)=>{var{utils:op}=d(),{WebGLKernelValueDynamicUnsignedArray:up}=sn(),ou=class extends up{getSource(){let e=this.getVariablePrecisionString();return op.linesToString([`uniform ${e} sampler2D ${this.id}`,`uniform ${e} ivec2 ${this.sizeId}`,`uniform ${e} ivec3 ${this.dimensionsId}`])}};uu.exports={WebGL2KernelValueDynamicUnsignedArray:ou}});var Cn=p((od,yu)=>{var{WebGL2KernelValueBoolean:ct}=Ma(),{WebGL2KernelValueFloat:ht}=Oa(),{WebGL2KernelValueInteger:pt}=Na(),{WebGL2KernelValueHTMLImage:ft}=xn(),{WebGL2KernelValueDynamicHTMLImage:mt}=yn(),{WebGL2KernelValueHTMLImageArray:cu}=Tn(),{WebGL2KernelValueDynamicHTMLImageArray:hu}=Ha(),{WebGL2KernelValueHTMLVideo:pu}=Ja(),{WebGL2KernelValueDynamicHTMLVideo:fu}=to(),{WebGL2KernelValueSingleInput:lp}=bn(),{WebGL2KernelValueDynamicSingleInput:cp}=uo(),{WebGL2KernelValueUnsignedInput:hp}=ho(),{WebGL2KernelValueDynamicUnsignedInput:pp}=mo(),{WebGL2KernelValueMemoryOptimizedNumberTexture:fp}=yo(),{WebGL2KernelValueDynamicMemoryOptimizedNumberTexture:$n}=So(),{WebGL2KernelValueNumberTexture:H}=wo(),{WebGL2KernelValueDynamicNumberTexture:Y}=Do(),{WebGL2KernelValueSingleArray:mp}=Sn(),{WebGL2KernelValueDynamicSingleArray:dp}=Co(),{WebGL2KernelValueSingleArray1DI:Dn}=_n(),{WebGL2KernelValueDynamicSingleArray1DI:In}=Vo(),{WebGL2KernelValueSingleArray2DI:An}=wn(),{WebGL2KernelValueDynamicSingleArray2DI:Rn}=Po(),{WebGL2KernelValueSingleArray3DI:Fn}=vn(),{WebGL2KernelValueDynamicSingleArray3DI:zn}=Xo(),{WebGL2KernelValueSingleArray2:mu}=Zo(),{WebGL2KernelValueSingleArray3:du}=eu(),{WebGL2KernelValueSingleArray4:gu}=ru(),{WebGL2KernelValueUnsignedArray:gp}=au(),{WebGL2KernelValueDynamicUnsignedArray:xp}=lu(),xu={unsigned:{dynamic:{Boolean:ct,Integer:pt,Float:ht,Array:xp,"Array(2)":!1,"Array(3)":!1,"Array(4)":!1,"Array1D(2)":!1,"Array1D(3)":!1,"Array1D(4)":!1,"Array2D(2)":!1,"Array2D(3)":!1,"Array2D(4)":!1,"Array3D(2)":!1,"Array3D(3)":!1,"Array3D(4)":!1,Input:pp,NumberTexture:Y,"ArrayTexture(1)":Y,"ArrayTexture(2)":Y,"ArrayTexture(3)":Y,"ArrayTexture(4)":Y,MemoryOptimizedNumberTexture:$n,HTMLCanvas:mt,HTMLImage:mt,HTMLImageArray:hu,HTMLVideo:fu},static:{Boolean:ct,Float:ht,Integer:pt,Array:gp,"Array(2)":!1,"Array(3)":!1,"Array(4)":!1,"Array1D(2)":!1,"Array1D(3)":!1,"Array1D(4)":!1,"Array2D(2)":!1,"Array2D(3)":!1,"Array2D(4)":!1,"Array3D(2)":!1,"Array3D(3)":!1,"Array3D(4)":!1,Input:hp,NumberTexture:H,"ArrayTexture(1)":H,"ArrayTexture(2)":H,"ArrayTexture(3)":H,"ArrayTexture(4)":H,MemoryOptimizedNumberTexture:$n,HTMLCanvas:ft,HTMLImage:ft,HTMLImageArray:cu,HTMLVideo:pu}},single:{dynamic:{Boolean:ct,Integer:pt,Float:ht,Array:dp,"Array(2)":mu,"Array(3)":du,"Array(4)":gu,"Array1D(2)":In,"Array1D(3)":In,"Array1D(4)":In,"Array2D(2)":Rn,"Array2D(3)":Rn,"Array2D(4)":Rn,"Array3D(2)":zn,"Array3D(3)":zn,"Array3D(4)":zn,Input:cp,NumberTexture:Y,"ArrayTexture(1)":Y,"ArrayTexture(2)":Y,"ArrayTexture(3)":Y,"ArrayTexture(4)":Y,MemoryOptimizedNumberTexture:$n,HTMLCanvas:mt,HTMLImage:mt,HTMLImageArray:hu,HTMLVideo:fu},static:{Boolean:ct,Float:ht,Integer:pt,Array:mp,"Array(2)":mu,"Array(3)":du,"Array(4)":gu,"Array1D(2)":Dn,"Array1D(3)":Dn,"Array1D(4)":Dn,"Array2D(2)":An,"Array2D(3)":An,"Array2D(4)":An,"Array3D(2)":Fn,"Array3D(3)":Fn,"Array3D(4)":Fn,Input:lp,NumberTexture:H,"ArrayTexture(1)":H,"ArrayTexture(2)":H,"ArrayTexture(3)":H,"ArrayTexture(4)":H,MemoryOptimizedNumberTexture:fp,HTMLCanvas:ft,HTMLImage:ft,HTMLImageArray:cu,HTMLVideo:pu}}};function yp(i,e,t,n){if(!i)throw new Error("type missing");if(!e)throw new Error("dynamic missing");if(!t)throw new Error("precision missing");n.type&&(i=n.type);let r=xu[t][e];if(r[i]===!1)return null;if(r[i]===void 0)throw new Error(`Could not find a KernelValue for ${i}`);return r[i]}yu.exports={kernelValueMaps:xu,lookupKernelValueType:yp}});var Mn=p((ud,_u)=>{var{WebGLKernel:Tp}=ze(),{WebGL2FunctionNode:Tu}=gn(),{FunctionBuilder:bu}=be(),{utils:ee}=d(),{fragmentShader:bp}=Aa(),{vertexShader:Sp}=Fa(),{lookupKernelValueType:Ep}=Cn(),dt=null,Ce=null,B=null,_p=null,Su=null,Eu=class extends Tp{static get isSupported(){return dt!==null||(this.setupFeatureChecks(),dt=this.isContextMatch(B)),dt}static setupFeatureChecks(){typeof document!="undefined"?Ce=document.createElement("canvas"):typeof OffscreenCanvas!="undefined"&&(Ce=new OffscreenCanvas(0,0)),!!Ce&&(B=Ce.getContext("webgl2"),!(!B||!B.getExtension)&&(_p={EXT_color_buffer_float:B.getExtension("EXT_color_buffer_float"),OES_texture_float_linear:B.getExtension("OES_texture_float_linear")},Su=this.getFeatures()))}static isContextMatch(e){return typeof WebGL2RenderingContext!="undefined"?e instanceof WebGL2RenderingContext:!1}static getFeatures(){let e=this.testContext;return Object.freeze({isFloatRead:this.getIsFloatRead(),isIntegerDivisionAccurate:this.getIsIntegerDivisionAccurate(),isSpeedTacticSupported:this.getIsSpeedTacticSupported(),kernelMap:!0,isTextureFloat:!0,isDrawBuffers:!0,channelCount:this.getChannelCount(),maxTextureSize:this.getMaxTextureSize(),lowIntPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.LOW_INT),lowFloatPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.LOW_FLOAT),mediumIntPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_INT),mediumFloatPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT),highIntPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_INT),highFloatPrecision:e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT)})}static getIsTextureFloat(){return!0}static getChannelCount(){return B.getParameter(B.MAX_DRAW_BUFFERS)}static getMaxTextureSize(){return B.getParameter(B.MAX_TEXTURE_SIZE)}static lookupKernelValueType(e,t,n,r){return Ep(e,t,n,r)}static get testCanvas(){return Ce}static get testContext(){return B}static get features(){return Su}static get fragmentShader(){return bp}static get vertexShader(){return Sp}initContext(){let e={alpha:!1,depth:!1,antialias:!1};return this.canvas.getContext("webgl2",e)}initExtensions(){this.extensions={EXT_color_buffer_float:this.context.getExtension("EXT_color_buffer_float"),OES_texture_float_linear:this.context.getExtension("OES_texture_float_linear")}}validateSettings(e){if(!this.validate){this.texSize=ee.getKernelTextureSize({optimizeFloatMemory:this.optimizeFloatMemory,precision:this.precision},this.output);return}let{features:t}=this.constructor;if(this.precision==="single"&&!t.isFloatRead)throw new Error("Float texture outputs are not supported");if(!this.graphical&&this.precision===null&&(this.precision=t.isFloatRead?"single":"unsigned"),this.fixIntegerDivisionAccuracy===null?this.fixIntegerDivisionAccuracy=!t.isIntegerDivisionAccurate:this.fixIntegerDivisionAccuracy&&t.isIntegerDivisionAccurate&&(this.fixIntegerDivisionAccuracy=!1),this.checkOutput(),!this.output||this.output.length===0){if(e.length!==1)throw new Error("Auto output only supported for kernels with only one input");let n=ee.getVariableType(e[0],this.strictIntegers);switch(n){case"Array":this.output=ee.getDimensions(n);break;case"NumberTexture":case"MemoryOptimizedNumberTexture":case"ArrayTexture(1)":case"ArrayTexture(2)":case"ArrayTexture(3)":case"ArrayTexture(4)":this.output=e[0].output;break;default:throw new Error("Auto output not supported for input type: "+n)}}if(this.graphical){if(this.output.length!==2)throw new Error("Output must have 2 dimensions on graphical mode");this.precision==="single"&&(console.warn("Cannot use graphical mode and single precision at the same time"),this.precision="unsigned"),this.texSize=ee.clone(this.output);return}else!this.graphical&&this.precision===null&&t.isTextureFloat&&(this.precision="single");this.texSize=ee.getKernelTextureSize({optimizeFloatMemory:this.optimizeFloatMemory,precision:this.precision},this.output),this.checkTextureSize()}translateSource(){let e=bu.fromKernel(this,Tu,{fixIntegerDivisionAccuracy:this.fixIntegerDivisionAccuracy});this.translatedSource=e.getPrototypeString("kernel"),this.setupReturnTypes(e)}drawBuffers(){this.context.drawBuffers(this.drawBuffersMap)}getTextureFormat(){let{context:e}=this;switch(this.getInternalFormat()){case e.R32F:return e.RED;case e.RG32F:return e.RG;case e.RGBA32F:return e.RGBA;case e.RGBA:return e.RGBA;default:throw new Error("Unknown internal format")}}getInternalFormat(){let{context:e}=this;if(this.precision==="single"){if(this.pipeline)switch(this.returnType){case"Number":case"Float":case"Integer":return this.optimizeFloatMemory?e.RGBA32F:e.R32F;case"Array(2)":return e.RG32F;case"Array(3)":case"Array(4)":return e.RGBA32F;default:throw new Error("Unhandled return type")}return e.RGBA32F}return e.RGBA}_setupOutputTexture(){let e=this.context;if(this.texture){e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture.texture,0);return}e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);let t=e.createTexture(),n=this.texSize;e.activeTexture(e.TEXTURE0+this.constantTextureCount+this.argumentTextureCount),e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);let r=this.getInternalFormat();this.precision==="single"?e.texStorage2D(e.TEXTURE_2D,1,r,n[0],n[1]):e.texImage2D(e.TEXTURE_2D,0,r,n[0],n[1],0,r,e.UNSIGNED_BYTE,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),this.texture=new this.TextureConstructor({texture:t,size:n,dimensions:this.threadDim,output:this.output,context:this.context,internalFormat:this.getInternalFormat(),textureFormat:this.getTextureFormat(),kernel:this})}_setupSubOutputTextures(){let e=this.context;if(this.mappedTextures){for(let n=0;n<this.subKernels.length;n++)e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n+1,e.TEXTURE_2D,this.mappedTextures[n].texture,0);return}let t=this.texSize;this.drawBuffersMap=[e.COLOR_ATTACHMENT0],this.mappedTextures=[];for(let n=0;n<this.subKernels.length;n++){let r=this.createTexture();this.drawBuffersMap.push(e.COLOR_ATTACHMENT0+n+1),e.activeTexture(e.TEXTURE0+this.constantTextureCount+this.argumentTextureCount+n),e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);let s=this.getInternalFormat();this.precision==="single"?e.texStorage2D(e.TEXTURE_2D,1,s,t[0],t[1]):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t[0],t[1],0,e.RGBA,e.UNSIGNED_BYTE,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n+1,e.TEXTURE_2D,r,0),this.mappedTextures.push(new this.TextureConstructor({texture:r,size:t,dimensions:this.threadDim,output:this.output,context:this.context,internalFormat:this.getInternalFormat(),textureFormat:this.getTextureFormat(),kernel:this}))}}_getHeaderString(){return""}_getTextureCoordinate(){let e=this.subKernels,t=this.getVariablePrecisionString(this.texSize,this.tactic);return e===null||e.length<1?`in ${t} vec2 vTexCoord;
`:`out ${t} vec2 vTexCoord;
`}_getMainArgumentsString(e){let t=[],n=this.argumentNames;for(let r=0;r<n.length;r++)t.push(this.kernelArguments[r].getSource(e[r]));return t.join("")}getKernelString(){let e=[this.getKernelResultDeclaration()],t=this.subKernels;if(t!==null)switch(e.push("layout(location = 0) out vec4 data0"),this.returnType){case"Number":case"Float":case"Integer":for(let n=0;n<t.length;n++){let r=t[n];e.push(r.returnType==="Integer"?`int subKernelResult_${r.name} = 0`:`float subKernelResult_${r.name} = 0.0`,`layout(location = ${n+1}) out vec4 data${n+1}`)}break;case"Array(2)":for(let n=0;n<t.length;n++)e.push(`vec2 subKernelResult_${t[n].name}`,`layout(location = ${n+1}) out vec4 data${n+1}`);break;case"Array(3)":for(let n=0;n<t.length;n++)e.push(`vec3 subKernelResult_${t[n].name}`,`layout(location = ${n+1}) out vec4 data${n+1}`);break;case"Array(4)":for(let n=0;n<t.length;n++)e.push(`vec4 subKernelResult_${t[n].name}`,`layout(location = ${n+1}) out vec4 data${n+1}`);break}else e.push("out vec4 data0");return ee.linesToString(e)+this.translatedSource}getMainResultGraphical(){return ee.linesToString(["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  data0 = actualColor"])}getMainResultPackedPixels(){switch(this.returnType){case"LiteralInteger":case"Number":case"Integer":case"Float":return this.getMainResultKernelPackedPixels()+this.getMainResultSubKernelPackedPixels();default:throw new Error(`packed output only usable with Numbers, "${this.returnType}" specified`)}}getMainResultKernelPackedPixels(){return ee.linesToString(["  threadId = indexTo3D(index, uOutputDim)","  kernel()",`  data0 = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(kernelResult)`])}getMainResultSubKernelPackedPixels(){let e=[];if(!this.subKernels)return"";for(let t=0;t<this.subKernels.length;t++)this.subKernels[t].returnType==="Integer"?e.push(`  data${t+1} = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(float(subKernelResult_${this.subKernels[t].name}))`):e.push(`  data${t+1} = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(subKernelResult_${this.subKernels[t].name})`);return ee.linesToString(e)}getMainResultKernelMemoryOptimizedFloats(e,t){e.push("  threadId = indexTo3D(index, uOutputDim)","  kernel()",`  data0.${t} = kernelResult`)}getMainResultSubKernelMemoryOptimizedFloats(e,t){if(!this.subKernels)return e;for(let n=0;n<this.subKernels.length;n++){let r=this.subKernels[n];r.returnType==="Integer"?e.push(`  data${n+1}.${t} = float(subKernelResult_${r.name})`):e.push(`  data${n+1}.${t} = subKernelResult_${r.name}`)}}getMainResultKernelNumberTexture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  data0[0] = kernelResult"]}getMainResultSubKernelNumberTexture(){let e=[];if(!this.subKernels)return e;for(let t=0;t<this.subKernels.length;++t){let n=this.subKernels[t];n.returnType==="Integer"?e.push(`  data${t+1}[0] = float(subKernelResult_${n.name})`):e.push(`  data${t+1}[0] = subKernelResult_${n.name}`)}return e}getMainResultKernelArray2Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  data0[0] = kernelResult[0]","  data0[1] = kernelResult[1]"]}getMainResultSubKernelArray2Texture(){let e=[];if(!this.subKernels)return e;for(let t=0;t<this.subKernels.length;++t){let n=this.subKernels[t];e.push(`  data${t+1}[0] = subKernelResult_${n.name}[0]`,`  data${t+1}[1] = subKernelResult_${n.name}[1]`)}return e}getMainResultKernelArray3Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  data0[0] = kernelResult[0]","  data0[1] = kernelResult[1]","  data0[2] = kernelResult[2]"]}getMainResultSubKernelArray3Texture(){let e=[];if(!this.subKernels)return e;for(let t=0;t<this.subKernels.length;++t){let n=this.subKernels[t];e.push(`  data${t+1}[0] = subKernelResult_${n.name}[0]`,`  data${t+1}[1] = subKernelResult_${n.name}[1]`,`  data${t+1}[2] = subKernelResult_${n.name}[2]`)}return e}getMainResultKernelArray4Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  data0 = kernelResult"]}getMainResultSubKernelArray4Texture(){let e=[];if(!this.subKernels)return e;for(let t=0;t<this.subKernels.length;++t)e.push(`  data${t+1} = subKernelResult_${this.subKernels[t].name}`);return e}destroyExtensions(){this.extensions.EXT_color_buffer_float=null,this.extensions.OES_texture_float_linear=null}toJSON(){let e=super.toJSON();return e.functionNodes=bu.fromKernel(this,Tu).toJSON(),e.settings.threadDim=this.threadDim,e}};_u.exports={WebGL2Kernel:Eu}});var $u=p((ld,vu)=>{var{utils:wp}=d();function vp(i){let e=function(){return i.build.apply(i,arguments),e=function(){let n=i.run.apply(i,arguments);if(i.switchingKernels){let r=i.resetSwitchingKernels(),s=i.onRequestSwitchKernel(r,arguments,i);t.kernel=i=s,n=s.run.apply(s,arguments)}return i.renderKernels?i.renderKernels():i.renderOutput?i.renderOutput():n},e.apply(i,arguments)},t=function(){return e.apply(i,arguments)};return t.exec=function(){return new Promise((n,r)=>{try{n(e.apply(this,arguments))}catch(s){r(s)}})},t.replaceKernel=function(n){i=n,wu(i,t)},wu(i,t),t}function wu(i,e){if(e.kernel){e.kernel=i;return}let t=wp.allPropertiesOf(i);for(let n=0;n<t.length;n++){let r=t[n];r[0]==="_"&&r[1]==="_"||(typeof i[r]=="function"?r.substring(0,3)==="add"||r.substring(0,3)==="set"?e[r]=function(){return e.kernel[r].apply(e.kernel,arguments),e}:e[r]=function(){return e.kernel[r].apply(e.kernel,arguments)}:(e.__defineGetter__(r,()=>e.kernel[r]),e.__defineSetter__(r,s=>{e.kernel[r]=s})))}e.kernel=i}vu.exports={kernelRunShortcut:vp}});var Ru=p((hd,Au)=>{var{gpuMock:$p}=Pn(),{utils:ae}=d(),{Kernel:cd}=ye(),{CPUKernel:Ln}=$t(),{HeadlessGLKernel:kn}=dn(),{WebGL2Kernel:gt}=Mn(),{WebGLKernel:On}=ze(),{kernelRunShortcut:Dp}=$u(),G=[kn,gt,On],Du=["gpu","cpu"],Vn={headlessgl:kn,webgl2:gt,webgl:On},Me=!0,Iu=class{static disableValidation(){Me=!1}static enableValidation(){Me=!0}static get isGPUSupported(){return G.some(e=>e.isSupported)}static get isKernelMapSupported(){return G.some(e=>e.isSupported&&e.features.kernelMap)}static get isOffscreenCanvasSupported(){return typeof Worker!="undefined"&&typeof OffscreenCanvas!="undefined"||typeof importScripts!="undefined"}static get isWebGLSupported(){return On.isSupported}static get isWebGL2Supported(){return gt.isSupported}static get isHeadlessGLSupported(){return kn.isSupported}static get isCanvasSupported(){return typeof HTMLCanvasElement!="undefined"}static get isGPUHTMLImageArraySupported(){return gt.isSupported}static get isSinglePrecisionSupported(){return G.some(e=>e.isSupported&&e.features.isFloatRead&&e.features.isTextureFloat)}constructor(e){if(e=e||{},this.canvas=e.canvas||null,this.context=e.context||null,this.mode=e.mode,this.Kernel=null,this.kernels=[],this.functions=[],this.nativeFunctions=[],this.injectedNative=null,this.mode!=="dev"){if(this.chooseKernel(),e.functions)for(let t=0;t<e.functions.length;t++)this.addFunction(e.functions[t]);if(e.nativeFunctions)for(let t in e.nativeFunctions){if(!e.nativeFunctions.hasOwnProperty(t))continue;let n=e.nativeFunctions[t],{name:r,source:s}=n;this.addNativeFunction(r,s,n)}}}chooseKernel(){if(this.Kernel)return;let e=null;if(this.context){for(let t=0;t<G.length;t++){let n=G[t];if(n.isContextMatch(this.context)){if(!n.isSupported)throw new Error(`Kernel type ${n.name} not supported`);e=n;break}}if(e===null)throw new Error("unknown Context")}else if(this.mode){if(this.mode in Vn)(!Me||Vn[this.mode].isSupported)&&(e=Vn[this.mode]);else if(this.mode==="gpu"){for(let t=0;t<G.length;t++)if(G[t].isSupported){e=G[t];break}}else this.mode==="cpu"&&(e=Ln);if(!e)throw new Error(`A requested mode of "${this.mode}" and is not supported`)}else{for(let t=0;t<G.length;t++)if(G[t].isSupported){e=G[t];break}e||(e=Ln)}this.mode||(this.mode=e.mode),this.Kernel=e}createKernel(e,t){if(typeof e=="undefined")throw new Error("Missing source parameter");if(typeof e!="object"&&!ae.isFunction(e)&&typeof e!="string")throw new Error("source parameter not a function");let n=this.kernels;if(this.mode==="dev"){let c=$p(e,Kn(t));return n.push(c),c}e=typeof e=="function"?e.toString():e;let r={},s=Kn(t)||{};t&&typeof t.argumentTypes=="object"&&(s.argumentTypes=Object.keys(t.argumentTypes).map(c=>t.argumentTypes[c]));function a(c){console.warn("Falling back to CPU");let m=new Ln(e,{argumentTypes:h.argumentTypes,constantTypes:h.constantTypes,graphical:h.graphical,loopMaxIterations:h.loopMaxIterations,constants:h.constants,dynamicOutput:h.dynamicOutput,dynamicArgument:h.dynamicArguments,output:h.output,precision:h.precision,pipeline:h.pipeline,immutable:h.immutable,optimizeFloatMemory:h.optimizeFloatMemory,fixIntegerDivisionAccuracy:h.fixIntegerDivisionAccuracy,functions:h.functions,nativeFunctions:h.nativeFunctions,injectedNative:h.injectedNative,subKernels:h.subKernels,strictIntegers:h.strictIntegers,debug:h.debug});m.build.apply(m,c);let f=m.run.apply(m,c);return h.replaceKernel(m),f}function o(c,m,f){f.debug&&console.warn("Switching kernels");let g=null;if(f.signature&&!r[f.signature]&&(r[f.signature]=f),f.dynamicOutput)for(let L=c.length-1;L>=0;L--){let te=c[L];te.type==="outputPrecisionMismatch"&&(g=te.needed)}let S=f.constructor,$=S.getArgumentTypes(f,m),w=S.getSignature(f,$),v=r[w];if(v)return v.onActivate(f),v;let K=r[w]=new S(e,{argumentTypes:$,constantTypes:f.constantTypes,graphical:f.graphical,loopMaxIterations:f.loopMaxIterations,constants:f.constants,dynamicOutput:f.dynamicOutput,dynamicArgument:f.dynamicArguments,context:f.context,canvas:f.canvas,output:g||f.output,precision:f.precision,pipeline:f.pipeline,immutable:f.immutable,optimizeFloatMemory:f.optimizeFloatMemory,fixIntegerDivisionAccuracy:f.fixIntegerDivisionAccuracy,functions:f.functions,nativeFunctions:f.nativeFunctions,injectedNative:f.injectedNative,subKernels:f.subKernels,strictIntegers:f.strictIntegers,debug:f.debug,gpu:f.gpu,validate:Me,returnType:f.returnType,tactic:f.tactic,onRequestFallback:a,onRequestSwitchKernel:o,texture:f.texture,mappedTextures:f.mappedTextures,drawBuffersMap:f.drawBuffersMap});return K.build.apply(K,m),h.replaceKernel(K),n.push(K),K}let l=Object.assign({context:this.context,canvas:this.canvas,functions:this.functions,nativeFunctions:this.nativeFunctions,injectedNative:this.injectedNative,gpu:this,validate:Me,onRequestFallback:a,onRequestSwitchKernel:o},s),u=new this.Kernel(e,l),h=Dp(u);return this.canvas||(this.canvas=u.canvas),this.context||(this.context=u.context),n.push(u),h}createKernelMap(){let e,t,n=typeof arguments[arguments.length-2];if(n==="function"||n==="string"?(e=arguments[arguments.length-2],t=arguments[arguments.length-1]):e=arguments[arguments.length-1],this.mode!=="dev"&&(!this.Kernel.isSupported||!this.Kernel.features.kernelMap)&&this.mode&&Du.indexOf(this.mode)<0)throw new Error(`kernelMap not supported on ${this.Kernel.name}`);let r=Kn(t);if(t&&typeof t.argumentTypes=="object"&&(r.argumentTypes=Object.keys(t.argumentTypes).map(s=>t.argumentTypes[s])),Array.isArray(arguments[0])){r.subKernels=[];let s=arguments[0];for(let a=0;a<s.length;a++){let o=s[a].toString(),l=ae.getFunctionNameFromString(o);r.subKernels.push({name:l,source:o,property:a})}}else{r.subKernels=[];let s=arguments[0];for(let a in s){if(!s.hasOwnProperty(a))continue;let o=s[a].toString(),l=ae.getFunctionNameFromString(o);r.subKernels.push({name:l||a,source:o,property:a})}}return this.createKernel(e,r)}combineKernels(){let e=arguments[0],t=arguments[arguments.length-1];if(e.kernel.constructor.mode==="cpu")return t;let n=arguments[0].canvas,r=arguments[0].context,s=arguments.length-1;for(let a=0;a<s;a++)arguments[a].setCanvas(n).setContext(r).setPipeline(!0);return function(){let a=t.apply(this,arguments);return a.toArray?a.toArray():a}}setFunctions(e){return this.functions=e,this}setNativeFunctions(e){return this.nativeFunctions=e,this}addFunction(e,t){return this.functions.push({source:e,settings:t}),this}addNativeFunction(e,t,n){if(this.kernels.length>0)throw new Error('Cannot call "addNativeFunction" after "createKernels" has been called.');return this.nativeFunctions.push(Object.assign({name:e,source:t},n)),this}injectNative(e){return this.injectedNative=e,this}destroy(){return new Promise((e,t)=>{this.kernels||e(),setTimeout(()=>{try{for(let r=0;r<this.kernels.length;r++)this.kernels[r].destroy(!0);let n=this.kernels[0];n&&(n.kernel&&(n=n.kernel),n.constructor.destroyContext&&n.constructor.destroyContext(this.context))}catch(n){t(n)}e()},0)})}};function Kn(i){if(!i)return{};let e=Object.assign({},i);return i.hasOwnProperty("floatOutput")&&(ae.warnDeprecated("setting","floatOutput","precision"),e.precision=i.floatOutput?"single":"unsigned"),i.hasOwnProperty("outputToTexture")&&(ae.warnDeprecated("setting","outputToTexture","pipeline"),e.pipeline=Boolean(i.outputToTexture)),i.hasOwnProperty("outputImmutable")&&(ae.warnDeprecated("setting","outputImmutable","immutable"),e.immutable=Boolean(i.outputImmutable)),i.hasOwnProperty("floatTextures")&&(ae.warnDeprecated("setting","floatTextures","optimizeFloatMemory"),e.optimizeFloatMemory=Boolean(i.floatTextures)),e}Au.exports={GPU:Iu,kernelOrder:G,kernelTypes:Du}});var Cu=p((pd,zu)=>{var{utils:Fu}=d();function Ip(i,e){let t=e.toString();return new Function(`return function ${i} (${Fu.getArgumentNamesFromString(t).join(", ")}) {
  ${Fu.getFunctionBodyFromString(t)}
}`)()}zu.exports={alias:Ip}});var Lu=p((fd,Mu)=>{var{GPU:Ap}=Ru(),{alias:Rp}=Cu(),{utils:Fp}=d(),{Input:zp,input:Cp}=xe(),{Texture:Mp}=Ve(),{FunctionBuilder:Lp}=be(),{FunctionNode:kp}=Ne(),{CPUFunctionNode:Op}=wt(),{CPUKernel:Vp}=$t(),{HeadlessGLKernel:Kp}=dn(),{WebGLFunctionNode:Np}=Ge(),{WebGLKernel:Up}=ze(),{kernelValueMaps:Gp}=pn(),{WebGL2FunctionNode:Pp}=gn(),{WebGL2Kernel:qp}=Mn(),{kernelValueMaps:Bp}=Cn(),{GLKernel:jp}=Ot(),{Kernel:Wp}=ye(),{FunctionTracer:Xp}=Et(),Hp=Kt();Mu.exports={alias:Rp,CPUFunctionNode:Op,CPUKernel:Vp,GPU:Ap,FunctionBuilder:Lp,FunctionNode:kp,HeadlessGLKernel:Kp,Input:zp,input:Cp,Texture:Mp,utils:Fp,WebGL2FunctionNode:Pp,WebGL2Kernel:qp,webGL2KernelValueMaps:Bp,WebGLFunctionNode:Np,WebGLKernel:Up,webGLKernelValueMaps:Gp,GLKernel:jp,Kernel:Wp,FunctionTracer:Xp,plugins:{mathRandom:Hp}}});var Yp=p((md,Vu)=>{var Le=Lu(),ku=Le.GPU;for(let i in Le)!Le.hasOwnProperty(i)||i!=="GPU"&&(ku[i]=Le[i]);typeof window!="undefined"&&Ou(window);typeof self!="undefined"&&Ou(self);function Ou(i){i.GPU||Object.defineProperty(i,"GPU",{get(){return ku}})}Vu.exports=Le});Yp();})();
